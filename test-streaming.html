<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMX Streaming Test</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #444;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #22c55e; }
        .error { background: #ef4444; }
        .warning { background: #f59e0b; }
        .info { background: #3b82f6; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #3730a3; }
        #log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª SMX Streaming System Test</h1>
    
    <div class="test-section">
        <h2>Connection Status</h2>
        <div id="connectionStatus" class="status info">Connecting...</div>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h2>WebSocket Events Test</h2>
        <button onclick="testStudentJoin()">Test Student Join</button>
        <button onclick="testStreamInit()">Test Stream Init</button>
        <button onclick="testStreamPlay()">Test Stream Play</button>
        <button onclick="testStreamPause()">Test Stream Pause</button>
        <button onclick="testStreamSeek()">Test Stream Seek</button>
        <button onclick="testViewerCount()">Test Viewer Count</button>
    </div>
    
    <div class="test-section">
        <h2>Stream URLs Test</h2>
        <input type="text" id="streamUrl" placeholder="Enter stream URL to test" style="width: 400px; padding: 8px; margin: 5px;">
        <button onclick="testStreamUrl()">Test Stream URL</button>
        <div id="streamUrlStatus" class="status info" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>API Endpoints Test</h2>
        <button onclick="testStreamStateAPI()">Test Stream State API</button>
        <button onclick="testUploadAPI()">Test Upload API</button>
        <div id="apiStatus" class="status info" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>Real-time Log</h2>
        <div id="log"></div>
    </div>

    <script>
        let socket = null;
        let testClassId = 'test-class-' + Date.now();
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : type === 'warning' ? '#ffaa44' : '#44aaff';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function updateConnectionStatus(status, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = status;
            statusDiv.className = `status ${type}`;
        }
        
        function initializeSocket() {
            if (typeof io === 'undefined') {
                log('âŒ Socket.IO not available', 'error');
                updateConnectionStatus('Socket.IO not available', 'error');
                return;
            }
            
            socket = io();
            
            socket.on('connect', () => {
                log('âœ… Connected to server with socket ID: ' + socket.id, 'success');
                updateConnectionStatus('Connected (ID: ' + socket.id + ')', 'success');
            });
            
            socket.on('disconnect', (reason) => {
                log('âŒ Disconnected: ' + reason, 'error');
                updateConnectionStatus('Disconnected: ' + reason, 'error');
            });
            
            socket.on('connect_error', (error) => {
                log('âŒ Connection error: ' + error.message, 'error');
                updateConnectionStatus('Connection error: ' + error.message, 'error');
            });
            
            // Listen for all events
            socket.onAny((eventName, ...args) => {
                log(`ðŸ“¨ Event: ${eventName} - ${JSON.stringify(args)}`, 'info');
            });
        }
        
        function testConnection() {
            if (!socket) {
                initializeSocket();
                return;
            }
            
            if (socket.connected) {
                log('âœ… Socket is connected', 'success');
                socket.emit('test-event', { message: 'Test from streaming test page', timestamp: Date.now() });
            } else {
                log('âŒ Socket is not connected', 'error');
                socket.connect();
            }
        }
        
        function testStudentJoin() {
            if (!socket || !socket.connected) {
                log('âŒ Socket not connected', 'error');
                return;
            }
            
            log(`ðŸŽ“ Testing student join for class: ${testClassId}`, 'info');
            socket.emit('student-join-class', { classId: testClassId });
        }
        
        function testStreamInit() {
            if (!socket || !socket.connected) {
                log('âŒ Socket not connected', 'error');
                return;
            }
            
            const testData = {
                classId: testClassId,
                streamUrl: '/uploads/test-video.mp4',
                currentTime: 0,
                playing: true,
                startTime: new Date().toISOString()
            };
            
            log('ðŸŽ¬ Testing stream init', 'info');
            socket.emit('stream:init', testData);
        }
        
        function testStreamPlay() {
            if (!socket || !socket.connected) {
                log('âŒ Socket not connected', 'error');
                return;
            }
            
            log('â–¶ï¸ Testing stream play', 'info');
            socket.emit('stream:play', { classId: testClassId, time: 10.5 });
        }
        
        function testStreamPause() {
            if (!socket || !socket.connected) {
                log('âŒ Socket not connected', 'error');
                return;
            }
            
            log('â¸ï¸ Testing stream pause', 'info');
            socket.emit('stream:pause', { classId: testClassId, time: 15.2 });
        }
        
        function testStreamSeek() {
            if (!socket || !socket.connected) {
                log('âŒ Socket not connected', 'error');
                return;
            }
            
            log('â­ï¸ Testing stream seek', 'info');
            socket.emit('stream:seek', { classId: testClassId, time: 30.0 });
        }
        
        function testViewerCount() {
            if (!socket || !socket.connected) {
                log('âŒ Socket not connected', 'error');
                return;
            }
            
            log('ðŸ‘¥ Testing viewer count request', 'info');
            socket.emit('get-viewer-count', { classId: testClassId });
        }
        
        function testStreamUrl() {
            const url = document.getElementById('streamUrl').value;
            const statusDiv = document.getElementById('streamUrlStatus');
            
            if (!url) {
                log('âŒ No URL provided', 'error');
                return;
            }
            
            log(`ðŸ”— Testing stream URL: ${url}`, 'info');
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'Testing URL...';
            statusDiv.className = 'status info';
            
            // Test if URL is accessible
            fetch(url, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        log(`âœ… URL accessible: ${response.status}`, 'success');
                        statusDiv.textContent = `âœ… URL accessible (${response.status})`;
                        statusDiv.className = 'status success';
                    } else {
                        log(`âŒ URL not accessible: ${response.status}`, 'error');
                        statusDiv.textContent = `âŒ URL not accessible (${response.status})`;
                        statusDiv.className = 'status error';
                    }
                })
                .catch(error => {
                    log(`âŒ URL test failed: ${error.message}`, 'error');
                    statusDiv.textContent = `âŒ URL test failed: ${error.message}`;
                    statusDiv.className = 'status error';
                });
        }
        
        async function testStreamStateAPI() {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'Testing Stream State API...';
            statusDiv.className = 'status info';
            
            try {
                log('ðŸ” Testing Stream State API', 'info');
                const response = await fetch(`/api/stream/state/${testClassId}`);
                const data = await response.json();
                
                if (response.ok) {
                    log(`âœ… Stream State API working: ${JSON.stringify(data)}`, 'success');
                    statusDiv.textContent = 'âœ… Stream State API working';
                    statusDiv.className = 'status success';
                } else {
                    log(`âŒ Stream State API error: ${data.message}`, 'error');
                    statusDiv.textContent = `âŒ API error: ${data.message}`;
                    statusDiv.className = 'status error';
                }
            } catch (error) {
                log(`âŒ Stream State API failed: ${error.message}`, 'error');
                statusDiv.textContent = `âŒ API failed: ${error.message}`;
                statusDiv.className = 'status error';
            }
        }
        
        async function testUploadAPI() {
            try {
                log('ðŸ“¤ Testing Upload API endpoint', 'info');
                const response = await fetch('/api/upload', { method: 'OPTIONS' });
                
                if (response.ok || response.status === 405) {
                    log('âœ… Upload API endpoint accessible', 'success');
                } else {
                    log(`âŒ Upload API not accessible: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Upload API test failed: ${error.message}`, 'error');
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('ðŸš€ SMX Streaming Test initialized', 'info');
            log(`ðŸ“‹ Test Class ID: ${testClassId}`, 'info');
            initializeSocket();
        });
    </script>
</body>
</html>