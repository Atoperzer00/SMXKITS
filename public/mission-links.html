<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SMX KITS - Mission Links</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      --secondary-gradient: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
      --accent-gradient: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
      --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
      --card-gradient: linear-gradient(145deg, #2d1810 0%, #1a0f08 100%);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: #b8c5d6;
      --text-accent: #ffa726;
      --shadow-primary: 0 20px 40px rgba(0, 0, 0, 0.3);
      --shadow-hover: 0 30px 60px rgba(0, 0, 0, 0.4);
      --border-radius: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark-gradient);
      color: var(--text-primary);
      overflow-x: hidden;
      line-height: 1.6;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(255, 107, 53, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(247, 147, 30, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 140, 66, 0.1) 0%, transparent 50%);
      z-index: -1;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-20px) rotate(1deg); }
      66% { transform: translateY(10px) rotate(-1deg); }
    }

    .admin-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar Redesign */
    .admin-sidebar {
      width: 280px;
      background: rgba(15, 20, 25, 0.95);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      padding: 2rem 0;
      position: relative;
      overflow: hidden;
    }

    .admin-sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, rgba(255, 107, 53, 0.1) 0%, transparent 100%);
      z-index: -1;
    }

    .admin-logo {
      width: 200px;
      margin: 0 auto 3rem;
      filter: drop-shadow(0 10px 30px rgba(255, 107, 53, 0.3));
      transition: var(--transition);
    }

    .admin-logo:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 15px 40px rgba(255, 107, 53, 0.5));
    }

    .admin-nav {
      list-style: none;
      padding: 0 1rem;
    }

    .admin-nav li {
      margin-bottom: 0.5rem;
      padding: 1rem 1.5rem;
      border-radius: 15px;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .admin-nav li::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--primary-gradient);
      transition: var(--transition);
      z-index: -1;
    }

    .admin-nav li:hover::before,
    .admin-nav li.active::before {
      left: 0;
    }

    .admin-nav li:hover,
    .admin-nav li.active {
      color: white;
      transform: translateX(5px);
      box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3);
    }

    /* Main Content Area */
    .admin-content {
      flex: 1;
      padding: 2rem;
      background: transparent;
      overflow-y: auto;
    }

    /* Header Section */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3rem;
      padding: 2rem;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-primary);
    }

    .dashboard-title {
      font-size: 3rem;
      font-weight: 800;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
      letter-spacing: -0.02em;
    }

    .section-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--text-accent);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 40px;
      background: var(--accent-gradient);
      border-radius: 2px;
    }

    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .tool-card {
      background: var(--card-gradient);
      border-radius: var(--border-radius);
      padding: 2rem;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-primary);
      cursor: pointer !important;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .tool-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-gradient);
      opacity: 0;
      transition: var(--transition);
      pointer-events: none;
    }

    .tool-card:hover::before {
      opacity: 0.1;
    }

    .tool-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: var(--shadow-hover);
      border-color: rgba(255, 107, 53, 0.5);
    }

    .tool-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tool-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .tool-description {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .fade-in {
      animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stagger-1 { animation-delay: 0.1s; }
    .stagger-2 { animation-delay: 0.2s; }
    .stagger-3 { animation-delay: 0.3s; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent-gradient);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-gradient);
    }

    /* File Submission System Styles */
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      transition: var(--transition);
    }

    .file-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--text-accent);
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }

    .file-icon {
      font-size: 1.5rem;
      color: var(--text-accent);
      width: 24px;
      text-align: center;
    }

    .file-details {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .file-size {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .file-remove {
      background: var(--glass-bg);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: var(--transition);
    }

    .file-remove:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    .student-dropdown {
      box-shadow: var(--shadow-primary);
    }

    .student-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid var(--glass-border);
    }

    .student-option:last-child {
      border-bottom: none;
    }

    .student-option:hover {
      background: var(--glass-bg);
    }

    .student-checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid var(--glass-border);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .student-checkbox.checked {
      background: var(--accent-gradient);
      border-color: var(--text-accent);
    }

    .student-checkbox.checked::after {
      content: 'âœ“';
      color: white;
      font-size: 0.8rem;
      font-weight: bold;
    }

    #fileSubmissionCard.dragover {
      border-color: var(--text-accent);
      background: rgba(255, 167, 38, 0.1);
      transform: scale(1.02);
    }

    /* Slideshow Viewer Styles */
    .slideshow-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      z-index: 99999;
      backdrop-filter: blur(10px);
    }

    .slideshow-modal.active {
      display: flex !important;
      align-items: center;
      justify-content: center;
    }

    .slideshow-container {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: #1a1a1a;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8);
      border: 1px solid #333;
    }

    .slideshow-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      z-index: 10001;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slideshow-close:hover {
      background: rgba(255, 107, 53, 0.8);
      transform: scale(1.1);
    }

    .slideshow-content {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }

    .slideshow-loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
      gap: 1rem;
    }

    .slideshow-loader i {
      font-size: 2rem;
      color: var(--text-accent);
    }

    #slideshowImage {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 10px;
      transition: opacity 0.3s ease;
    }

    .slide-counter {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .slideshow-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
    }

    .slideshow-btn {
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .slideshow-btn:hover {
      background: var(--primary-gradient);
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
    }

    .slideshow-btn:active {
      transform: scale(0.95);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .admin-layout {
        flex-direction: column;
      }
      
      .admin-sidebar {
        width: 100%;
        height: auto;
      }
      
      .admin-content {
        padding: 1rem;
      }
      
      .dashboard-title {
        font-size: 2rem;
      }
      
      .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      .tools-grid {
        grid-template-columns: 1fr;
      }

      .file-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .file-info {
        width: 100%;
      }

      .slideshow-container {
        max-width: 95vw;
        max-height: 95vh;
      }

      .slideshow-controls {
        bottom: 10px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .slideshow-btn {
        width: 45px;
        height: 45px;
        font-size: 1.3rem;
      }

      .slide-counter {
        font-size: 0.8rem;
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Check -->
  <script>
    // Check if user is authenticated
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    
    if (!token || !role) {
      // No authentication found, redirect to login
      window.location.replace('/login.html');
    }
  </script>

  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <img src="SMXKITS.png" alt="SMXKITS Logo" class="admin-logo" />
      <ul class="admin-nav">
        <li onclick="window.location.href='dashboard.html'"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
        <li class="active"><i class="fas fa-link"></i> Mission Links</li>
        <li onclick="window.location.href='keyboard-training.html'"><i class="fas fa-keyboard"></i> Keyboard Training</li>
        <li onclick="window.location.href='course-content.html'"><i class="fas fa-book"></i> Course Content</li>
        <li onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="admin-content">
      <!-- Header Section -->
      <header class="dashboard-header fade-in">
        <div>
          <h1 class="dashboard-title">Mission Links</h1>
          <p style="color: var(--text-secondary); font-size: 1.1rem; margin-top: 0.5rem;">
            Access essential mission resources and external links for training operations.
          </p>
          <!-- Debug test button -->
          <button onclick="alert('JavaScript is working!')" style="background: var(--accent-gradient); border: none; color: white; padding: 0.5rem 1rem; border-radius: 5px; margin-top: 1rem; cursor: pointer;">
            Test JavaScript
          </button>
          <!-- Test slideshow button -->
          <button onclick="testSlideshow()" style="background: var(--primary-gradient); border: none; color: white; padding: 0.5rem 1rem; border-radius: 5px; margin-top: 1rem; margin-left: 1rem; cursor: pointer;">
            Test Slideshow
          </button>
        </div>
      </header>

      <!-- Reference Section -->
      <section class="fade-in stagger-1">
        <h2 class="section-title">
          <i class="fas fa-book-open"></i>
          Quick Reference Generator
        </h2>
        <div class="tool-card" style="margin-bottom: 2rem;">
          <div class="tool-description" style="margin-bottom: 1.5rem;">
            Generate quick reference links for specific training scenarios and operational contexts.
          </div>
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <select id="referenceDropdown" style="background: #f0f0f0; border: 1px solid #ccc; border-radius: 10px; padding: 0.75rem 1rem; color: #000000; flex: 1; min-width: 200px;">
              <option value="">Template</option>
              <option value="mission-reference-1">Mission Reference: 1</option>
              <option value="mission-reference-2">Mission Reference: 2</option>
              <option value="mission-reference-3">Mission Reference: 3</option>
            </select>
            <button id="generateBtn" onclick="generateReference()" style="background: var(--accent-gradient); border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: var(--transition); position: relative; z-index: 1;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
              <i class="fas fa-play"></i> Generate
            </button>
          </div>
        </div>
      </section>

      <!-- Mission Links Grid -->
      <section class="fade-in stagger-2">
        <h2 class="section-title">
          <i class="fas fa-globe"></i>
          Essential Mission Resources
        </h2>
        <div class="tools-grid">
          <div class="tool-card" onclick="openLink('KitComm.html', 'KitComm')" style="cursor: pointer; z-index: 10;">
            <div class="tool-icon"><i class="fas fa-comments"></i></div>
            <h3 class="tool-title">KitComm</h3>
            <p class="tool-description">Secure team communications, messaging, and coordination platform.</p>
          </div>
          
          <div class="tool-card" onclick="openLink('SMXStream-new.html', 'SMX Stream')" style="cursor: pointer; z-index: 10;">
            <div class="tool-icon"><i class="fas fa-video"></i></div>
            <h3 class="tool-title">SMX Stream</h3>
            <p class="tool-description">Live training streams, recorded sessions, and real-time mission broadcasts.</p>
          </div>
          
          <div class="tool-card" onclick="openLink('OpsLog.html', 'Drift')" style="cursor: pointer; z-index: 10;">
            <div class="tool-icon"><i class="fas fa-clipboard-list"></i></div>
            <h3 class="tool-title">Drift</h3>
            <p class="tool-description">Mission operations logging, activity tracking, and incident reporting.</p>
          </div>
          
          <div class="tool-card" onclick="openLink('Trackpoint.html', 'TrackPoint')" style="cursor: pointer; z-index: 10;">
            <div class="tool-icon"><i class="fas fa-map-marked-alt"></i></div>
            <h3 class="tool-title">TrackPoint</h3>
            <p class="tool-description">Altis tactical mapping system with MGRS coordinates and city markers.</p>
          </div>
        </div>
      </section>

      <!-- File Submission System -->
      <section class="fade-in stagger-3" style="margin-top: 3rem;">
        <h2 class="section-title">
          <i class="fas fa-cloud-upload-alt"></i>
          File Submission System
        </h2>
        
        <!-- File Drop Zone Grid Container -->
        <div class="tools-grid">
          <div id="fileSubmissionCard" class="tool-card" style="border: 2px dashed var(--glass-border); text-align: center; cursor: pointer; transition: var(--transition);">
            <div class="tool-icon"><i class="fas fa-file-upload"></i></div>
            <h3 class="tool-title">Drop Files Here</h3>
            <p class="tool-description">Upload documents, images, videos, and other files for student submission.</p>
            <div style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
              Supports: PDF, DOC, DOCX, TXT, JPG, PNG, GIF, MP4, MOV, AVI
            </div>
            <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.mp4,.mov,.avi" style="display: none;">
          </div>
        </div>

        <!-- File List View (Hidden initially) -->
        <div class="tools-grid">
          <div id="fileListView" class="tool-card" style="display: none; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 class="tool-title" style="margin: 0;">
                <i class="fas fa-list"></i> Files Ready for Submission
              </h3>
              <button id="addMoreFiles" style="background: var(--accent-gradient); border: none; color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                <i class="fas fa-plus"></i> Add More Files
              </button>
            </div>
          
          <div id="filesList" style="margin-bottom: 1.5rem;">
            <!-- Files will be listed here -->
          </div>
          
          <div style="display: flex; gap: 1rem; align-items: flex-start; margin-bottom: 1.5rem;">
            <div style="flex: 1;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-accent);">
                <i class="fas fa-users"></i> Select Students:
              </label>
              <div class="student-dropdown-container" style="position: relative;">
                <button id="studentDropdownBtn" style="width: 100%; padding: 0.75rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                  <span>Select students...</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <div id="studentDropdown" class="student-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--card-gradient); border: 1px solid var(--glass-border); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; margin-top: 4px;">
                  <!-- Students will be populated here -->
                </div>
              </div>
              <div id="selectedStudentsDisplay" style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                No students selected
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button id="cancelSubmission" style="background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button id="submitFiles" style="background: var(--primary-gradient); border: none; color: white; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-paper-plane"></i> Submit to Grading
            </button>
          </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Slideshow Viewer Modal -->
  <div id="slideshowModal" class="slideshow-modal">
    <div class="slideshow-container">
      <button class="slideshow-close" onclick="closeSlideshowViewer()">
        <i class="fas fa-times"></i>
      </button>
      <div class="slideshow-content">
        <div id="slideshowLoader" class="slideshow-loader">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading images...</p>
        </div>
        <img id="slideshowImage" src="" alt="Mission Reference Image" style="display: none;" />
        <div class="slideshow-controls">
          <button class="slideshow-btn prev-btn" onclick="previousSlide()">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="slide-counter">
            <span id="currentSlideNumber">1</span> / <span id="totalSlides">8</span>
          </div>
          <button class="slideshow-btn next-btn" onclick="nextSlide()">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let uploadedFiles = [];
    let selectedStudents = [];
    let classStudents = [];

    function openLink(url, name) {
      console.log('Opening link:', name, 'URL:', url);
      try {
        const newWindow = window.open(url, '_blank');
        if (!newWindow) {
          console.error('Popup blocked or failed to open:', url);
          alert('Unable to open ' + name + '. Please check if popups are blocked.');
        } else {
          console.log('Successfully opened:', name);
        }
      } catch (error) {
        console.error('Error opening link:', error);
        alert('Error opening ' + name + ': ' + error.message);
      }
    }
    
    function openInstructorGrading() {
      const role = localStorage.getItem('role');
      if (role === 'admin' || role === 'instructor') {
        openLink('instructor-grading.html', 'Instructor Grading');
      } else {
        alert('Access denied. This feature is only available to instructors and admins.');
      }
    }
    
    // Slideshow variables
    let currentSlideIndex = 0;
    let slideImages = [];

    // Test function for slideshow
    function testSlideshow() {
      console.log('=== Test slideshow function called ===');
      const modal = document.getElementById('slideshowModal');
      console.log('Modal element:', modal);
      console.log('Modal display style:', window.getComputedStyle(modal).display);
      console.log('Modal classes:', modal.className);
      
      // Force show the modal for testing
      modal.style.display = 'flex !important';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
      modal.style.zIndex = '99999';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.classList.add('active');
      
      // Also test loading an image
      const img = document.getElementById('slideshowImage');
      const loader = document.getElementById('slideshowLoader');
      if (img && loader) {
        loader.style.display = 'none';
        img.style.display = 'block';
        img.src = 'images/Mission 1 Reference Product/1.jpg';
        console.log('Image source set to:', img.src);
      }
      
      console.log('Modal should now be visible');
      console.log('Modal display after change:', window.getComputedStyle(modal).display);
    }



    function generateReference() {
      console.log('=== generateReference function called ===');
      
      const dropdown = document.getElementById('referenceDropdown');
      if (!dropdown) {
        console.error('Dropdown element not found!');
        alert('Error: Reference dropdown not found.');
        return;
      }
      
      const selectedValue = dropdown.value;
      console.log('Generate Reference called, selected value:', selectedValue);
      
      if (!selectedValue) {
        alert('Please select a reference type first.');
        return;
      }
      
      // Handle different reference types
      switch(selectedValue) {
        case 'mission-reference-1':
          console.log('=== Opening slideshow viewer for Mission Reference 1 ===');
          alert('About to open slideshow viewer - check console for details');
          try {
            openSlideshowViewer();
          } catch (error) {
            console.error('Error opening slideshow:', error);
            alert('Error opening slideshow viewer. Please check the console for details.');
          }
          break;
        case 'mission-reference-2':
          alert('Mission Reference: 2 - Coming Soon');
          break;
        case 'mission-reference-3':
          alert('Mission Reference: 3 - Coming Soon');
          break;
        default:
          alert('Please select a valid reference type.');
      }
    }

    function openSlideshowViewer() {
      console.log('=== openSlideshowViewer called ===');
      
      try {
        // Initialize slideshow images for Mission Reference 1
        slideImages = [
          'images/Mission 1 Reference Product/1.jpg',
          'images/Mission 1 Reference Product/2.jpg',
          'images/Mission 1 Reference Product/3.jpg',
          'images/Mission 1 Reference Product/4.jpg',
          'images/Mission 1 Reference Product/5.jpg',
          'images/Mission 1 Reference Product/6.jpg',
          'images/Mission 1 Reference Product/7.jpg',
          'images/Mission 1 Reference Product/8.jpg'
        ];
        
        console.log('Slideshow images initialized:', slideImages);
        
        currentSlideIndex = 0;
        
        const modal = document.getElementById('slideshowModal');
        console.log('Modal element found:', modal);
        console.log('Modal current display:', window.getComputedStyle(modal).display);
        console.log('Modal current classes:', modal.className);
        
        if (!modal) {
          console.error('Modal element not found!');
          alert('Error: Slideshow modal not found.');
          return;
        }
        
        // Show modal first
        modal.classList.add('active');
        modal.style.display = 'flex';
        console.log('Modal active class added and display set to flex');
        console.log('Modal display after changes:', window.getComputedStyle(modal).display);
        console.log('Modal classes after changes:', modal.className);
        
        // Prevent body scrolling when modal is open
        document.body.style.overflow = 'hidden';
        
        // Update slide image after modal is shown
        setTimeout(() => {
          updateSlideImage();
        }, 100);
        
      } catch (error) {
        console.error('Error in openSlideshowViewer:', error);
        alert('Error opening slideshow viewer: ' + error.message);
      }
    }

    function closeSlideshowViewer() {
      const modal = document.getElementById('slideshowModal');
      modal.classList.remove('active');
      modal.style.display = 'none';
      
      // Restore body scrolling
      document.body.style.overflow = 'auto';
    }

    function updateSlideImage() {
      console.log('updateSlideImage called, currentSlideIndex:', currentSlideIndex);
      
      const img = document.getElementById('slideshowImage');
      const loader = document.getElementById('slideshowLoader');
      const currentSlideSpan = document.getElementById('currentSlideNumber');
      const totalSlidesSpan = document.getElementById('totalSlides');
      
      if (!img || !loader || !currentSlideSpan || !totalSlidesSpan) {
        console.error('One or more slideshow elements not found:', {
          img: !!img,
          loader: !!loader,
          currentSlideSpan: !!currentSlideSpan,
          totalSlidesSpan: !!totalSlidesSpan
        });
        return;
      }
      
      if (slideImages.length > 0) {
        // Show loader
        loader.style.display = 'flex';
        img.style.display = 'none';
        
        // Update slide counter
        currentSlideSpan.textContent = currentSlideIndex + 1;
        totalSlidesSpan.textContent = slideImages.length;
        
        const imagePath = slideImages[currentSlideIndex];
        console.log('Loading image:', imagePath);
        
        img.src = imagePath;
        img.alt = `Mission Reference Image ${currentSlideIndex + 1} of ${slideImages.length}`;
        
        // Handle successful image loading
        img.onload = function() {
          console.log('Image loaded successfully:', imagePath);
          loader.style.display = 'none';
          img.style.display = 'block';
        };
        
        // Handle image loading errors
        img.onerror = function() {
          console.error('Failed to load image:', imagePath);
          loader.style.display = 'none';
          img.style.display = 'block';
          img.alt = 'Image failed to load: ' + imagePath;
          img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBmb3VuZDwvdGV4dD48L3N2Zz4=';
        };
      } else {
        console.error('No slideshow images available');
      }
    }

    function nextSlide() {
      if (slideImages.length > 0) {
        currentSlideIndex = (currentSlideIndex + 1) % slideImages.length;
        updateSlideImage();
      }
    }

    function previousSlide() {
      if (slideImages.length > 0) {
        currentSlideIndex = (currentSlideIndex - 1 + slideImages.length) % slideImages.length;
        updateSlideImage();
      }
    }

    // Close slideshow when clicking outside the container
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('slideshowModal');
      const container = document.querySelector('.slideshow-container');
      
      if (modal && modal.classList.contains('active') && !container.contains(event.target)) {
        closeSlideshowViewer();
      }
    });

    // Close slideshow with Escape key
    document.addEventListener('keydown', function(event) {
      const modal = document.getElementById('slideshowModal');
      
      if (modal && modal.classList.contains('active')) {
        if (event.key === 'Escape') {
          closeSlideshowViewer();
        } else if (event.key === 'ArrowLeft') {
          previousSlide();
        } else if (event.key === 'ArrowRight') {
          nextSlide();
        }
      } else {
        // Test shortcut: Press 'T' to test slideshow
        if (event.key === 'T' || event.key === 't') {
          console.log('Test shortcut pressed - opening slideshow');
          openSlideshowViewer();
        }
      }
    });
    
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('userName');
      localStorage.removeItem('classId');
      window.location.replace('/login.html');
    }

    // Additional event listener setup for the generate button
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded - Setting up event listeners');
      
      const generateBtn = document.getElementById('generateBtn');
      if (generateBtn) {
        console.log('Generate button found, adding click listener');
        generateBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Generate button clicked via event listener');
          generateReference();
        });
      } else {
        console.error('Generate button not found!');
      }
      
      // Test if slideshow modal exists
      const modal = document.getElementById('slideshowModal');
      if (modal) {
        console.log('Slideshow modal found');
      } else {
        console.error('Slideshow modal not found!');
      }
    });

    // File handling functions
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileIcon(fileName) {
      const extension = fileName.split('.').pop().toLowerCase();
      const iconMap = {
        'pdf': 'fas fa-file-pdf',
        'doc': 'fas fa-file-word',
        'docx': 'fas fa-file-word',
        'txt': 'fas fa-file-alt',
        'jpg': 'fas fa-file-image',
        'jpeg': 'fas fa-file-image',
        'png': 'fas fa-file-image',
        'gif': 'fas fa-file-image',
        'mp4': 'fas fa-file-video',
        'mov': 'fas fa-file-video',
        'avi': 'fas fa-file-video'
      };
      return iconMap[extension] || 'fas fa-file';
    }

    function handleFiles(files) {
      for (let file of files) {
        if (!uploadedFiles.find(f => f.name === file.name && f.size === file.size)) {
          uploadedFiles.push(file);
        }
      }
      updateFilesList();
      showFileListView();
    }

    function updateFilesList() {
      const filesList = document.getElementById('filesList');
      if (uploadedFiles.length === 0) {
        filesList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1rem;">No files selected</div>';
        return;
      }

      filesList.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-item">
          <div class="file-info">
            <i class="${getFileIcon(file.name)} file-icon"></i>
            <div class="file-details">
              <div class="file-name">${file.name}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
          </div>
          <button class="file-remove" onclick="removeFile(${index})">
            <i class="fas fa-times"></i> Remove
          </button>
        </div>
      `).join('');
    }

    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      updateFilesList();
      if (uploadedFiles.length === 0) {
        showFileDropView();
      }
    }

    function showFileListView() {
      document.getElementById('fileSubmissionCard').style.display = 'none';
      document.getElementById('fileListView').style.display = 'block';
    }

    function showFileDropView() {
      document.getElementById('fileSubmissionCard').style.display = 'block';
      document.getElementById('fileListView').style.display = 'none';
      uploadedFiles = [];
      selectedStudents = [];
      updateSelectedStudentsDisplay();
    }

    // Student selection functions
    async function loadClassStudents() {
      try {
        const token = localStorage.getItem('token');
        const classId = localStorage.getItem('classId');
        
        if (!token || !classId) {
          console.warn('No token or class ID found');
          return;
        }

        const response = await fetch(`/api/classes/${classId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const classData = await response.json();
          classStudents = classData.students || [];
          updateStudentDropdown();
        } else {
          console.error('Failed to load class students');
        }
      } catch (error) {
        console.error('Error loading class students:', error);
      }
    }

    function updateStudentDropdown() {
      const dropdown = document.getElementById('studentDropdown');
      if (classStudents.length === 0) {
        dropdown.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">No students found in this class</div>';
        return;
      }

      dropdown.innerHTML = classStudents.map(student => `
        <div class="student-option" onclick="toggleStudent('${student._id}', '${student.username}')">
          <div class="student-checkbox ${selectedStudents.includes(student._id) ? 'checked' : ''}"></div>
          <span>${student.username}</span>
        </div>
      `).join('');
    }

    function toggleStudent(studentId, studentName) {
      const index = selectedStudents.indexOf(studentId);
      if (index > -1) {
        selectedStudents.splice(index, 1);
      } else {
        selectedStudents.push(studentId);
      }
      updateStudentDropdown();
      updateSelectedStudentsDisplay();
    }

    function updateSelectedStudentsDisplay() {
      const display = document.getElementById('selectedStudentsDisplay');
      if (selectedStudents.length === 0) {
        display.textContent = 'No students selected';
        display.style.color = 'var(--text-secondary)';
      } else {
        const selectedNames = selectedStudents.map(id => {
          const student = classStudents.find(s => s._id === id);
          return student ? student.username : 'Unknown';
        });
        display.textContent = `${selectedStudents.length} student(s) selected: ${selectedNames.join(', ')}`;
        display.style.color = 'var(--text-accent)';
      }
    }

    // Submission function
    async function submitFilesToGrading() {
      if (uploadedFiles.length === 0) {
        alert('Please select files to submit.');
        return;
      }

      if (selectedStudents.length === 0) {
        alert('Please select at least one student.');
        return;
      }

      try {
        // Create submissions for instructor grading
        const submissions = selectedStudents.map(studentId => {
          const student = classStudents.find(s => s._id === studentId);
          return uploadedFiles.map(file => ({
            id: `sub_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            studentId: studentId,
            studentName: student ? student.username : 'Unknown',
            fileName: file.name,
            fileSize: file.size,
            fileType: file.type,
            fileData: file, // Store file object for now
            submittedAt: new Date().toISOString(),
            status: 'pending',
            exercise: 'File Submission'
          }));
        }).flat();

        // Store submissions in localStorage for instructor grading
        const existingSubmissions = JSON.parse(localStorage.getItem('fileSubmissions') || '[]');
        existingSubmissions.push(...submissions);
        localStorage.setItem('fileSubmissions', JSON.stringify(existingSubmissions));

        alert(`Successfully submitted ${uploadedFiles.length} file(s) for ${selectedStudents.length} student(s) to instructor grading.`);
        
        // Reset the form
        showFileDropView();
        
        // Optionally open instructor grading
        const openGrading = confirm('Would you like to open the instructor grading page now?');
        if (openGrading) {
          openInstructorGrading();
        }

      } catch (error) {
        console.error('Error submitting files:', error);
        alert('Error submitting files. Please try again.');
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Load class students
      loadClassStudents();

      // File drop zone
      const fileSubmissionCard = document.getElementById('fileSubmissionCard');
      const fileInput = document.getElementById('fileInput');

      fileSubmissionCard.addEventListener('click', () => {
        fileInput.click();
      });

      fileSubmissionCard.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileSubmissionCard.classList.add('dragover');
      });

      fileSubmissionCard.addEventListener('dragleave', (e) => {
        if (!fileSubmissionCard.contains(e.relatedTarget)) {
          fileSubmissionCard.classList.remove('dragover');
        }
      });

      fileSubmissionCard.addEventListener('drop', (e) => {
        e.preventDefault();
        fileSubmissionCard.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });

      // Add more files button
      document.getElementById('addMoreFiles').addEventListener('click', () => {
        fileInput.click();
      });

      // Student dropdown
      document.getElementById('studentDropdownBtn').addEventListener('click', () => {
        const dropdown = document.getElementById('studentDropdown');
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('studentDropdown');
        const btn = document.getElementById('studentDropdownBtn');
        if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });

      // Action buttons
      document.getElementById('cancelSubmission').addEventListener('click', showFileDropView);
      document.getElementById('submitFiles').addEventListener('click', submitFilesToGrading);
    });

    // Make functions globally accessible
    window.removeFile = removeFile;
    window.toggleStudent = toggleStudent;
    
    // Debug: Test if JavaScript is working
    console.log('Mission Links JavaScript loaded successfully');
  </script>
</body>
</html>