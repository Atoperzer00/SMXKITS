<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ops Log - SMXKITS</title>
  <style>
    :root {
      --bg: #1e1e1e;
      --panel: #23272e;
      --sidebar: #20232a;
      --accent: #22c55e;
      --inactive: #3b3b3b;
      --hover: #262a32;
      --qc-orange: #ff9800;
      --qc-yellow: #ffe066;
      --qc-green: #22c55e;
      --qc-red: #ef4444;
      --bubble-bg: #141414;
      --bubble-text: #fafafa;
      --button-bg: #23272e;
      --button-hover: #31363f;
      --input-bg: #252a33;
      --input-border: #333c48;
      --logo-color: #22c55e;
      --follow-blue: #3b82f6;
      --follow-blue-dark: #2563eb;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--bubble-text);
      min-height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Sidebar */
    .sidebar {
      width: 480px;
      background: var(--sidebar);
      padding: 28px 18px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      box-sizing: border-box;
      border-right: 2px solid var(--inactive);
      overflow-y: auto;
    }
    .logo {
      font-size: 1.8em;
      font-weight: bold;
      letter-spacing: 2px;
      color: var(--logo-color);
      margin-bottom: 12px;
    }
    .nav {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .nav-btn {
      background: var(--button-bg);
      border: none;
      color: #fafafa;
      font-size: 1.07em;
      padding: 11px 16px;
      margin: 0;
      text-align: left;
      border-radius: 7px;
      cursor: pointer;
      transition: background 0.2s;
      outline: none;
    }
    .nav-btn:hover, .nav-btn.active {
      background: var(--button-hover);
    }
    .divider {
      height: 1px;
      background: var(--inactive);
      margin: 16px 0 12px 0;
      border-radius: 2px;
    }
    .room-status {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      padding: 15px 14px;
      font-size: 0.98em;
      margin-bottom: 12px;
      color: #e5e7eb;
      line-height: 1.5;
    }
    .logout-btn {
      margin-top: auto;
      background: var(--qc-red);
      color: #fff;
      border: none;
      font-size: 1.06em;
      padding: 12px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .logout-btn:hover { background: #be2121; }

    /* Main */
    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--panel);
      overflow: hidden;
    }
    .top-bar {
      height: 58px;
      background: var(--sidebar);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 30px;
      border-bottom: 2px solid var(--inactive);
      font-size: 1.1em;
      letter-spacing: 1px;
      color: #a9d4c6;
      font-weight: 500;
      z-index: 2;
    }
    .feed-panel {
      flex: 1;
      overflow-y: auto;
      padding: 36px 26px 22px 26px;
      background: var(--panel);
      display: flex;
      flex-direction: column-reverse;
      gap: 24px;
      min-height: 0;
    }

    /* Log Bubbles */
    .bubble {
      background: var(--bubble-bg);
      color: var(--bubble-text);
      border: 2.5px solid var(--inactive);
      border-radius: 18px;
      box-shadow: 0 4px 28px #00000045;
      padding: 24px 34px 19px 24px;
      position: relative;
      transition: border-color 0.22s, box-shadow 0.22s;
      min-width: 260px;
      max-width: 610px;
      word-break: break-word;
      white-space: pre-line;
      font-size: 1.06em;
    }
    .bubble.qc-orange { border-color: var(--qc-orange);}
    .bubble.qc-yellow { border-color: var(--qc-yellow);}
    .bubble.qc-green  { border-color: var(--qc-green);}
    .bubble.qc-red    { border-color: var(--qc-red);}
    .bubble-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 40px; } 
    .bubble-left, .bubble-right { display: flex; flex-direction: column; gap: 7px; } 
    .bubble-row { margin-bottom: 2px; } 
    .bubble-right { align-items: flex-end; min-width: 160px; font-family: 'Consolas', 'Menlo', 'Monaco', monospace; } 
    .bubble-right .bubble-time { font-weight: bold; font-size: 1.1em; }
    .bubble .menu-btn {
      position: absolute;
      top: 14px;
      right: 16px;
      background: transparent;
      border: none;
      cursor: pointer;
      color: #a7a7a7;
      font-size: 1.56em;
      z-index: 3;
      padding: 0;
      border-radius: 50%;
      width: 38px; height: 38px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .bubble .menu-btn:hover { background: var(--hover); }
    .bubble .callout-meta {
      font-size: 0.98em;
      color: #b9c6c7;
      margin-bottom: 6px;
    }

    /* Form - Form is now in sidebar, so this style is kept for reference but not actively used */
    .form-panel {
      width: 100%;
      background: var(--sidebar);
      border-top: 2px solid var(--inactive);
      padding: 25px 28px;
      display: flex;
      flex-direction: column;
      gap: 17px;
      z-index: 3;
    }
    .form-title {
      font-size: 1.2em;
      font-weight: 600;
      color: var(--logo-color);
      letter-spacing: 1px;
      margin-bottom: 7px;
    }
    .fields-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px 24px;
      align-items: flex-start;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    label {
      font-size: 0.97em;
      color: #c2cbd1;
      font-weight: 500;
    }
    input, select, textarea {
      background: linear-gradient(90deg, #23272e 60%, #252a33 100%);
      color: #f5f6f7;
      border: 2px solid var(--input-border);
      border-radius: 11px;
      font-size: 1.08em;
      padding: 13px 16px;
      outline: none;
      box-shadow: 0 2px 8px #10121740;
      transition: border-color 0.18s, box-shadow 0.18s, background 0.18s;
      min-height: 44px;
      font-family: inherit;
      margin-bottom: 1px;
      width: 100%;
      resize: none;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      background: linear-gradient(90deg, #23272e 10%, #28322e 100%);
      box-shadow: 0 0 0 2px var(--accent);
    }
    input[readonly], textarea[readonly] {
      background: #23272e70;
      color: #9fa8ac;
      cursor: not-allowed;
    }
    textarea {
      min-height: 70px;
      max-height: 350px;
      overflow: auto;
      resize: vertical;
      line-height: 1.6;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    ::placeholder {
      color: #9fa8ac;
      opacity: 0.85;
      font-size: 0.98em;
    }
    select {
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="16" viewBox="0 0 20 20" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M7.293 8.293l3.293 3.293 3.293-3.293 1.414 1.414-4.707 4.707-4.707-4.707z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 34px;
    }
    .submit-btn {
      background: var(--accent);
      color: #fff;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      font-size: 1.13em;
      padding: 14px;
      margin-top: 10px;
      cursor: pointer;
      transition: background 0.18s;
      box-shadow: 0 1px 10px #00000017;
    }
    .submit-btn:hover { background: #28dd6c; }

    /* Follow Section */
    .follow-section {
      background: var(--panel);
      border: 1.5px solid var(--input-border);
      border-radius: 10px;
      margin-top: 7px;
      padding: 18px 18px 13px 18px;
      display: flex;
      flex-direction: column;
      gap: 13px;
      animation: fadeIn 0.25s;
    }
    .follow-row {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .stage-btn {
      background: var(--qc-orange);
      color: #181c1c;
      border: none;
      border-radius: 7px;
      font-weight: 700;
      font-size: 1em;
      padding: 10px 21px;
      cursor: pointer;
      outline: none;
      margin-right: 6px;
      min-width: 95px;
    }
    .follow-actions .action-btn {
      background: var(--button-bg);
      color: #eee;
      border: 1.5px solid var(--input-border);
      border-radius: 7px;
      padding: 8px 17px;
      font-size: 1em;
      margin-right: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.13s, border 0.13s;
    }
    .follow-actions .action-btn:hover {
      background: var(--button-hover);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Overlay/Modal */
    .modal {
      position: fixed;
      z-index: 30;
      left: 0; top: 0; right: 0; bottom: 0;
      background: #181e22e9;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.22s;
    }
    .modal-content {
      background: var(--sidebar);
      color: #f5f6f7;
      padding: 34px 38px 32px 38px;
      border-radius: 14px;
      min-width: 400px;
      max-width: 98vw;
      box-shadow: 0 10px 60px #00000069;
      position: relative;
      font-size: 1.08em;
    }
    .modal-close {
      position: absolute;
      top: 12px; right: 18px;
      background: none;
      color: #ccc;
      border: none;
      font-size: 1.4em;
      cursor: pointer;
      transition: color 0.16s;
    }
    .modal-close:hover { color: var(--qc-red); }

    /* Follow Indicator Styles */
    .bubble.has-follow {
      position: relative;
      padding-left: 30px; /* Make room for the indicator */
    }
    
    .follow-indicator {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 20px;
      background: var(--follow-blue);
      border-top-left-radius: 18px;
      border-bottom-left-radius: 18px;
      opacity: 0.85;
      transition: background-color 0.2s;
    }
    
    .follow-indicator.follow-ended {
      background: var(--follow-blue-dark);
      opacity: 0.5;
    }
    
    .follow-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .follow-id {
      font-size: 0.85em;
      color: var(--follow-blue);
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    /* Scrollbars */
    ::-webkit-scrollbar { width: 10px; background: #17181a;}
    ::-webkit-scrollbar-thumb { background: #22262b; border-radius: 6px;}
    ::-webkit-scrollbar-thumb:hover { background: #363b40;}
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar with form -->
    <aside class="sidebar">
      <div class="logo">SMXKITS</div>
      <div class="nav">
        <!-- My Logs button removed -->
        <!-- Dashboard and Join Room buttons moved to top bar -->
      </div>
      <div class="divider"></div>

      <!-- Callout Form moved to sidebar -->
      <form id="logForm" autocomplete="off" style="margin-top: 10px;">
        <div class="form-title" style="font-size: 1.1em; margin-bottom: 12px;">Submit New Callout</div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Classification</label>
          <select name="classification" required>
            <option value="">Select</option>
            <option>No Classification</option>
          </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Asset Name</label>
          <input type="text" name="asset" required/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Sensor</label>
          <select name="sensor" required>
            <option value="FMV">FMV</option>
          </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Mission / Operation</label>
          <input type="text" name="operation" value="OBJ" required/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Country Code</label>
          <input type="text" name="countryCode" maxlength="3"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Team Name</label>
          <input type="text" name="team"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Zulu Time</label>
          <input type="time" name="zulu" required/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>MGRS</label>
          <input type="text" name="mgrs"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Location Description</label>
          <input type="text" name="location"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Activity</label>
          <textarea id="activityTextarea" name="activity" rows="1"></textarea>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Males</label>
          <input type="number" name="males" min="0"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Females</label>
          <input type="number" name="females" min="0"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Children</label>
          <input type="number" name="children" min="0"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Vehicles</label>
          <input type="number" name="vehicles" min="0"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>IA Notes</label>
          <textarea name="iaNotes" rows="1" oninput="autoGrow(this)"></textarea>
        </div>
        
        <div id="followContainer" style="margin-bottom: 12px;">
          <button type="button" class="submit-btn" style="margin-bottom: 0; background:var(--qc-orange); color:#181c1c; font-weight:600; width: 100%;" onclick="openFollow()">Create Follow</button>
        </div>
        
        <button type="submit" class="submit-btn" style="width: 100%;">Submit</button>
      </form>
      
      <button id="logoutBtn" class="logout-btn" style="margin-top: 20px;">Logout</button>
    </aside>

    <!-- Main -->
    <main class="main-panel">
      <div class="top-bar" id="mainTopBar">
        <!-- Room information and navigation buttons in top bar -->
        <div style="flex: 1; display: flex; align-items: center;">
          <span style="font-weight: bold; margin-right: 15px;">OPS LOG</span>
          <button id="joinRoomBtn" class="nav-btn" style="margin:0 20px;">Join Room</button>
          &mdash; 
          <div style="margin-left: 10px; display: flex; align-items: center;">
            <span>Class: <span id="currentClass" style="font-weight: 500; color: #a9d4c6;">-</span></span>
            <span style="margin: 0 10px;">|</span>
            <span>Team: <span id="currentTeam" style="font-weight: 500; color: #a9d4c6;">-</span></span>
            <span style="margin: 0 10px;">|</span>
            <span>Mission: <span id="currentMission" style="font-weight: 500; color: #a9d4c6;">-</span></span>
          </div>
        </div>
        <button id="dashboardBtn" class="nav-btn" style="margin-left:24px;">Dashboard</button>
      </div>

      <section class="feed-panel" id="feedPanel">
        <!-- Generated log/chat bubbles will appear here -->
      </section>
    </main>
  </div>

  <!-- Room Modal -->
  <div id="roomModal" class="modal" style="display:none;">
    <div class="modal-content">
      <button id="closeRoomModalBtn" class="modal-close">&times;</button>
      <div style="font-weight:600; color:var(--logo-color); font-size:1.2em; margin-bottom:16px;">Join a Room</div>
      <form id="joinRoomForm">
        <div class="form-group" style="margin-bottom: 15px;">
          <label>Team</label>
          <select name="team" id="modalTeam" required>
            <option value="">Select Team</option>
            <option>Alpha Team</option><option>Bravo Team</option><option>Charlie Team</option>
            <option>Delta Team</option><option>Echo Team</option><option>Foxtrot Team</option>
            <option>Golf Team</option><option>Hotel Team</option><option>India Team</option>
            <option>Juliett Team</option><option>Kilo Team</option><option>Lima Team</option>
            <option>Mike Team</option><option>November Team</option><option>Oscar Team</option>
            <option>Papa Team</option><option>Quebec Team</option><option>Romeo Team</option>
            <option>Sierra Team</option><option>Tango Team</option><option>Uniform Team</option>
            <option>Victor Team</option><option>Whiskey Team</option><option>X-ray Team</option>
            <option>Yankee Team</option><option>Zulu Team</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label>Mission</label>
          <select name="mission" id="modalMission" required>
            <option value="">Select Mission</option>
            <!-- Populate 30 missions -->
            <option>Mission 1</option><option>Mission 2</option><option>Mission 3</option>
            <option>Mission 4</option><option>Mission 5</option><option>Mission 6</option>
            <option>Mission 7</option><option>Mission 8</option><option>Mission 9</option>
            <option>Mission 10</option><option>Mission 11</option><option>Mission 12</option>
            <option>Mission 13</option><option>Mission 14</option><option>Mission 15</option>
            <option>Mission 16</option><option>Mission 17</option><option>Mission 18</option>
            <option>Mission 19</option><option>Mission 20</option><option>Mission 21</option>
            <option>Mission 22</option><option>Mission 23</option><option>Mission 24</option>
            <option>Mission 25</option><option>Mission 26</option><option>Mission 27</option>
            <option>Mission 28</option><option>Mission 29</option><option>Mission 30</option>
          </select>
        </div>
        <button type="button" id="joinRoomButton" class="submit-btn" style="margin-top:18px;">Join Room</button>
      </form>
    </div>
  </div>

  <!-- Callout Menu Modal -->
  <div id="calloutMenuModal" class="modal" style="display:none;">
    <div class="modal-content" id="calloutMenuContent">
      <!-- Content filled by JS -->
    </div>
  </div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
  // ------ Global State ------
  let currentRoom = { classId: null, team: null, mission: null };
  // Connect to socket.io server, using same host as current page
  let socket = io(window.location.hostname === 'localhost' ? 'http://localhost:3001' : '');
  let callouts = {}; // id -> callout
  
  // Helper for growing textareas
  function autoGrow(el) {
    el.style.height = '38px';
    el.style.height = (el.scrollHeight)+'px';
  }
  
  // ------ Core UI Functions ------
  function openRoomModal() { 
    console.log("Opening room modal");
    document.getElementById('roomModal').style.display = 'flex'; 
  }
  
  function closeRoomModal() { 
    console.log("Closing room modal");
    document.getElementById('roomModal').style.display = 'none'; 
  }
  
  function closeCalloutMenu() {
    console.log("Closing callout menu");
    document.getElementById('calloutMenuModal').style.display = 'none';
  }
  
  function goDashboard() {
    console.log("Navigating to dashboard");
    window.location.href = '/dashboard.html';
  }
  
  function logout() {
    console.log("Logging out");
    localStorage.removeItem('token');
    localStorage.removeItem('userName');
    window.location.href = '/login.html';
  }
  
  // ------ Form Handling Functions ------
  async function handleJoinRoomForm(form) {
    try {
      console.log("Join Room form submitted");
      
      const teamSelect = document.getElementById('modalTeam');
      const missionSelect = document.getElementById('modalMission');
      
      // Validate form fields
      if (!teamSelect.value) {
        alert("Please select a team");
        return;
      }
      if (!missionSelect.value) {
        alert("Please select a mission");
        return;
      }
      
      // Join room
      let classId = "SMX";
      let team = teamSelect.value;
      let mission = missionSelect.value;
      
      console.log("Selected values:", { classId, team, mission });
      
      currentRoom = { classId, team, mission };
      let roomId = classId + "_" + team + "_" + mission;
      socket.emit('join_room', roomId);
      
      document.getElementById('currentClass').textContent = classId;
      document.getElementById('currentTeam').textContent = team;
      document.getElementById('currentMission').textContent = mission;
      
      closeRoomModal();
      await loadCallouts(roomId);
    } catch (error) {
      console.error("Error joining room:", error);
      alert("Error joining room: " + error.message);
    }
  }
  
  async function submitLogForm(form) {
    if(!currentRoom.classId) {
      alert('Join a room first.');
      return;
    }
    
    try {
      console.log("Log form submitted");
      const data = Object.fromEntries(new FormData(form));
let follow = undefined;
if (document.querySelector('[data-follow-section="true"]')) {
  follow = {
    name: document.getElementById('followName').value,
    stage: document.getElementById('followStageBtn').textContent,
    followId: window.followState?.followId || Math.random().toString(36).substr(2, 6).toUpperCase(),
    ended: window.followState?.ended || (window.followState?.stage === 3) || false
  };
}
      
      const payload = {
        ...data,
        roomId: currentRoom.classId + "_" + currentRoom.team + "_" + currentRoom.mission,
        follow,
        createdBy: localStorage.getItem('userName') || "You"
      };
      
const response = await fetch('/api/callouts', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }
      
      const log = await response.json();
      callouts[log._id] = log;
      createBubble(log, false);
      
      // Clear form
      form.reset();
      const textareas = form.querySelectorAll('textarea');
      textareas.forEach(ta => ta.style.height = 'auto');
      
      // Flash animation
      const bubble = document.getElementById('callout_' + log._id);
      if (bubble) {
        bubble.style.animation = 'none';
        bubble.offsetHeight; /* trigger reflow */
        bubble.style.animation = 'flash 1.5s';
      }
    } catch (error) {
      console.error("Error submitting callout:", error);
      alert("Error submitting callout: " + error.message);
    }
  }
  
  // ------ Data Loading Functions ------
  async function loadCallouts(roomId) {
    try {
      console.log("Loading callouts for room:", roomId);
      const response = await fetch(`http://localhost:3001/api/callouts/${roomId}`);
      
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }
      
      const logs = await response.json();
      console.log("Callouts loaded:", logs);
      
      callouts = {};
      document.getElementById('feedPanel').innerHTML = '';
      
      // Sort logs by creation date (newest first)
      logs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      for(const log of logs) {
        callouts[log._id] = log;
        createBubble(log, true);
      }
    } catch (error) {
      console.error("Error loading callouts:", error);
      alert("Error loading room data: " + error.message);
    }
  }
  
  // ------ UI Generation Functions ------
  window.createBubble = function(data, append=false) {
    try {
      const panel = document.getElementById('feedPanel');
      const div = document.createElement('div');
      div.className = "bubble " + (data.qc || "qc-orange"); 
      div.id = 'callout_' + data._id; 
      
      // Create menu button with direct onclick attribute
      const menuBtn = document.createElement('button');
      menuBtn.className = "menu-btn";
      menuBtn.title = "Options";
      menuBtn.innerHTML = "&#8942;";
      menuBtn.setAttribute('onclick', `showCalloutMenu(event, this, '${data._id}')`);
      
      // Add follow indicator if this callout has a follow
      const hasFollow = data.follow && data.follow.name;
      if (hasFollow) {
        div.classList.add('has-follow');
      }
      
      // Create the rest of the content
      const content = document.createElement('div');
      content.className = "bubble-flex";
      
      // If has follow, add the vertical indicator bar
      if (hasFollow) {
        const followIndicator = document.createElement('div');
        followIndicator.className = "follow-indicator";
        followIndicator.title = data.follow.followId || "Follow";
        
        // If follow is ended, add specific class
        if (data.follow.ended || data.follow.stage === "END") {
          followIndicator.classList.add('follow-ended');
        }
        
        div.appendChild(followIndicator);
      }
      
      content.innerHTML = `
        <div class="bubble-left"> 
          <div class="bubble-row"> 
            <span><b>${data.operation || '-'}</b></span> 
            <span style="margin: 0 9px; color: #444;">|</span> 
            <span><b>${data.asset || '-'}</b></span> 
          </div> 
          <div class="bubble-row">${data.location || '-'}</div> 
          ${ hasFollow ? `<div class="bubble-row follow-title">
            <b>${data.follow.name} / ${data.follow.stage}</b>
            ${data.follow.followId ? `<span class="follow-id">#${data.follow.followId}</span>` : ''}
          </div>` : '' } 
          <div class="bubble-row">${data.activity || '-'}</div> 
          <div class="bubble-row"><b>IA Notes:</b> ${(data.iaNotes||'').replace(/\n/g,'<br>')}</div> 
        </div> 
        <div class="bubble-right"> 
          <span class="bubble-time">${data.zulu || '-'}</span> 
          <span>MGRS: ${data.mgrs || '-'}</span> 
          <span>SLANT: ${(data.males||0)}/${(data.females||0)}/${(data.children||0)} &nbsp; V: ${(data.vehicles||0)}</span> 
        </div>
      `;
      
      const footer = document.createElement('div');
      footer.style.fontSize = "0.85em";
      footer.style.color = "#888";
      footer.style.marginTop = "7px";
      footer.innerHTML = `By ${data.createdBy} &middot; ${(data.createdAt ? new Date(data.createdAt).toLocaleTimeString() : '')}`;
      
      // Assemble the bubble
      div.appendChild(menuBtn);
      div.appendChild(content);
      div.appendChild(footer);
      div.dataset.payload = JSON.stringify(data);
      
      if (append) panel.appendChild(div); 
      else panel.prepend(div);
    } catch (error) {
      console.error("Error creating bubble:", error);
    }
  };
  
  function showCalloutMenu(e, btn, id) {
    try {
      e.stopPropagation();
      console.log("Opening callout menu for:", id);
      const modalContent = document.getElementById('calloutMenuContent');
      
      // Create menu content
      modalContent.innerHTML = '';
      
      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.className = "modal-close";
      closeBtn.innerHTML = "&times;";
      closeBtn.addEventListener('click', closeCalloutMenu);
      
      // Title
      const title = document.createElement('div');
      title.style.textAlign = "center";
      title.style.marginBottom = "20px";
      title.style.fontWeight = "bold";
      title.textContent = "Callout Options";
      
      // Options container
      const options = document.createElement('div');
      options.style.display = "flex";
      options.style.gap = "15px";
      options.style.flexDirection = "column";
      
      // Create button helper function
      function createActionButton(text, action) {
        const button = document.createElement('button');
        button.className = "nav-btn";
        button.textContent = text;
        button.addEventListener('click', action);
        return button;
      }
      
      // Add option buttons
      options.appendChild(createActionButton("Delete Callout", () => deleteCallout(id)));
      options.appendChild(createActionButton("Edit Callout", () => editCallout(id)));
      options.appendChild(createActionButton("Add Follow-on", () => addFollow(id)));
      options.appendChild(createActionButton("Set QC: In Progress", () => updateQC(id, 'qc-orange')));
      options.appendChild(createActionButton("Set QC: In Review", () => updateQC(id, 'qc-yellow')));
      options.appendChild(createActionButton("Set QC: Approved", () => updateQC(id, 'qc-green')));
      options.appendChild(createActionButton("Set QC: Issues", () => updateQC(id, 'qc-red')));
      
      // Assemble modal content
      modalContent.appendChild(closeBtn);
      modalContent.appendChild(title);
      modalContent.appendChild(options);
      
      // Show modal
      document.getElementById('calloutMenuModal').style.display = 'flex';
    } catch (error) {
      console.error("Error showing callout menu:", error);
    }
  }
  
  // ------ Action Functions ------
  async function updateQC(id, qcClass) {
    closeCalloutMenu();
    console.log("Updating QC:", id, qcClass);
    const callout = callouts[id];
    if (!callout) return;
    
    try {
      const response = await fetch(`http://localhost:3001/api/callouts/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          ...callout,
          qc: qcClass,
          editedBy: localStorage.getItem('userName') || 'You'
        })
      });
      
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }
      
      const updated = await response.json();
      callouts[id] = updated;
      
      const bubble = document.getElementById('callout_' + id);
      if (bubble) {
        bubble.classList.remove('qc-orange', 'qc-yellow', 'qc-green', 'qc-red');
        bubble.classList.add(qcClass);
      }
    } catch (error) {
      console.error('Error updating QC:', error);
      alert('Error updating QC: ' + error.message);
    }
  }
  
  async function deleteCallout(id) {
    closeCalloutMenu();
    if (confirm('Are you sure you want to delete this callout?')) {
      console.log("Deleting callout:", id);
      
      try {
        const response = await fetch(`http://localhost:3001/api/callouts/${id}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error(`Server returned ${response.status}`);
        }
        
        const bubble = document.getElementById('callout_' + id);
        if (bubble) bubble.remove();
        delete callouts[id];
      } catch (error) {
        console.error('Error deleting callout:', error);
        alert('Error deleting callout: ' + error.message);
      }
    }
  }
  
  function editCallout(id) {
    closeCalloutMenu();
    alert('Edit functionality will be implemented in a future update.');
  }
  
  function addFollow(id) {
    closeCalloutMenu();
    console.log("Adding follow-on to:", id);
    const callout = callouts[id];
    if (!callout) return;
    
    const bubble = document.getElementById('callout_' + id);
    if (!bubble || bubble.querySelector('.follow-section')) return;
    
    const followSection = document.createElement('div');
  followSection.className = 'follow-section';
  followSection.dataset.followSection = 'true';   // or append unique suffix
    
    // Create name input row
    const nameRow = document.createElement('div');
    nameRow.className = 'follow-row';
    
    const nameLabel = document.createElement('label');
    nameLabel.style.marginRight = 'auto';
    nameLabel.textContent = 'Name:';
    
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.id = 'followName';
    nameInput.style.flex = '1';
    nameInput.placeholder = 'Enter name';
    
    nameRow.appendChild(nameLabel);
    nameRow.appendChild(nameInput);
    
    // Create stage buttons row
    const stageRow = document.createElement('div');
    stageRow.className = 'follow-row follow-actions';
    
    const stageBtn = document.createElement('button');
    stageBtn.id = 'followStageBtn';
    stageBtn.className = 'stage-btn';
    stageBtn.textContent = 'WATCH';
    
    // Helper function for stage buttons
    function createStageButton(stage) {
      const btn = document.createElement('button');
      btn.className = 'action-btn';
      btn.textContent = stage;
      btn.addEventListener('click', function() {
        updateStage(stage);
      });
      return btn;
    }
    
    stageRow.appendChild(stageBtn);
    stageRow.appendChild(createStageButton('WATCH'));
    stageRow.appendChild(createStageButton('TRACK'));
    stageRow.appendChild(createStageButton('TARGET'));
    stageRow.appendChild(createStageButton('ENGAGE'));
    stageRow.appendChild(createStageButton('ASSESS'));
    
    // Create submit button row
    const submitRow = document.createElement('div');
    submitRow.className = 'follow-row';
    submitRow.style.justifyContent = 'flex-end';
    submitRow.style.marginTop = '10px';
    
    const submitBtn = document.createElement('button');
    submitBtn.className = 'submit-btn';
    submitBtn.style.padding = '8px 16px';
    submitBtn.style.margin = '0';
    submitBtn.textContent = 'Submit Follow';
    submitBtn.addEventListener('click', function() {
      submitFollow(id);
    });
    
    submitRow.appendChild(submitBtn);
    
    // Assemble and insert follow section
    followSection.appendChild(nameRow);
    followSection.appendChild(stageRow);
    followSection.appendChild(submitRow);
    
    const timeText = bubble.querySelector('.bubble-right');
    timeText.parentNode.insertBefore(followSection, timeText.nextSibling);
  }
  
  function updateStage(stage) {
    const stageBtn = document.getElementById('followStageBtn');
    if (stageBtn) {
      stageBtn.textContent = stage;
      stageBtn.style.background = {
        'WATCH': 'var(--qc-orange)',
        'TRACK': 'var(--qc-yellow)',
        'TARGET': 'var(--qc-green)',
        'ENGAGE': 'var(--qc-red)',
        'ASSESS': '#3b82f6'
      }[stage] || 'var(--qc-orange)';
    }
  }
  
  async function submitFollow(id) {
    console.log("Submitting follow-on for:", id);
    const callout = callouts[id];
    if (!callout) return;
    
    const followName = document.getElementById('followName');
    const followStage = document.getElementById('followStageBtn');
    
    if (!followName || !followStage) return;
    if (!followName.value.trim()) {
      alert('Please enter a name');
      return;
    }
    
    try {
      const response = await fetch(`http://localhost:3001/api/callouts/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          ...callout,
          follow: {
            name: followName.value.trim(),
            stage: followStage.textContent
          },
          editedBy: localStorage.getItem('userName') || 'You'
        })
      });
      
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }
      
      console.log('Follow-on submitted successfully');
      
      // Refresh the callout
      const updatedResponse = await fetch(`http://localhost:3001/api/callouts/${id}`);
      if (updatedResponse.ok) {
        const updatedCallout = await updatedResponse.json();
        callouts[id] = updatedCallout;
        
        // Update UI
        const bubble = document.getElementById('callout_' + id);
        if (bubble) {
          bubble.remove();
          createBubble(updatedCallout, true);
        }
      }
    } catch (error) {
      console.error('Error submitting follow-on:', error);
      alert('Error submitting follow-on: ' + error.message);
    }
  }
  
  // ------ Socket.io Event Listeners ------
  socket.on('new_callout', function(callout) {
    console.log("New callout received:", callout);
    callouts[callout._id] = callout;
    createBubble(callout, false);
  });
  
  socket.on('update_callout', function(callout) {
    console.log("Updated callout received:", callout);
    callouts[callout._id] = callout;
    let old = document.getElementById('callout_'+callout._id);
    if (old) old.remove();
    createBubble(callout, false);
  });
  
  socket.on('delete_callout', function(id) {
    console.log("Delete callout received:", id);
    let old = document.getElementById('callout_'+id);
    if (old) old.remove();
    delete callouts[id];
  });
  
  // ------ Initialize All Event Handlers ------
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded - initializing event handlers");
    
    // Dashboard button (top bar)
    const dashboardBtn = document.getElementById('dashboardBtn');
    if (dashboardBtn) {
      dashboardBtn.addEventListener('click', goDashboard);
      console.log("Dashboard button handler attached");
    }
    
    // Join Room button (top bar)
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    if (joinRoomBtn) {
      joinRoomBtn.addEventListener('click', openRoomModal);
      console.log("Join Room button handler attached");
    }
    
    // Logout button (sidebar)
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', logout);
      console.log("Logout button handler attached");
    }
    
    // Close Room Modal button
    const closeRoomModalBtn = document.getElementById('closeRoomModalBtn');
    if (closeRoomModalBtn) {
      closeRoomModalBtn.addEventListener('click', closeRoomModal);
      console.log("Close Room Modal button handler attached");
    }
    
    // Join Room Form submission
    const joinRoomForm = document.getElementById('joinRoomForm');
    if (joinRoomForm) {
      joinRoomForm.addEventListener('submit', function(e) {
        e.preventDefault();
        handleJoinRoomForm(this);
      });
      console.log("Join Room form handler attached");
    }
    
    // Join Room Button in modal
    const joinRoomButton = document.getElementById('joinRoomButton');
    if (joinRoomButton) {
      joinRoomButton.addEventListener('click', function() {
        document.getElementById('joinRoomForm').dispatchEvent(new Event('submit'));
      });
      console.log("Join Room Button handler attached");
    }
    
    // Log Form submission
    const logForm = document.getElementById('logForm');
    if (logForm) {
      logForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitLogForm(this);
      });
      console.log("Log form handler attached");
    }
    
    // Activity textarea auto-grow
    const activityTextarea = document.getElementById('activityTextarea');
    if (activityTextarea) {
      activityTextarea.addEventListener('input', function() {
        autoGrow(this);
      });
      console.log("Activity textarea handler attached");
    }
    
    // Create Follow button handler
    const createFollowBtn = document.querySelector('#followContainer button');
    if (createFollowBtn) {
      createFollowBtn.addEventListener('click', function() {
        window.openFollow();
      });
      console.log("Create Follow button handler attached");
    }
    
    console.log("Event handlers attached, page ready.");
  });
</script>
  
  // Commented out redundant code - we're using the proper event listeners in the DOMContentLoaded event handler above
  /*
  const joinButton = document.getElementById('joinRoomButton');
  if (joinButton) {
    joinButton.onclick = async function() {
      // This code is now handled by the event listener in the DOMContentLoaded event
    };
  }
  */

  // Move all event handlers into DOMContentLoaded
  // Removed redundant DOMContentLoaded event listener - we're already using one above

  // Edit / History / QC / Delete overlays
  // Make these functions globally accessible
  window.showCalloutMenu = function(e, btn, id) {
    e.stopPropagation();
    let data = callouts[id];
    // Modal content
    let html = `
      <button class="modal-close" onclick="closeCalloutMenu()">&times;</button>
      <div style="margin-bottom:19px; font-size:1.1em; color:var(--logo-color); font-weight:600;">
        Callout Options
      </div>
      <button class="submit-btn" style="width:100%; margin-bottom:10px;" onclick="editCallout('${id}')">Edit</button>
      <button class="submit-btn" style="width:100%; background:var(--inactive); margin-bottom:10px;" onclick="calloutHistory('${id}')">History</button>
      <button class="submit-btn" style="width:100%; background:var(--qc-yellow); color:#111; margin-bottom:10px;" onclick="calloutQC('${id}', 'qc-yellow')">QC: Yellow</button>
      <button class="submit-btn" style="width:100%; background:var(--qc-green); color:#111; margin-bottom:10px;" onclick="calloutQC('${id}', 'qc-green')">QC: Green</button>
      <button class="submit-btn" style="width:100%; background:var(--qc-orange); color:#111; margin-bottom:10px;" onclick="calloutQC('${id}', 'qc-orange')">QC: Orange</button>
      <button class="submit-btn" style="width:100%; background:var(--qc-red); color:#fff; margin-bottom:10px;" onclick="calloutQC('${id}', 'qc-red')">QC: Red</button>
      <button class="submit-btn" style="width:100%; background:var(--qc-red); color:#fff;" onclick="deleteCallout('${id}')">Delete</button>
    `;
    document.getElementById('calloutMenuContent').innerHTML = html;
    document.getElementById('calloutMenuModal').style.display='flex';
    window._selectedCalloutId = id;
  };
  
  window.closeCalloutMenu = function() { 
    document.getElementById('calloutMenuModal').style.display='none'; 
    window._selectedCalloutId = null; 
  };

  window.editCallout = async function(id) {
    window.closeCalloutMenu();
    let data = callouts[id];
    // Open overlay with form (reuse your original form fields)
    let html = `<button class="modal-close" onclick="closeEditCallout()">&times;</button>
    <div style="font-weight:600; color:var(--logo-color); font-size:1.2em; margin-bottom:10px;">Edit Callout</div>
    <form id="editForm">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:13px;">
        <input type="text" name="classification" value="${data.classification||''}" required placeholder="Classification"/>
        <input type="text" name="asset" value="${data.asset||''}" required placeholder="Asset"/>
        <input type="text" name="sensor" value="${data.sensor||''}" required placeholder="Sensor"/>
        <input type="text" name="operation" value="${data.operation||''}" required placeholder="Operation"/>
        <input type="text" name="countryCode" value="${data.countryCode||''}" maxlength="3" placeholder="Country Code"/>
        <input type="text" name="team" value="${data.team||''}" placeholder="Team"/>
        <input type="time" name="zulu" value="${data.zulu||''}" required placeholder="Zulu Time"/>
        <input type="text" name="mgrs" value="${data.mgrs||''}" placeholder="MGRS"/>
        <input type="text" name="location" value="${data.location||''}" placeholder="Location"/>
        <textarea name="activity" rows="1" oninput="autoGrow(this)">${data.activity||''}</textarea>
        <input type="number" name="males" min="0" value="${data.males||''}" placeholder="Males"/>
        <input type="number" name="females" min="0" value="${data.females||''}" placeholder="Females"/>
        <input type="number" name="children" min="0" value="${data.children||''}" placeholder="Children"/>
        <input type="number" name="vehicles" min="0" value="${data.vehicles||''}" placeholder="Vehicles"/>
        <textarea name="iaNotes" rows="1" oninput="autoGrow(this)">${data.iaNotes||''}</textarea>
      </div>
      <div style="margin-top:12px;">
        <label>Follow Name</label>
        <input type="text" name="followName" value="${data.follow?.name||''}"/>
        <label style="margin-left:12px;">Follow Stage</label>
        <input type="text" name="followStage" value="${data.follow?.stage||''}"/>
      </div>
      <button type="submit" class="submit-btn" style="margin-top:16px;">Save</button>
    </form>`;
    document.getElementById('calloutMenuContent').innerHTML = html;
    document.getElementById('calloutMenuModal').style.display='flex';
    document.getElementById('editForm').onsubmit = async function(e){
      e.preventDefault();
      let payload = Object.fromEntries(new FormData(this));
      let follow = { 
        name: payload.followName, 
        stage: payload.followStage,
        followId: callouts[id].follow?.followId || Math.random().toString(36).substr(2, 6).toUpperCase(),
        ended: (payload.followStage === "END") || callouts[id].follow?.ended || false
      };
      delete payload.followName; delete payload.followStage;
      const res = await fetch(`http://localhost:3001/api/callouts/${id}`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          ...callouts[id],
          ...payload,
          follow,
          editedBy: localStorage.getItem('userName') || "You"
        })
      });
      const log = await res.json();
      callouts[log._id] = log;
      let old = document.getElementById('callout_'+log._id);
      if (old) old.remove();
      createBubble(log, false);
      window.closeEditCallout();
    }
  };
  
  window.closeEditCallout = function() { 
    document.getElementById('calloutMenuModal').style.display='none'; 
  };

  window.calloutHistory = async function(id) {
    window.closeCalloutMenu();
    let res = await fetch(`http://localhost:3001/api/callouts/${id}/history`);
    let history = await res.json();
    let html = `<button class="modal-close" onclick="closeEditCallout()">&times;</button>
      <div style="font-weight:600; color:var(--logo-color); font-size:1.2em; margin-bottom:8px;">Callout History</div>`;
    if (!history.length) html += "<div>No history found for this callout.</div>";
    else {
      history.reverse().forEach((h, idx) => {
        html += `<div style="margin-bottom:10px;border-bottom:1px solid #444;padding-bottom:7px;">
          <b>Edited by:</b> ${h.editedBy || "Unknown"}<br>
          <b>Edited at:</b> ${new Date(h.editedAt).toLocaleString()}<br>
          <b>Changes:</b> <pre style="background:#181d21;border-radius:6px;padding:7px 12px;color:#efefef;overflow-x:auto;">${JSON.stringify(h.changes, null, 2)}</pre>
        </div>`;
      });
    }
    document.getElementById('calloutMenuContent').innerHTML = html;
    document.getElementById('calloutMenuModal').style.display='flex';
  };

  window.calloutQC = async function(id, qc) {
    let res = await fetch(`http://localhost:3001/api/callouts/${id}`,{
      method:'PUT', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ...callouts[id], qc, editedBy: localStorage.getItem('userName') || "You" })
    });
    window.closeCalloutMenu();
  };
  
  window.deleteCallout = async function(id) {
    await fetch(`http://localhost:3001/api/callouts/${id}`, {method:'DELETE'});
    window.closeCalloutMenu();
  };

  // Follow logic - making these functions globally accessible
  let followStageOrder = ["START", "STOP 1", "STOP 2", "END"];
  
  // Assign functions to window object to make them globally accessible
  window.openFollow = function() {
    // Generate a random follow ID (6 characters, uppercase)
    const followId = Math.random().toString(36).substr(2, 6).toUpperCase();
    
    const fc = document.getElementById('followContainer');
    fc.innerHTML = `
      <div class="follow-section" id="followSection">
        <div class="follow-row">
          <label style="margin-bottom:0;">Follow Name</label>
          <input type="text" id="followName" style="flex:1; min-width:120px;"/>
          <button type="button" class="stage-btn" id="followStageBtn">START</button>
        </div>
        <div class="follow-row" style="font-size:0.9em; color:#88a8c9; margin-top:-5px; margin-bottom:5px;">
          <span>Follow ID: #${followId}</span>
        </div>
        <div class="follow-row follow-actions">
          <button type="button" class="action-btn" onclick="followContinue()">Continue</button>
          <button type="button" class="action-btn" onclick="followAdvance()">Advance</button>
          <button type="button" class="action-btn" onclick="followEnd()">End</button>
        </div>
      </div>
    `;
    window.followState = { 
      stage: 0, 
      cont: false, 
      ended: false,
      followId: followId
    };
    window.updateFollowStageBtn();
  };
  
  window.followContinue = function() {
    if(window.followState.ended) return;
    window.followState.cont = true;
    window.updateFollowStageBtn();
  };
  
  window.followAdvance = function() {
    if(window.followState.ended) return;
    if(window.followState.stage < 3) window.followState.stage++;
    window.followState.cont = false;
    window.updateFollowStageBtn();
  };
  
  window.followEnd = function() {
    window.followState.stage = 3; // "END"
    window.followState.cont = false;
    window.followState.ended = true;
    window.updateFollowStageBtn();
    document.getElementById('followStageBtn').disabled = true;
    
    // Mark visually
    const stageBtn = document.getElementById('followStageBtn');
    if (stageBtn) {
      stageBtn.style.opacity = "0.6";
      stageBtn.title = "Follow ended";
    }
  };
  
  window.updateFollowStageBtn = function() {
    let text = followStageOrder[window.followState.stage];
    if(window.followState.cont && window.followState.stage < 3) text += " CONT.";
    document.getElementById('followStageBtn').textContent = text;
  };

  // Prefill zulu
  document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const zuluTime = now.toISOString().substr(11, 5);
    const zuluInput = document.querySelector('input[name="zulu"]');
    if (zuluInput && !zuluInput.value) zuluInput.value = zuluTime;
    window.followState = null;
    
    // Add a version timestamp to force refresh if needed
    localStorage.setItem('opsLogVersion', '1.1');
  });
  
  // Function to force a hard refresh - can be useful to clear cache
  function forceRefresh() {
    localStorage.setItem('forceRefresh', 'true');
    window.location.reload(true);
  }

  // Sidebar Navigation
  function goDashboard() { window.location.href = '/dashboard.html'; }
  function openMyLogs() { /* Implement as needed */ }
  function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('role');
    localStorage.removeItem('userName');
    localStorage.removeItem('classId');
    window.location.replace('/login.html');
  }

  // Close modals on outside click
  window.onclick = function(e){
    if(e.target.classList && e.target.classList.contains('modal')) {
      e.target.style.display='none';
    }
  }
  
  // Socket.io event listeners already defined above - removing duplicates
</script>
</body>
</html>