<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ops Log - SMXKITS</title>
  <style>
    :root {
      --bg: #1e1e1e;
      --panel: #23272e;
      --sidebar: #20232a;
      --accent: #22c55e;
      --inactive: #3b3b3b;
      --hover: #262a32;
      --qc-orange: #ff9800;
      --qc-yellow: #ffe066;
      --qc-green: #22c55e;
      --qc-red: #ef4444;
      --bubble-bg: #141414;
      --bubble-text: #fafafa;
      --button-bg: #23272e;
      --button-hover: #31363f;
      --input-bg: #252a33;
      --input-border: #333c48;
      --logo-color: #22c55e;
      --follow-blue: #3b82f6;
      --follow-blue-dark: #2563eb;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--bubble-text);
      min-height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Sidebar */
    .sidebar {
      width: 480px;
      background: var(--sidebar);
      padding: 28px 18px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      box-sizing: border-box;
      border-right: 2px solid var(--inactive);
      overflow-y: auto;
    }
    .logo {
      font-size: 1.8em;
      font-weight: bold;
      letter-spacing: 2px;
      color: var(--logo-color);
      margin-bottom: 12px;
    }
    .nav {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .nav-btn {
      background: var(--button-bg);
      border: none;
      color: #fafafa;
      font-size: 1.07em;
      padding: 11px 16px;
      margin: 0;
      text-align: left;
      border-radius: 7px;
      cursor: pointer;
      transition: background 0.2s;
      outline: none;
    }
    .nav-btn:hover, .nav-btn.active {
      background: var(--button-hover);
    }
    .divider {
      height: 1px;
      background: var(--inactive);
      margin: 16px 0 12px 0;
      border-radius: 2px;
    }
    .room-status {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      padding: 15px 14px;
      font-size: 0.98em;
      margin-bottom: 12px;
      color: #e5e7eb;
      line-height: 1.5;
    }
    .logout-btn {
      margin-top: auto;
      background: var(--qc-red);
      color: #fff;
      border: none;
      font-size: 1.06em;
      padding: 12px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .logout-btn:hover { background: #be2121; }

    /* Main */
    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--panel);
      overflow: hidden;
    }
    .top-bar {
      height: 58px;
      background: var(--sidebar);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 30px;
      border-bottom: 2px solid var(--inactive);
      font-size: 1.1em;
      letter-spacing: 1px;
      color: #a9d4c6;
      font-weight: 500;
      z-index: 2;
    }
    .feed-panel {
      flex: 1;
      overflow-y: auto;
      padding: 36px 80px 22px 36px; /* Increased horizontal padding */
      background: var(--panel);
      display: flex;
      flex-direction: column;
      gap: 28px;
      min-height: 0;
      max-height: calc(100vh - 58px); /* Subtract the top-bar height */
      scrollbar-width: thin;
      scrollbar-color: var(--inactive) transparent;
    }

    /* Log Bubbles */
    .bubble {
      background: var(--bubble-bg);
      color: var(--bubble-text);
      border: 2.5px solid var(--inactive);
      border-radius: 18px;
      box-shadow: 0 4px 28px #00000045;
      padding: 24px 34px 19px 24px;
      position: relative;
      transition: border-color 0.22s, box-shadow 0.22s, transform 0.15s;
      min-width: 500px;
      max-width: 1000px;
      width: 95%;
      word-break: break-word;
      white-space: pre-line;
      font-size: 1.06em;
    }
    .bubble:hover {
      box-shadow: 0 5px 30px #00000060;
      transform: translateY(-1px);
    }
    .bubble.qc-orange { border-color: var(--qc-orange);}
    .bubble.qc-yellow { border-color: var(--qc-yellow);}
    .bubble.qc-green  { border-color: var(--qc-green);}
    .bubble.qc-red    { border-color: var(--qc-red);}
    .bubble-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 40px; } 
    .bubble-left, .bubble-right { display: flex; flex-direction: column; gap: 8px; } 
    .bubble-left { flex: 1; width: 70%; } /* Increased width for left section */
    .bubble-row { margin-bottom: 3px; } 
    .bubble-right { 
      align-items: flex-end; 
      min-width: 220px; 
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace; 
      background: rgba(20, 20, 20, 0.3);
      padding: 10px 15px;
      border-radius: 8px;
    } /* Increased min-width and added styling */
    .bubble-right .bubble-time { font-weight: bold; font-size: 1.4em; color: var(--logo-color); }
    .bubble-right span { margin-bottom: 3px; }
    .bubble .menu-btn {
      position: absolute;
      top: 14px;
      right: -46px;
      background: rgba(35, 39, 46, 0.9);
      border: 1px solid var(--inactive);
      cursor: pointer;
      color: #a7a7a7;
      font-size: 1.56em;
      z-index: 3;
      padding: 0;
      border-radius: 50%;
      width: 38px; height: 38px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s, color 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .bubble .qc-btn {
      position: absolute;
      top: 58px; /* Position below the menu button */
      right: -46px;
      background: rgba(35, 39, 46, 0.9);
      border: 1px solid var(--inactive);
      cursor: pointer;
      color: #a7a7a7;
      font-size: 0.9em;
      font-weight: bold;
      z-index: 3;
      padding: 0;
      border-radius: 50%;
      width: 38px; height: 38px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s, color 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .bubble .menu-btn:hover { background: var(--hover); color: var(--logo-color); }
    .bubble .qc-btn:hover { background: var(--hover); color: var(--logo-color); }
    .bubble .callout-meta {
      font-size: 0.98em;
      color: #b9c6c7;
      margin-bottom: 6px;
    }

    /* Form - Form is now in sidebar, so this style is kept for reference but not actively used */
    .form-panel {
      width: 100%;
      background: var(--sidebar);
      border-top: 2px solid var(--inactive);
      padding: 25px 28px;
      display: flex;
      flex-direction: column;
      gap: 17px;
      z-index: 3;
    }
    .form-title {
      font-size: 1.2em;
      font-weight: 600;
      color: var(--logo-color);
      letter-spacing: 1px;
      margin-bottom: 7px;
    }
    .fields-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px 24px;
      align-items: flex-start;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    label {
      font-size: 0.97em;
      color: #c2cbd1;
      font-weight: 500;
    }
    input, select, textarea {
      background: linear-gradient(90deg, #23272e 60%, #252a33 100%);
      color: #f5f6f7;
      border: 2px solid var(--input-border);
      border-radius: 11px;
      font-size: 1.08em;
      padding: 13px 16px;
      outline: none;
      box-shadow: 0 2px 8px #10121740;
      transition: border-color 0.18s, box-shadow 0.18s, background 0.18s;
      min-height: 44px;
      font-family: inherit;
      margin-bottom: 1px;
      width: 100%;
      resize: none;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      background: linear-gradient(90deg, #23272e 10%, #28322e 100%);
      box-shadow: 0 0 0 2px var(--accent);
    }
    input[readonly], textarea[readonly] {
      background: #23272e70;
      color: #9fa8ac;
      cursor: not-allowed;
    }
    textarea {
      min-height: 70px;
      max-height: 350px;
      overflow: auto;
      resize: vertical;
      line-height: 1.6;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    ::placeholder {
      color: #9fa8ac;
      opacity: 0.85;
      font-size: 0.98em;
    }
    select {
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="16" viewBox="0 0 20 20" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M7.293 8.293l3.293 3.293 3.293-3.293 1.414 1.414-4.707 4.707-4.707-4.707z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 34px;
    }
    .submit-btn {
      background: var(--accent);
      color: #fff;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      font-size: 1.13em;
      padding: 14px;
      margin-top: 10px;
      cursor: pointer;
      transition: background 0.18s;
      box-shadow: 0 1px 10px #00000017;
    }
    .submit-btn:hover { background: #28dd6c; }
    /* Custom hover for Create Follow button to maintain orange theme */
    #createFollowBtn:hover { background: #ffb03b !important; }

    /* Follow Section */
    .follow-section {
      background: var(--panel);
      border: 1.5px solid var(--input-border);
      border-radius: 10px;
      margin-top: 7px;
      padding: 18px 18px 13px 18px;
      display: flex;
      flex-direction: column;
      gap: 13px;
      animation: fadeIn 0.25s;
    }
    .follow-row {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    /* Removed unused follow action styling */

    /* Overlay/Modal */
    .modal {
      position: fixed;
      z-index: 30;
      left: 0; top: 0; right: 0; bottom: 0;
      background: #181e22e9;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.22s;
    }
    .modal-content {
      background: var(--sidebar);
      color: #f5f6f7;
      padding: 34px 38px 32px 38px;
      border-radius: 14px;
      min-width: 400px;
      max-width: 98vw;
      box-shadow: 0 10px 60px #00000069;
      position: relative;
      font-size: 1.08em;
    }
    .modal-close {
      position: absolute;
      top: 12px; right: 18px;
      background: none;
      color: #ccc;
      border: none;
      font-size: 1.4em;
      cursor: pointer;
      transition: color 0.16s;
    }
    .modal-close:hover { color: var(--qc-red); }

    /* Follow Indicator Styles */
    .bubble.has-follow {
      position: relative;
      padding-left: 30px; /* Make room for the indicator */
    }
    
    .follow-indicator {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 20px;
      background: var(--follow-blue);
      border-top-left-radius: 18px;
      border-bottom-left-radius: 18px;
      opacity: 0.85;
      transition: background-color 0.2s;
    }
    
    .follow-indicator.follow-ended {
      background: var(--follow-blue-dark);
      opacity: 0.5;
    }
    
    .follow-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .follow-id {
      font-size: 0.85em;
      color: var(--follow-blue);
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    /* Scrollbars */
    ::-webkit-scrollbar { width: 10px; background: #17181a;}
    ::-webkit-scrollbar-thumb { background: #22262b; border-radius: 6px;}
    ::-webkit-scrollbar-thumb:hover { background: #363b40;}
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar with form -->
    <aside class="sidebar">
      <div class="logo">SMXKITS</div>
      <div class="divider"></div>

      <!-- Callout Form moved to sidebar -->
      <form id="logForm" autocomplete="off" style="margin-top: 10px;">
        <div class="form-title" style="font-size: 1.1em; margin-bottom: 12px;">Submit New Callout</div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Classification</label>
          <select name="classification" required>
            <option value="">Select</option>
            <option>No Classification</option>
          </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Asset Name</label>
          <input type="text" name="asset" required/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Sensor</label>
          <select name="sensor" required>
            <option value="FMV">FMV</option>
          </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Mission / Operation</label>
          <input type="text" name="operation" value="OBJ" required/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Country Code</label>
          <input type="text" name="countryCode" maxlength="3"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Team Name</label>
          <input type="text" name="team"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Zulu Time</label>
          <input type="text" name="zulu" required placeholder="HHMM" pattern="[0-9]{4}" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '');"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>MGRS</label>
          <input type="text" name="mgrs"/>
        </div>
        
        <!-- Follow container moved here -->
        <div id="followContainer" style="margin-bottom: 12px;">
          <button type="button" id="createFollowBtn" class="submit-btn" style="margin-bottom: 0; background:var(--qc-orange); color:#181c1c; font-weight:600; width: 100%;">Create Follow</button>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Location Description</label>
          <input type="text" name="location"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Activity</label>
          <textarea id="activityTextarea" name="activity" rows="1"></textarea>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Males</label>
          <input type="number" name="males" min="0"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Females</label>
          <input type="number" name="females" min="0"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Children</label>
          <input type="number" name="children" min="0"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>Vehicles</label>
          <input type="number" name="vehicles" min="0"/>
        </div>
        
        <div class="form-group" style="margin-bottom: 12px;">
          <label>IA Notes</label>
          <textarea name="iaNotes" rows="1" oninput="autoGrow(this)"></textarea>
        </div>
        
        <button type="submit" class="submit-btn" style="width: 100%;">Submit</button>
      </form>
      
      <button id="logoutBtn" class="logout-btn" style="margin-top: 20px;">Logout</button>
    </aside>

    <!-- Main -->
    <main class="main-panel">
      <div class="top-bar" id="mainTopBar">
        <!-- Room information and navigation buttons in top bar -->
        <div style="flex: 1; display: flex; align-items: center;">
          <span style="font-weight: bold; margin-right: 15px;">OPS LOG</span>
          <button id="joinRoomBtn" class="nav-btn" style="margin:0 20px;">Join Room</button>
          &mdash; 
          <div style="margin-left: 10px; display: flex; align-items: center;">
            <span>Class: <span id="currentClass" style="font-weight: 500; color: #a9d4c6;">-</span></span>
            <span style="margin: 0 10px;">|</span>
            <span>Team: <span id="currentTeam" style="font-weight: 500; color: #a9d4c6;">-</span></span>
            <span style="margin: 0 10px;">|</span>
            <span>Mission: <span id="currentMission" style="font-weight: 500; color: #a9d4c6;">-</span></span>
          </div>
        </div>
        <button id="dashboardBtn" class="nav-btn" style="margin-left:24px;">Dashboard</button>
      </div>

      <section class="feed-panel" id="feedPanel">
        <!-- Generated log/chat bubbles will appear here -->
      </section>
    </main>
  </div>

  <!-- Room Modal -->
  <div id="roomModal" class="modal" style="display:none;">
    <div class="modal-content">
      <button id="closeRoomModalBtn" class="modal-close">&times;</button>
      <div style="font-weight:600; color:var(--logo-color); font-size:1.2em; margin-bottom:16px;">Join a Room</div>
      <form id="joinRoomForm">
        <div class="form-group" style="margin-bottom: 15px;">
          <label>Team</label>
          <select name="team" id="modalTeam" required>
            <option value="">Select Team</option>
            <option>Alpha Team</option><option>Bravo Team</option><option>Charlie Team</option>
            <option>Delta Team</option><option>Echo Team</option><option>Foxtrot Team</option>
            <option>Golf Team</option><option>Hotel Team</option><option>India Team</option>
            <option>Juliett Team</option><option>Kilo Team</option><option>Lima Team</option>
            <option>Mike Team</option><option>November Team</option><option>Oscar Team</option>
            <option>Papa Team</option><option>Quebec Team</option><option>Romeo Team</option>
            <option>Sierra Team</option><option>Tango Team</option><option>Uniform Team</option>
            <option>Victor Team</option><option>Whiskey Team</option><option>X-ray Team</option>
            <option>Yankee Team</option><option>Zulu Team</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label>Mission</label>
          <select name="mission" id="modalMission" required>
            <option value="">Select Mission</option>
            <!-- Populate 30 missions -->
            <option>Mission 1</option><option>Mission 2</option><option>Mission 3</option>
            <option>Mission 4</option><option>Mission 5</option><option>Mission 6</option>
            <option>Mission 7</option><option>Mission 8</option><option>Mission 9</option>
            <option>Mission 10</option><option>Mission 11</option><option>Mission 12</option>
            <option>Mission 13</option><option>Mission 14</option><option>Mission 15</option>
            <option>Mission 16</option><option>Mission 17</option><option>Mission 18</option>
            <option>Mission 19</option><option>Mission 20</option><option>Mission 21</option>
            <option>Mission 22</option><option>Mission 23</option><option>Mission 24</option>
            <option>Mission 25</option><option>Mission 26</option><option>Mission 27</option>
            <option>Mission 28</option><option>Mission 29</option><option>Mission 30</option>
          </select>
        </div>
        <button type="button" id="joinRoomButton" class="submit-btn" style="margin-top:18px;">Join Room</button>
      </form>
    </div>
  </div>

  <!-- Callout Menu Modal -->
  <div id="calloutMenuModal" class="modal" style="display:none;">
    <div class="modal-content" id="calloutMenuContent">
      <!-- Content filled by JS -->
    </div>
  </div>

  <!-- Change History Overlay -->
  <div id="historyOverlay" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" onclick="closeHistoryOverlay()">&times;</button>
      <div style="font-weight:600; color:var(--logo-color); font-size:1.2em; margin-bottom:10px;">Change History</div>
      <div id="historyLogContainer" style="max-height:60vh; overflow:auto; font-size:0.95em;"></div>
    </div>
  </div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
  // ------ Global State ------
  let currentRoom = { classId: null, team: null, mission: null };
  // Connect to socket.io server, using same host as current page
  let socket = io(window.location.hostname === 'localhost' ? 'http://localhost:3001' : '');
  let callouts = {}; // id -> callout
  
  // Initialize updateSidebarButtonStates function early
  function updateSidebarButtonStates() {
    const editCalloutBtn = document.getElementById('editCalloutBtn');
    const viewHistoryBtn = document.getElementById('viewHistoryBtn');
    
    const hasCallouts = callouts && Object.keys(callouts).length > 0;
    
    if (editCalloutBtn) {
      editCalloutBtn.disabled = !hasCallouts;
      editCalloutBtn.title = hasCallouts ? 'Edit most recent callout' : 'No callouts available to edit';
      editCalloutBtn.style.opacity = hasCallouts ? '1' : '0.6';
      editCalloutBtn.style.cursor = hasCallouts ? 'pointer' : 'not-allowed';
    }
    
    if (viewHistoryBtn) {
      viewHistoryBtn.disabled = !hasCallouts;
      viewHistoryBtn.title = hasCallouts ? 'View history of most recent callout' : 'No callout history available';
      viewHistoryBtn.style.opacity = hasCallouts ? '1' : '0.6';
      viewHistoryBtn.style.cursor = hasCallouts ? 'pointer' : 'not-allowed';
    }
  }
  
  // Helper for growing textareas
  function autoGrow(el) {
    el.style.height = '38px';
    el.style.height = (el.scrollHeight)+'px';
  }
  
  // ------ Core UI Functions ------
  function openRoomModal() { 
    console.log("Opening room modal");
    document.getElementById('roomModal').style.display = 'flex'; 
  }
  
  function closeRoomModal() { 
    console.log("Closing room modal");
    document.getElementById('roomModal').style.display = 'none'; 
  }
  
  function closeCalloutMenu() {
    console.log("Closing callout menu");
    document.getElementById('calloutMenuModal').style.display = 'none';
  }
  
  function goDashboard() {
    console.log("Navigating to dashboard");
    window.location.href = '/dashboard.html';
  }
  
  function logout() {
    console.log("Logging out");
    localStorage.removeItem('token');
    localStorage.removeItem('userName');
    window.location.href = '/login.html';
  }
  
  // ------ Form Handling Functions ------
  async function handleJoinRoomForm(form) {
    try {
      console.log("Join Room form submitted");
      
      const teamSelect = document.getElementById('modalTeam');
      const missionSelect = document.getElementById('modalMission');
      
      // Validate form fields
      if (!teamSelect.value) {
        alert("Please select a team");
        return;
      }
      if (!missionSelect.value) {
        alert("Please select a mission");
        return;
      }
      
      // Join room
      let classId = "SMX";
      let team = teamSelect.value;
      let mission = missionSelect.value;
      
      console.log("Selected values:", { classId, team, mission });
      
      currentRoom = { classId, team, mission };
      let roomId = classId + "_" + team + "_" + mission;
      socket.emit('join_room', roomId);
      
      document.getElementById('currentClass').textContent = classId;
      document.getElementById('currentTeam').textContent = team;
      document.getElementById('currentMission').textContent = mission;
      
      closeRoomModal();
      await loadCallouts(roomId);
    } catch (error) {
      console.error("Error joining room:", error);
      alert("Error joining room: " + error.message);
    }
  }
  
  async function submitLogForm(form) {
    if(!currentRoom.classId) {
      alert('Join a room first.');
      return;
    }
    
    try {
      console.log("Log form submitted");
      const data = Object.fromEntries(new FormData(form));
let follow = undefined;
// Check if follow information is being provided
if (document.getElementById('followNameInput') && document.getElementById('followStageSelect')) {
  const followName = document.getElementById('followNameInput').value;
  const followStage = document.getElementById('followStageSelect').value;
  const followId = document.getElementById('followIdDisplay') ? 
    document.getElementById('followIdDisplay').textContent : 
    Math.random().toString(36).substr(2, 6).toUpperCase();
    
  if (followName && followStage) {
    follow = {
      name: followName,
      stage: followStage,
      followId: followId,
      ended: followStage === 'END'
    };
  }
}
      
      const payload = {
        ...data,
        roomId: currentRoom.classId + "_" + currentRoom.team + "_" + currentRoom.mission,
        follow,
        createdBy: localStorage.getItem('userName') || "You"
      };
      
      const response = await fetch('/api/callouts', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }
      
      const log = await response.json();
      callouts[log._id] = log;
      createBubble(log, false);
      
      // Clear form
      form.reset();
      const textareas = form.querySelectorAll('textarea');
      textareas.forEach(ta => ta.style.height = 'auto');
      
      // Flash animation
      const bubble = document.getElementById('callout_' + log._id);
      if (bubble) {
        bubble.style.animation = 'none';
        bubble.offsetHeight; /* trigger reflow */
        bubble.style.animation = 'flash 1.5s';
      }
    } catch (error) {
      console.error("Error submitting callout:", error);
      alert("Error submitting callout: " + error.message);
    }
  }
  
  // ------ Data Loading Functions ------
  async function loadCallouts(roomId) {
    try {
      console.log("Loading callouts for room:", roomId);
      
      // Consistent API URL handling
      const apiUrl = window.location.hostname === 'localhost' 
        ? `http://localhost:3001/api/callouts/${roomId}`
        : `/api/callouts/${roomId}`;
        
      const response = await fetch(apiUrl, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }
      
      const logs = await response.json();
      console.log("Callouts loaded:", logs);
      
      callouts = {};
      const feedPanel = document.getElementById('feedPanel');
      feedPanel.innerHTML = '';
      
      // Add tip about double-clicking
      const tipDiv = document.createElement('div');
      tipDiv.style.textAlign = 'center';
      tipDiv.style.padding = '8px 12px';
      tipDiv.style.marginBottom = '15px';
      tipDiv.style.background = 'rgba(34, 197, 94, 0.1)';
      tipDiv.style.borderRadius = '8px';
      tipDiv.style.color = '#a9d4c6';
      tipDiv.style.fontSize = '0.95em';
      tipDiv.style.border = '1px dashed rgba(34, 197, 94, 0.3)';
      tipDiv.innerHTML = '<i>Tip: Double-click any callout to edit it quickly</i>';
      feedPanel.appendChild(tipDiv);
      
      // Sort logs by zulu time (latest time first)
      logs.sort((a, b) => {
        // Parse zulu times (in HHMM format)
        let timeA = a.zulu || '0000';
        let timeB = b.zulu || '0000';
        
        // Convert to numbers for comparison (HHMM as a 4-digit number)
        // Make sure we handle both old HH:MM format and new HHMM format
        let valueA, valueB;
        
        if (timeA.includes(':')) {
          // Old format - convert HH:MM to a number
          let [hoursA, minutesA] = timeA.split(':').map(Number);
          valueA = hoursA * 100 + minutesA;
        } else {
          // New format - already a 4-digit number as string
          valueA = parseInt(timeA, 10);
        }
        
        if (timeB.includes(':')) {
          // Old format - convert HH:MM to a number
          let [hoursB, minutesB] = timeB.split(':').map(Number);
          valueB = hoursB * 100 + minutesB;
        } else {
          // New format - already a 4-digit number as string
          valueB = parseInt(timeB, 10);
        }
        
        // Compare the numeric values (higher number = later time)
        return valueB - valueA;
      });
      
      // Process logs in sorted order (latest zulu time to earliest)
      // This creates the reverse chronological display order by zulu time
      for(const log of logs) {
        callouts[log._id] = log;
        createBubble(log);
      }
      
      // Update sidebar button states based on callout availability
      updateSidebarButtonStates();
    } catch (error) {
      console.error("Error loading callouts:", error);
      alert("Error loading room data: " + error.message);
    }
  }
  
  // ------ UI Generation Functions ------
  window.createBubble = function(data, append=false) {
    try {
      const panel = document.getElementById('feedPanel');
      
      // Check if this bubble already exists (for updates)
      const existingBubble = document.getElementById('callout_' + data._id);
      if (existingBubble) {
        // Just update the existing bubble's class for QC status without moving it
        existingBubble.className = "bubble " + (data.qc || "qc-orange");
        if (data.follow && data.follow.name) {
          existingBubble.classList.add('has-follow');
        }
        // Update the bubble content without recreating it
        updateBubbleContent(existingBubble, data);
        return;
      }
      
      // This is a new bubble, create it from scratch
      const div = document.createElement('div');
      div.className = "bubble " + (data.qc || "qc-orange"); 
      div.id = 'callout_' + data._id;
      
      // Add double-click handler to open edit menu
      div.ondblclick = function() {
        editCallout(data._id);
      };
      div.style.cursor = 'pointer';
      div.title = 'Double-click to edit';
      
      // Create menu button with direct onclick attribute
      const menuBtn = document.createElement('button');
      menuBtn.className = "menu-btn";
      menuBtn.title = "Options";
      menuBtn.innerHTML = "&#8942;";
      menuBtn.setAttribute('onclick', `showCalloutMenu(event, this, '${data._id}')`);
      
      // Create QC button with direct onclick attribute
      const qcBtn = document.createElement('button');
      qcBtn.className = "qc-btn";
      qcBtn.title = "Quality Control";
      qcBtn.innerHTML = "QC";
      qcBtn.setAttribute('onclick', `showQCMenu(event, this, '${data._id}')`);
      
      // Add follow indicator if this callout has a follow
      const hasFollow = data.follow && data.follow.name;
      if (hasFollow) {
        div.classList.add('has-follow');
      }
      
      // Create the rest of the content
      const content = document.createElement('div');
      content.className = "bubble-flex";
      
      // If has follow, add the vertical indicator bar
      if (hasFollow) {
        const followIndicator = document.createElement('div');
        followIndicator.className = "follow-indicator";
        followIndicator.title = data.follow.followId || "Follow";
        
        // If follow is ended, add specific class
        if (data.follow.ended || data.follow.stage === "END") {
          followIndicator.classList.add('follow-ended');
        }
        
        div.appendChild(followIndicator);
      }
      
      content.innerHTML = `
        <div class="bubble-left"> 
          <div class="bubble-row"> 
            <span><b>${data.operation || '-'}</b></span> 
            <span style="margin: 0 9px; color: #444;">|</span> 
            <span><b>${data.asset || '-'}</b></span> 
          </div> 
          <div class="bubble-row">${data.location || '-'}</div> 
          ${ hasFollow ? `<div class="bubble-row follow-title">
            <b>${data.follow.name} / ${data.follow.stage}</b>
            ${data.follow.followId ? `<span class="follow-id">#${data.follow.followId}</span>` : ''}
          </div>` : '' } 
          <div class="bubble-row">${data.activity || '-'}</div> 
          <div class="bubble-row"><b>IA Notes:</b> ${(data.iaNotes||'').replace(/\n/g,'<br>')}</div> 
        </div> 
        <div class="bubble-right"> 
          <span class="bubble-time">${data.zulu || '-'}</span> 
          <span><b>MGRS:</b> <span style="letter-spacing: 0.5px; font-size: 1.05em;">${data.mgrs || '-'}</span></span> 
          <span><b>SLANT:</b> ${(data.males||0)}/${(data.females||0)}/${(data.children||0)} &nbsp; <b>V:</b> ${(data.vehicles||0)}</span> 
        </div>
      `;
      
      const footer = document.createElement('div');
      footer.style.fontSize = "0.85em";
      footer.style.color = "#888";
      footer.style.marginTop = "7px";
      footer.innerHTML = `By ${data.createdBy} &middot; ${(data.createdAt ? new Date(data.createdAt).toLocaleTimeString() : '')}`;
      
      // Assemble the bubble
      div.appendChild(menuBtn);
      div.appendChild(qcBtn);
      div.appendChild(content);
      div.appendChild(footer);
      div.dataset.payload = JSON.stringify(data);
      
      // Insert the new callout in the correct position based on zulu time
      if (data.zulu) {
        // Parse the new callout's zulu time
        let newTimeValue;
        
        // Handle both formats (old HH:MM and new HHMM)
        if (data.zulu.includes(':')) {
          // Old format
          const [newHours, newMinutes] = data.zulu.split(':').map(Number);
          newTimeValue = newHours * 100 + newMinutes;
        } else {
          // New format - already a 4-digit number as string
          newTimeValue = parseInt(data.zulu, 10);
        }
        
        // Check existing callouts to find the right position
        let inserted = false;
        const existingBubbles = panel.querySelectorAll('.bubble');
        
        // Skip the first element if it's the tip div
        for (let i = 0; i < existingBubbles.length; i++) {
          const bubble = existingBubbles[i];
          const bubbleId = bubble.id.replace('callout_', '');
          const bubbleData = callouts[bubbleId];
          
          if (bubbleData && bubbleData.zulu) {
            // Parse this bubble's zulu time
            let bubbleTimeValue;
            
            // Handle both formats
            if (bubbleData.zulu.includes(':')) {
              // Old format - convert HH:MM to a number
              const [bubbleHours, bubbleMinutes] = bubbleData.zulu.split(':').map(Number);
              bubbleTimeValue = bubbleHours * 100 + bubbleMinutes;
            } else {
              // New format - already a 4-digit number as string
              bubbleTimeValue = parseInt(bubbleData.zulu, 10);
            }
            
            // If new time is later than current bubble's time, insert before it
            if (newTimeValue > bubbleTimeValue) {
              panel.insertBefore(div, bubble);
              inserted = true;
              break;
            }
          }
        }
        
        // If we couldn't find a position or the feed is empty, append to the end
        if (!inserted) {
          panel.appendChild(div);
        }
      } else {
        // If no zulu time, add to the top as a fallback
        panel.prepend(div);
      }
      
      // Update sidebar button states after adding a new bubble
      updateSidebarButtonStates();
    } catch (error) {
      console.error("Error creating bubble:", error);
    }
  };
  
  // Helper function to format zulu time
  function formatZuluTime(zuluTime) {
    if (!zuluTime) return '-';
    
    // If it already contains a colon, it's in the old format
    if (zuluTime.includes(':')) {
      return zuluTime;
    }
    
    // For 4-digit format, insert a colon between hours and minutes
    // Handle both 3-digit and 4-digit cases
    if (zuluTime.length === 3) {
      // For 3 digits (e.g., "130" for 1:30), add leading zero
      return "0" + zuluTime.charAt(0) + ":" + zuluTime.substring(1);
    } else if (zuluTime.length === 4) {
      return zuluTime.substring(0, 2) + ":" + zuluTime.substring(2);
    }
    
    // Return as-is for any other format
    return zuluTime;
  }
  
  // Helper function to update existing bubble content without recreating the whole bubble
  function updateBubbleContent(bubble, data) {
    try {
      const hasFollow = data.follow && data.follow.name;
      
      // Find or create the bubble-flex content div
      let content = bubble.querySelector('.bubble-flex');
      if (!content) {
        content = document.createElement('div');
        content.className = "bubble-flex";
        bubble.appendChild(content);
      }
      
      // Update the indicator if needed
      if (hasFollow) {
        let indicator = bubble.querySelector('.follow-indicator');
        if (!indicator) {
          indicator = document.createElement('div');
          indicator.className = "follow-indicator";
          bubble.appendChild(indicator);
        }
        indicator.title = data.follow.followId || "Follow";
        indicator.classList.toggle('follow-ended', data.follow.ended || data.follow.stage === "END");
      } else {
        const indicator = bubble.querySelector('.follow-indicator');
        if (indicator) indicator.remove();
      }
      
      // Update the content HTML
      content.innerHTML = `
        <div class="bubble-left"> 
          <div class="bubble-row"> 
            <span><b>${data.operation || '-'}</b></span> 
            <span style="margin: 0 9px; color: #444;">|</span> 
            <span><b>${data.asset || '-'}</b></span> 
          </div> 
          <div class="bubble-row">${data.location || '-'}</div> 
          ${ hasFollow ? `<div class="bubble-row follow-title">
            <b>${data.follow.name} / ${data.follow.stage}</b>
            ${data.follow.followId ? `<span class="follow-id">#${data.follow.followId}</span>` : ''}
          </div>` : '' } 
          <div class="bubble-row">${data.activity || '-'}</div> 
          <div class="bubble-row"><b>IA Notes:</b> ${(data.iaNotes||'').replace(/\n/g,'<br>')}</div> 
        </div> 
        <div class="bubble-right"> 
          <span class="bubble-time">${data.zulu || '-'}</span> 
          <span><b>MGRS:</b> <span style="letter-spacing: 0.5px; font-size: 1.05em;">${data.mgrs || '-'}</span></span> 
          <span><b>SLANT:</b> ${(data.males||0)}/${(data.females||0)}/${(data.children||0)} &nbsp; <b>V:</b> ${(data.vehicles||0)}</span> 
        </div>
      `;
      
      // Update footer information
      let footer = bubble.querySelector('div[style*="font-size: 0.85em"]');
      if (!footer) {
        footer = document.createElement('div');
        footer.style.fontSize = "0.85em";
        footer.style.color = "#888";
        footer.style.marginTop = "7px";
        bubble.appendChild(footer);
      }
      footer.innerHTML = `By ${data.createdBy} &middot; ${(data.createdAt ? new Date(data.createdAt).toLocaleTimeString() : '')}`;
      
      // Update the data payload
      bubble.dataset.payload = JSON.stringify(data);
    } catch (error) {
      console.error("Error updating bubble content:", error);
    }
  };
  
  function showCalloutMenu(e, btn, id) {
    try {
      e.stopPropagation();
      console.log("Opening callout menu for:", id);
      const modalContent = document.getElementById('calloutMenuContent');
      
      // Create menu content
      modalContent.innerHTML = '';
      
      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.className = "modal-close";
      closeBtn.innerHTML = "&times;";
      closeBtn.addEventListener('click', closeCalloutMenu);
      
      // Title
      const title = document.createElement('div');
      title.style.textAlign = "center";
      title.style.marginBottom = "20px";
      title.style.fontWeight = "bold";
      title.textContent = "Callout Options";
      
      // Options container
      const options = document.createElement('div');
      options.style.display = "flex";
      options.style.gap = "15px";
      options.style.flexDirection = "column";
      
      // Create button helper function
      function createActionButton(text, action) {
        const button = document.createElement('button');
        button.className = "nav-btn";
        button.textContent = text;
        button.addEventListener('click', action);
        return button;
      }
      
      // Add option buttons
      options.appendChild(createActionButton("Edit Callout", () => editCallout(id)));
      options.appendChild(createActionButton("View History", () => calloutHistory(id)));
      // "Add Follow-on" button removed as per instructions
      options.appendChild(createActionButton("Delete Callout", () => deleteCallout(id)));
      
      // QC options
      const qcTitle = document.createElement('div');
      qcTitle.style.marginTop = "10px";
      qcTitle.style.marginBottom = "8px";
      qcTitle.style.fontWeight = "bold";
      qcTitle.textContent = "Quality Control:";
      options.appendChild(qcTitle);
      
      options.appendChild(createActionButton("QC: In Progress", () => updateQC(id, 'qc-orange')));
      options.appendChild(createActionButton("QC: In Review", () => updateQC(id, 'qc-yellow')));
      options.appendChild(createActionButton("QC: Approved", () => updateQC(id, 'qc-green')));
      options.appendChild(createActionButton("QC: Issues", () => updateQC(id, 'qc-red')));
      
      // Assemble modal content
      modalContent.appendChild(closeBtn);
      modalContent.appendChild(title);
      modalContent.appendChild(options);
      
      // Show modal
      document.getElementById('calloutMenuModal').style.display = 'flex';
    } catch (error) {
      console.error("Error showing callout menu:", error);
    }
  }
  
  // ------ Action Functions ------
  async function updateQC(id, qcClass) {
    closeCalloutMenu();
    console.log("Updating QC:", id, qcClass);
    const callout = callouts[id];
    if (!callout) return;
    
    // Check user permissions
    const userRole = localStorage.getItem('role');
    if (userRole === 'student' && (qcClass === 'qc-green' || qcClass === 'qc-red')) {
      alert('You do not have permission to set QC: Approved or QC: Issues. Only instructors can perform this action.');
      return;
    }
    
    try {
      const apiUrl = window.location.hostname === 'localhost' 
        ? `http://localhost:3001/api/callouts/${id}`
        : `/api/callouts/${id}`;
        
      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          ...callout,
          qc: qcClass,
          editedBy: localStorage.getItem('userName') || 'You'
        })
      });
      
      if (!response.ok) {
        if (response.status === 403) {
          throw new Error('Permission denied. You do not have the required role to perform this action.');
        }
        throw new Error(`Server returned ${response.status}`);
      }
      
      const updated = await response.json();
      callouts[id] = updated;
      
      // Use createBubble to update the existing callout in place
      // This will not change its position in the feed
      createBubble(updated);
    } catch (error) {
      console.error('Error updating QC:', error);
      alert('Error updating QC: ' + error.message);
    }
  }
  
  async function deleteCallout(id) {
    closeCalloutMenu();
    
    // Check user permissions
    const userRole = localStorage.getItem('role');
    if (userRole === 'student') {
      alert('You do not have permission to delete callouts. Only instructors can perform this action.');
      return;
    }
    
    if (confirm('Are you sure you want to delete this callout?')) {
      console.log("Deleting callout:", id);
      
      try {
        const apiUrl = window.location.hostname === 'localhost' 
          ? `http://localhost:3001/api/callouts/${id}`
          : `/api/callouts/${id}`;
          
        const response = await fetch(apiUrl, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (!response.ok) {
          if (response.status === 403) {
            throw new Error('Permission denied. You do not have the required role to perform this action.');
          }
          throw new Error(`Server returned ${response.status}`);
        }
        
        const bubble = document.getElementById('callout_' + id);
        if (bubble) bubble.remove();
        delete callouts[id];
      } catch (error) {
        console.error('Error deleting callout:', error);
        alert('Error deleting callout: ' + error.message);
      }
    }
  }
  
  function editCallout(id) {
    closeCalloutMenu();
    console.log("Editing callout:", id);
    const callout = callouts[id];
    if (!callout) {
      alert('Callout not found');
      return;
    }
    
    // Get the edit overlay and form
    const overlay = document.getElementById('editCalloutOverlay');
    const form = document.getElementById('editCalloutForm');
    
    if (!overlay || !form) {
      alert('Edit form not found');
      return;
    }
    
    // Populate form fields with callout data
    form.elements.classification.value = callout.classification || '';
    form.elements.asset.value = callout.asset || '';
    form.elements.sensor.value = callout.sensor || '';
    form.elements.operation.value = callout.operation || '';
    form.elements.countryCode.value = callout.countryCode || '';
    form.elements.team.value = callout.team || '';
    form.elements.zulu.value = callout.zulu || '';
    form.elements.mgrs.value = callout.mgrs || '';
    form.elements.location.value = callout.location || '';
    form.elements.activity.value = callout.activity || '';
    form.elements.males.value = callout.males || '';
    form.elements.females.value = callout.females || '';
    form.elements.children.value = callout.children || '';
    form.elements.vehicles.value = callout.vehicles || '';
    form.elements.iaNotes.value = callout.iaNotes || '';
    
    // Populate follow data if available
    if (callout.follow) {
      form.elements.followName.value = callout.follow.name || '';
      form.elements.followStage.value = callout.follow.stage || '';
    } else {
      form.elements.followName.value = '';
      form.elements.followStage.value = '';
    }
    
    // Store the callout ID in a data attribute on the form
    form.dataset.calloutId = id;
    
    // Auto-grow textareas to fit content
    const textareas = form.querySelectorAll('textarea');
    textareas.forEach(autoGrow);
    
    // Show the overlay
    overlay.style.display = 'flex';
    
    // Add submit handler if not already added
    if (!form.dataset.handlerAttached) {
      form.addEventListener('submit', handleEditFormSubmit);
      form.dataset.handlerAttached = 'true';
    }
  }
  
  function closeEditCallout() {
    const overlay = document.getElementById('editCalloutOverlay');
    if (overlay) {
      overlay.style.display = 'none';
    }
  }
  
  async function handleEditFormSubmit(e) {
    e.preventDefault();
    
    // Get form and callout ID
    const form = e.target;
    const id = form.dataset.calloutId;
    if (!id || !callouts[id]) {
      alert('Callout ID not found');
      return;
    }
    
    // Get original callout
    const callout = callouts[id];
    
    // Gather form data
    const formData = {
      ...callout, // Keep original data
      classification: form.elements.classification.value.trim(),
      asset: form.elements.asset.value.trim(),
      sensor: form.elements.sensor.value.trim(),
      operation: form.elements.operation.value.trim(),
      countryCode: form.elements.countryCode.value.trim(),
      team: form.elements.team.value.trim(),
      zulu: form.elements.zulu.value.trim(),
      mgrs: form.elements.mgrs.value.trim(),
      location: form.elements.location.value.trim(),
      activity: form.elements.activity.value.trim(),
      males: parseInt(form.elements.males.value) || 0,
      females: parseInt(form.elements.females.value) || 0,
      children: parseInt(form.elements.children.value) || 0,
      vehicles: parseInt(form.elements.vehicles.value) || 0,
      iaNotes: form.elements.iaNotes.value.trim(),
      editedBy: localStorage.getItem('userName') || 'You'
    };
    
    // Handle follow data
    const followName = form.elements.followName.value.trim();
    const followStage = form.elements.followStage.value.trim();
    
    if (followName && followStage) {
      formData.follow = {
        name: followName,
        stage: followStage,
        // Preserve existing follow data if it exists
        ...(callout.follow || {})
      };
    }
    
    try {
      // Create consistent API URL
      const apiUrl = window.location.hostname === 'localhost' 
        ? `http://localhost:3001/api/callouts/${id}`
        : `/api/callouts/${id}`;
        
      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(formData)
      });
      
      if (!response.ok) {
        if (response.status === 403) {
          throw new Error('Permission denied. You do not have the required role to perform this action.');
        }
        throw new Error(`Server returned ${response.status}`);
      }
      
      // Get the updated callout data
      const updated = await response.json();
      
      // Update the callout in our local store
      callouts[id] = updated;
      
      // Update the UI using our createBubble function (which now updates in place)
      createBubble(updated);
      
      // Close the edit form
      closeEditCallout();
      
      console.log('Callout updated successfully');
    } catch (error) {
      console.error('Error updating callout:', error);
      alert('Error updating callout: ' + error.message);
    }
  }
  
  // Helper function to auto-grow textareas
  function autoGrow(element) {
    if (typeof element === 'string') {
      element = document.getElementById(element);
    }
    if (!element) return;
    
    element.style.height = 'auto';
    element.style.height = (element.scrollHeight) + 'px';
  }
  
  // Functions addFollow() and updateStage() were removed as they were unused
  // The follow creation is now handled by the createFollowBtn click handler
  
  // The submitFollow function was removed as it was only used with the removed addFollow function
  // Follow creation is now handled through the form submission
  
  // ------ Socket.io Event Listeners ------
  socket.on('new_callout', function(callout) {
    console.log("New callout received:", callout);
    callouts[callout._id] = callout;
    createBubble(callout, false);
  });
  
  socket.on('update_callout', function(callout) {
    console.log("Updated callout received:", callout);
    callouts[callout._id] = callout;
    let old = document.getElementById('callout_'+callout._id);
    if (old) old.remove();
    createBubble(callout, false);
  });
  
  socket.on('delete_callout', function(id) {
    console.log("Delete callout received:", id);
    let old = document.getElementById('callout_'+id);
    if (old) old.remove();
    delete callouts[id];
  });
  
  // ------ Initialize All Event Handlers ------
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded - initializing event handlers");
    
    // Dashboard button (top bar)
    const dashboardBtn = document.getElementById('dashboardBtn');
    if (dashboardBtn) {
      dashboardBtn.addEventListener('click', goDashboard);
      console.log("Dashboard button handler attached");
    }
    
    // Join Room button (top bar)
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    if (joinRoomBtn) {
      joinRoomBtn.addEventListener('click', openRoomModal);
      console.log("Join Room button handler attached");
    }
    
    // Logout button (sidebar)
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', logout);
      console.log("Logout button handler attached");
    }
    
    // Edit Callout button (sidebar)
    const editCalloutBtn = document.getElementById('editCalloutBtn');
    if (editCalloutBtn) {
      editCalloutBtn.addEventListener('click', function() {
        // Find the most recent callout and open it for editing
        const mostRecentCalloutId = Object.keys(callouts)[0]; // Assuming callouts are sorted newest first
        if (mostRecentCalloutId) {
          editCallout(mostRecentCalloutId);
        } else {
          alert('No callouts available to edit');
        }
      });
      console.log("Edit Callout button handler attached");
    }
    
    // View History button (sidebar)
    const viewHistoryBtn = document.getElementById('viewHistoryBtn');
    if (viewHistoryBtn) {
      viewHistoryBtn.addEventListener('click', function() {
        // Find the most recent callout and view its history
        const mostRecentCalloutId = Object.keys(callouts)[0]; // Assuming callouts are sorted newest first
        if (mostRecentCalloutId) {
          calloutHistory(mostRecentCalloutId);
        } else {
          alert('No callout history available');
        }
      });
      console.log("View History button handler attached");
    }
    
    // Close Room Modal button
    const closeRoomModalBtn = document.getElementById('closeRoomModalBtn');
    if (closeRoomModalBtn) {
      closeRoomModalBtn.addEventListener('click', closeRoomModal);
      console.log("Close Room Modal button handler attached");
    }
    
    // Join Room Form submission
    const joinRoomForm = document.getElementById('joinRoomForm');
    if (joinRoomForm) {
      joinRoomForm.addEventListener('submit', function(e) {
        e.preventDefault();
        handleJoinRoomForm(this);
      });
      console.log("Join Room form handler attached");
    }
    
    // Join Room Button in modal
    const joinRoomButton = document.getElementById('joinRoomButton');
    if (joinRoomButton) {
      joinRoomButton.addEventListener('click', function() {
        document.getElementById('joinRoomForm').dispatchEvent(new Event('submit'));
      });
      console.log("Join Room Button handler attached");
    }
    
    // Log Form submission
    const logForm = document.getElementById('logForm');
    if (logForm) {
      logForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitLogForm(this);
      });
      console.log("Log form handler attached");
    }
    
    // Activity textarea auto-grow
    const activityTextarea = document.getElementById('activityTextarea');
    if (activityTextarea) {
      activityTextarea.addEventListener('input', function() {
        autoGrow(this);
      });
      console.log("Activity textarea handler attached");
    }
    
    // Create Follow button handler
    const createFollowBtn = document.getElementById('createFollowBtn');
    if (createFollowBtn) {
      let followContainer;

      createFollowBtn.addEventListener('click', function() {
        if (followContainer) {
          // If the container is already open, close it and revert the button text
          followContainer.remove();
          followContainer = null;
          createFollowBtn.textContent = 'Create Follow';
          console.log('Follow container closed');
        } else {
          // Create the follow container
          followContainer = document.createElement('div');
          followContainer.className = 'follow-container';
          followContainer.style.marginTop = '10px';

          // Follow Name
          const nameRow = document.createElement('div');
          nameRow.style.marginBottom = '10px';
          const nameLabel = document.createElement('label');
          nameLabel.textContent = 'Follow Name:';
          nameLabel.style.marginRight = '10px';
          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.id = 'followNameInput';
          nameInput.placeholder = 'Enter follow name';
          nameRow.appendChild(nameLabel);
          nameRow.appendChild(nameInput);

          // Follow ID (auto-generated)
          const idRow = document.createElement('div');
          idRow.style.marginBottom = '10px';
          const idLabel = document.createElement('label');
          idLabel.textContent = 'Follow ID:';
          idLabel.style.marginRight = '10px';
          const idDisplay = document.createElement('span');
          idDisplay.id = 'followIdDisplay';
          idDisplay.textContent = `ID-${Date.now()}`; // Auto-generated ID
          idRow.appendChild(idLabel);
          idRow.appendChild(idDisplay);

          // Follow Stage
          const stageRow = document.createElement('div');
          stageRow.style.marginBottom = '10px';
          const stageLabel = document.createElement('label');
          stageLabel.textContent = 'Follow Stage:';
          stageLabel.style.marginRight = '10px';
          // Using a simpler input for follow stage
          const stageInput = document.createElement('input');
          stageInput.type = 'text';
          stageInput.id = 'followStageSelect';
          stageInput.placeholder = 'Enter stage';
          stageRow.appendChild(stageLabel);
          stageRow.appendChild(stageInput);

          // Append rows to the container
          followContainer.appendChild(nameRow);
          followContainer.appendChild(idRow);
          followContainer.appendChild(stageRow);

          // Insert the container below the button
          createFollowBtn.parentNode.insertBefore(followContainer, createFollowBtn.nextSibling);

          // Change button text to "Cancel Follow"
          createFollowBtn.textContent = 'Cancel Follow';
          console.log('Follow container created');
        }
      });
      console.log("Create Follow button handler attached");
    } else {
      console.error("Create Follow button not found with ID 'createFollowBtn'");
    }
    
    // Initialize sidebar button states
    updateSidebarButtonStates();
    
    // Attach event listeners for the history overlay using event delegation
    const historyOverlay = document.getElementById('historyOverlay');
    if (historyOverlay) {
      historyOverlay.addEventListener('click', function(event) {
        const target = event.target;
        if (target.classList.contains('modal-close')) {
          closeHistoryOverlay();
        }
      });
      console.log('Event delegation for history overlay close button attached');
    } else {
      console.error('History overlay not found');
    }
    
    console.log("Event handlers attached, page ready.");
  });
  
  async function calloutHistory(id) {
    try {
      console.log(`Fetching history for callout ID: ${id}`);

      // Fetch history data from the API endpoint
      const apiUrl = window.location.hostname === 'localhost' 
        ? `http://localhost:3001/api/callouts/${id}/history` 
        : `/api/callouts/${id}/history`;

      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (!response.ok) {
        throw new Error(`Failed to fetch history: ${response.status}`);
      }

      const historyData = await response.json();

      // Populate the #historyLogContainer with the retrieved data
      const historyLogContainer = document.getElementById('historyLogContainer');
      historyLogContainer.innerHTML = '';

      if (Array.isArray(historyData) && historyData.length > 0) {
        historyData.forEach(entry => {
          const entryDiv = document.createElement('div');
          entryDiv.style.marginBottom = '10px';
          entryDiv.innerHTML = `
            <div><strong>Date:</strong> ${new Date(entry.date).toLocaleString()}</div>
            <div><strong>Change:</strong> ${entry.change}</div>
            <div><strong>Updated By:</strong> ${entry.updatedBy}</div>
          `;
          historyLogContainer.appendChild(entryDiv);
        });
      } else {
        historyLogContainer.innerHTML = '<div>No history available for this callout.</div>';
      }

      // Display the modal
      document.getElementById('historyOverlay').style.display = 'flex';
    } catch (error) {
      console.error(`Error fetching callout history: ${error.message}`);
      alert(`Error fetching callout history: ${error.message}`);
    }
  }

  function closeHistoryOverlay() {
    const historyOverlay = document.getElementById('historyOverlay');
    if (historyOverlay) {
        historyOverlay.style.display = 'none';
    } else {
        console.error('History overlay not found');
    }
}
  
</script>
</body>
</html>