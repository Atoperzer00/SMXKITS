<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SMX Instructor Streaming Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-bg: #101824;
      --panel-bg: #182233;
      --control-bg: #192637;
      --accent: #45a2ff;
      --accent-fade: #2478c9;
      --success: #11e38b;
      --error: #fa6060;
      --border: #25344b;
      --text-main: #e3e7ef;
      --text-secondary: #9bacc8;
      --paused: #ffe65e;
      --live: #ff5a5a;
      --rounded: 18px;
      --shadow: 0 6px 40px 0 #0005;
    }
    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: var(--main-bg);
      color: var(--text-main);
      min-height: 100vh;
      box-sizing: border-box;
    }
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px 18px 42px 18px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .header-title {
      font-size: 2.1rem;
      font-weight: 700;
      letter-spacing: .05em;
      color: var(--text-main);
    }
    .status-badge {
      padding: 0.36em 1.25em;
      border-radius: 1em;
      font-weight: 700;
      font-size: 1.1rem;
      background: var(--panel-bg);
      color: var(--text-secondary);
      border: 2.2px solid var(--border);
      margin-left: 16px;
      transition: background .14s;
    }
    .status-live { color: var(--live); border-color: var(--live); }
    .status-paused { color: var(--paused); border-color: var(--paused); }
    .status-offline { color: var(--text-secondary); border-color: var(--border); }
    .main-panel {
      display: flex;
      gap: 36px;
      flex-wrap: wrap;
    }
    .left-panel {
      flex: 2 1 480px;
      background: var(--panel-bg);
      border-radius: var(--rounded);
      padding: 28px 26px 32px 26px;
      box-shadow: var(--shadow);
      min-width: 400px;
      display: flex;
      flex-direction: column;
      min-height: 700px;
    }
    .right-panel {
      flex: 1 1 340px;
      background: var(--panel-bg);
      border-radius: var(--rounded);
      padding: 28px 26px 32px 26px;
      box-shadow: var(--shadow);
      min-width: 340px;
      max-width: 410px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    .panel-section {
      margin-bottom: 36px;
    }
    .section-title {
      font-size: 1.14rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 14px;
    }
    .class-select, .lesson-select {
      width: 100%;
      background: var(--control-bg);
      color: var(--text-main);
      border: 1.7px solid var(--border);
      padding: 0.7em 1.2em;
      font-size: 1.02rem;
      border-radius: 9px;
      margin-bottom: 15px;
      font-family: inherit;
    }
    .video-preview {
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 13px;
      background: #101929;
      position: relative;
      box-shadow: 0 0 0 2px var(--accent-fade);
      margin-bottom: 10px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .video-preview video, .video-preview .placeholder {
      width: 100%;
      height: 100%;
      border-radius: 13px;
      object-fit: cover;
      display: block;
    }
    .video-preview .placeholder {
      background: #151d27 url('SMX%20Stream%20Loading%20Image.png') center/cover no-repeat;
      filter: brightness(.82) blur(.3px);
    }
    .video-preview .video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: 13px;
    }
    .video-preview:hover .video-overlay {
      opacity: 1;
    }
    .video-preview .play-button {
      width: 60px;
      height: 60px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .video-preview .play-button:hover {
      transform: scale(1.1);
    }
    .video-preview .video-ready {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--success);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .controls-row {
      display: flex;
      gap: 18px;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .control-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 0.6em 2.3em;
      font-size: 1.04rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .17s;
      box-shadow: 0 2px 12px #2172aa33;
    }
    .control-btn:active { background: var(--accent-fade); }
    .control-btn.paused { background: var(--paused); color: #2a2a13;}
    .control-btn.stop { background: var(--error); }
    .control-btn[disabled] { opacity: .64; cursor: not-allowed; }
    .viewers-label {
      margin-left: 20px;
      color: var(--text-secondary);
      font-size: 1.04rem;
      font-weight: 600;
    }
    .file-drop {
      border: 2px dashed var(--accent);
      border-radius: 12px;
      padding: 40px 20px;
      background: linear-gradient(135deg, var(--main-bg) 0%, #0f1520 100%);
      color: var(--accent);
      text-align: center;
      font-size: 1.1rem;
      margin-bottom: 18px;
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
      overflow: hidden;
    }
    .file-drop::before {
      content: '⬆';
      font-size: 2.5rem;
      display: block;
      margin-bottom: 12px;
      opacity: 0.7;
    }
    .file-drop:hover {
      background: linear-gradient(135deg, #0f1520 0%, var(--main-bg) 100%);
      border-color: var(--success);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(69, 162, 255, 0.15);
    }
    .file-drop.dragover { 
      background: linear-gradient(135deg, #16203b 0%, #1a2540 100%); 
      border-color: var(--success);
      transform: scale(1.02);
      box-shadow: 0 12px 35px rgba(17, 227, 139, 0.2);
    }
    .file-drop.dragover::before {
      content: '⬇';
      animation: bounce 0.6s infinite alternate;
    }
    @keyframes bounce {
      0% { transform: translateY(0); }
      100% { transform: translateY(-8px); }
    }
    .file-browse-text {
      color: var(--success);
      text-decoration: underline;
      font-weight: 600;
      cursor: pointer;
      transition: color .2s;
    }
    .file-browse-text:hover {
      color: #00ff88;
    }
    .upload-status {
      margin-top: 15px;
      font-size: 0.95rem;
      font-weight: 500;
      min-height: 20px;
      color: var(--text-secondary);
    }
    .upload-status.success {
      color: var(--success);
    }
    .upload-status.error {
      color: var(--error);
    }
    .upload-status.info {
      color: var(--accent);
    }
    .progress-bar {
      background: #112233;
      border-radius: 8px;
      height: 12px;
      width: 100%;
      margin: 15px 0 8px 0;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--success) 100%);
      width: 0;
      transition: width .4s ease;
      border-radius: 8px;
      position: relative;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .file-info {
      background: var(--control-bg);
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 12px;
      border-left: 4px solid var(--accent);
      display: none;
    }
    .file-info.show {
      display: block;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .file-info-title {
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
    }
    .file-info-details {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    .notice-board {
      margin-top: 17px;
      background: var(--control-bg);
      border-radius: 7px;
      padding: 13px 12px 11px 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .notice-input {
      flex: 1;
      background: #141f2b;
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 8px 12px;
      font-size: 1rem;
      font-family: inherit;
      margin-right: 10px;
    }
    .notice-send {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 8px 18px;
      border-radius: 7px;
      font-weight: 600;
      cursor: pointer;
    }
    .timeline-bar {
      background: #172336;
      height: 8px;
      border-radius: 8px;
      margin-top: 14px;
      position: relative;
    }
    .timeline-marker {
      position: absolute;
      top: -7px;
      width: 3px;
      height: 22px;
      background: var(--success);
      border-radius: 3px;
    }
    .bookmark-list {
      margin-top: 12px;
      color: var(--accent);
      font-size: .97rem;
      line-height: 1.8;
    }
    /* Right Panel */
    .settings-section {
      margin-bottom: 30px;
      background: var(--control-bg);
      border-radius: 8px;
      padding: 14px 17px;
      box-shadow: 0 2px 8px #0213231e;
    }
    .settings-title {
      font-weight: 700;
      color: var(--text-main);
      font-size: 1.08rem;
      margin-bottom: 8px;
    }
    .settings-row {
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.98rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    @media (max-width: 1000px) {
      .main-panel { flex-direction: column; gap: 18px;}
      .right-panel { max-width: 100%;}
    }
    @media (max-width: 700px) {
      .left-panel, .right-panel { min-width: unset; padding: 14px 5vw;}
      .container { padding: 18px 0 28px 0;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="header-title">Instructor Streaming Control Panel</span>
      <span class="status-badge status-offline" id="streamStatus">OFFLINE</span>
    </div>
    <div class="main-panel">
      <!-- Left: Video and Controls -->
      <div class="left-panel">
        <div class="panel-section">
          <div class="section-title">Class Selection</div>
          <select id="classSelect" class="class-select">
            <option value="">Select a class...</option>
            <option value="Alpha1">Alpha 1</option>
            <option value="Bravo2">Bravo 2</option>
            <!-- Dynamically populated from backend -->
          </select>
        </div>
        <div class="panel-section">
          <div class="section-title">Stream Preview</div>
          <div class="video-preview" id="videoPreview">
            <div class="placeholder"></div>
            <video id="previewVideo" style="display:none;" muted controls></video>
            <div class="video-overlay" id="videoOverlay" style="display:none;">
              <div class="play-button" id="playButton">▶</div>
            </div>
            <div class="video-ready" id="videoReady" style="display:none;">Ready to Stream</div>
          </div>
        </div>
        <div class="controls-row">
          <button class="control-btn" id="goLiveBtn">Go Live</button>
          <button class="control-btn paused" id="pauseBtn" disabled>Pause</button>
          <button class="control-btn stop" id="stopBtn" disabled>Stop</button>
          <span class="viewers-label">Viewers: <span id="viewerCount">0</span></span>
        </div>
        <div class="panel-section">
          <div class="section-title">Lesson / Exercise Library</div>
          <select id="lessonSelect" class="lesson-select">
            <option value="">Choose a lesson/exercise...</option>
            <option value="ex1p1">Exercise 1: Practice 1</option>
            <option value="ex1p2">Exercise 1: Practice 2</option>
            <option value="ex2p1">Exercise 2: Practice 1</option>
            <!-- Dynamically populated from backend -->
          </select>
          <button class="control-btn" id="playLessonBtn" style="width:100%;margin:13px 0 0 0;">Stream Selected Lesson</button>
        </div>
        <div class="panel-section">
          <div class="section-title">Stream New Video</div>
          <div class="file-drop" id="fileDrop">
            <input type="file" id="fileInput" accept="video/mp4" style="display:none;">
            <div><strong>Drop your MP4 video here</strong></div>
            <div style="margin-top: 8px; font-size: 0.95rem; opacity: 0.8;">
              or <span class="file-browse-text" id="fileBrowse">click to browse</span>
            </div>
            <div style="margin-top: 12px; font-size: 0.85rem; opacity: 0.6;">
              Maximum file size: 4GB • Auto-deleted after 24 hours
            </div>
          </div>
          <div class="file-info" id="fileInfo">
            <div class="file-info-title" id="fileInfoTitle"></div>
            <div class="file-info-details" id="fileInfoDetails"></div>
          </div>
          <div class="upload-status" id="uploadStatus"></div>
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
        <div class="panel-section">
          <div class="section-title">Instructor Notice / Message</div>
          <div class="notice-board">
            <input class="notice-input" id="noticeInput" type="text" maxlength="150" placeholder="Type a message for all students..." />
            <button class="notice-send" id="noticeSendBtn">Send</button>
          </div>
        </div>
        <div class="panel-section">
          <div class="section-title">Session Timeline / Bookmarks</div>
          <div class="timeline-bar" id="timelineBar"></div>
          <button class="control-btn" id="bookmarkBtn" style="margin-top:10px;">Add Bookmark (Now)</button>
          <div class="bookmark-list" id="bookmarkList"></div>
        </div>
      </div>
      <!-- Right: Stream settings, OBS instructions, stats -->
      <div class="right-panel">
        <div class="settings-section">
          <div class="settings-title">Stream Information</div>
          <div class="settings-row">Class: <span id="classLabel">Not selected</span></div>
          <div class="settings-row">Status: <span id="streamStatusInfo">Offline</span></div>
          <div class="settings-row">Viewers: <span id="viewerCountInfo">0</span></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // --- Configuration ---
    const apiBaseUrl = '/api';
    let currentClassId = null;
    let authToken = localStorage.getItem('token');
    
    // --- Load classes on page load ---
    async function loadClasses() {
      try {
        if (!authToken) {
          console.warn('No auth token found');
          return;
        }
        
        const response = await fetch(`${apiBaseUrl}/classes`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        if (response.ok) {
          const classes = await response.json();
          const classSelect = document.getElementById('classSelect');
          
          // Clear existing options except the first one
          while (classSelect.children.length > 1) {
            classSelect.removeChild(classSelect.lastChild);
          }
          
          // Add classes to dropdown
          classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls._id;
            option.textContent = cls.name;
            classSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading classes:', error);
      }
    }
    
    // --- Class select, dynamic labels ---
    const classSelect = document.getElementById('classSelect');
    const classLabel = document.getElementById('classLabel');
    const streamKey = document.getElementById('streamKey');
    classSelect.addEventListener('change', () => {
      currentClassId = classSelect.value;
      classLabel.textContent = classSelect.options[classSelect.selectedIndex].text;
      streamKey.textContent = classSelect.value ? 'STREAM_' + classSelect.value : '---';
      
      // Load lessons for the selected class
      if (currentClassId) {
        loadLessons();
      }
    });

    // --- Video Preview controls (stub/demo for now) ---
    const goLiveBtn = document.getElementById('goLiveBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const streamStatus = document.getElementById('streamStatus');
    let liveState = 'offline'; // 'offline' | 'live' | 'paused'
    async function setStatus(status) {
      liveState = status;
      streamStatus.className = 'status-badge status-' + status;
      streamStatus.textContent = status === 'live' ? 'LIVE' : status === 'paused' ? 'PAUSED' : 'OFFLINE';
      goLiveBtn.disabled = (status === 'live');
      pauseBtn.disabled = (status !== 'live');
      stopBtn.disabled = (status === 'offline');

      try {
        if (currentClassId && authToken) {
          const endpoint = status === 'live' ? 'start' : status === 'paused' ? 'pause' : 'stop';
          
          // Determine the source type
          let source = 'live';
          let requestBody = { source };
          
          // If we have an uploaded video and we're going live, use that
          if (status === 'live' && window.currentUploadedVideo) {
            source = 'upload';
            requestBody = { 
              source,
              streamUrl: window.currentUploadedVideo.url,
              filename: window.currentUploadedVideo.filename,
              originalName: window.currentUploadedVideo.originalName
            };
          }
          
          await fetch(`${apiBaseUrl}/streams/${endpoint}/${currentClassId}`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(requestBody)
          });
          
          // Control video playback based on status
          if (window.currentUploadedVideo) {
            const previewVideo = document.getElementById('previewVideo');
            const videoOverlay = document.getElementById('videoOverlay');
            
            if (status === 'live') {
              // Start playing the video when going live
              if (previewVideo && previewVideo.src) {
                previewVideo.play().catch(e => console.log('Video autoplay prevented:', e));
                videoOverlay.style.display = 'none';
              }
            } else if (status === 'paused') {
              // Pause the video
              if (previewVideo && !previewVideo.paused) {
                previewVideo.pause();
                videoOverlay.style.display = 'flex';
              }
            } else if (status === 'offline') {
              // Stop the video and reset
              if (previewVideo) {
                previewVideo.pause();
                previewVideo.currentTime = 0;
                videoOverlay.style.display = 'flex';
              }
            }
          }
        }
      } catch (error) {
        console.error('Error updating stream status:', error);
      }
    }
    goLiveBtn.onclick = () => setStatus('live');
    pauseBtn.onclick = () => setStatus('paused');
    stopBtn.onclick = () => setStatus('offline');
    setStatus('offline');
    
    // Video preview controls
    const playButton = document.getElementById('playButton');
    const videoOverlay = document.getElementById('videoOverlay');
    const previewVideo = document.getElementById('previewVideo');
    
    playButton.onclick = () => {
      if (previewVideo.src) {
        previewVideo.play().then(() => {
          videoOverlay.style.display = 'none';
        }).catch(e => console.log('Video play error:', e));
      }
    };
    
    // Show overlay when video is paused
    previewVideo.addEventListener('pause', () => {
      if (window.currentUploadedVideo) {
        videoOverlay.style.display = 'flex';
      }
    });
    
    // Hide overlay when video is playing
    previewVideo.addEventListener('play', () => {
      videoOverlay.style.display = 'none';
    });

    // --- Lesson picker and play ---
    const lessonSelect = document.getElementById('lessonSelect');
    
    // Load lessons when class changes
    async function loadLessons() {
      try {
        if (!currentClassId || !authToken) return;
        
        const response = await fetch(`${apiBaseUrl}/streams/lessons?classId=${currentClassId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        if (response.ok) {
          const lessons = await response.json();
          
          // Clear existing options except the first one
          while (lessonSelect.children.length > 1) {
            lessonSelect.removeChild(lessonSelect.lastChild);
          }
          
          // Add lessons to dropdown
          lessons.forEach(lesson => {
            const option = document.createElement('option');
            option.value = lesson._id;
            option.textContent = lesson.title;
            lessonSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading lessons:', error);
      }
    }
    
    document.getElementById('playLessonBtn').onclick = async () => {
      if (!lessonSelect.value) return alert('Choose a lesson/exercise!');
      if (!currentClassId || !authToken) return alert('Please select a class and ensure you are logged in.');
      
      try {
        const response = await fetch(`${apiBaseUrl}/streams/play/${currentClassId}/${lessonSelect.value}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          alert('Streaming ' + lessonSelect.options[lessonSelect.selectedIndex].text + ' to students.');
          setStatus('live');
        } else {
          const error = await response.json();
          alert('Error: ' + (error.error || 'Failed to start lesson'));
        }
      } catch (error) {
        console.error('Error playing lesson:', error);
        alert('Error starting lesson. Please try again.');
      }
    };

    // --- File drop (Instant Stream) demo ---
    const fileDrop = document.getElementById('fileDrop');
    const fileInput = document.getElementById('fileInput');
    const fileBrowse = document.getElementById('fileBrowse');
    const uploadStatus = document.getElementById('uploadStatus');
    const progressFill = document.getElementById('progressFill');
    const fileInfo = document.getElementById('fileInfo');
    const fileInfoTitle = document.getElementById('fileInfoTitle');
    const fileInfoDetails = document.getElementById('fileInfoDetails');
    
    function showFileInfo(file) {
      const sizeGB = (file.size / 1024 / 1024 / 1024).toFixed(2);
      const sizeMB = (file.size / 1024 / 1024).toFixed(1);
      const displaySize = file.size > 1024 * 1024 * 1024 ? sizeGB + 'GB' : sizeMB + 'MB';
      
      fileInfoTitle.textContent = file.name;
      fileInfoDetails.textContent = `Size: ${displaySize} • Type: MP4 Video • Ready to upload`;
      fileInfo.classList.add('show');
      
      uploadStatus.textContent = 'File selected and ready to upload';
      uploadStatus.className = 'upload-status info';
      progressFill.style.width = '0';
    }
    
    function hideFileInfo() {
      fileInfo.classList.remove('show');
    }
    
    fileDrop.addEventListener('click', () => fileInput.click());
    fileBrowse.addEventListener('click', e => { e.stopPropagation(); fileInput.click(); });
    fileDrop.addEventListener('dragover', e => { e.preventDefault(); fileDrop.classList.add('dragover'); });
    fileDrop.addEventListener('dragleave', e => fileDrop.classList.remove('dragover'));
    fileDrop.addEventListener('drop', e => {
      e.preventDefault();
      fileDrop.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        showFileInfo(file);
      }
      handleFileUpload(file);
    });
    fileInput.addEventListener('change', e => {
      const file = fileInput.files[0];
      if (file) {
        showFileInfo(file);
      }
      handleFileUpload(file);
    });
    async function handleFileUpload(file) {
      if (!file || !file.name.endsWith('.mp4')) {
        uploadStatus.textContent = 'Please select an MP4 file only';
        uploadStatus.className = 'upload-status error';
        hideFileInfo();
        return;
      }
      
      // Check file size (4GB limit)
      const maxSize = 4 * 1024 * 1024 * 1024; // 4GB
      if (file.size > maxSize) {
        const currentSizeGB = (file.size / 1024 / 1024 / 1024).toFixed(2);
        uploadStatus.textContent = `File too large: ${currentSizeGB}GB (max 4GB)`;
        uploadStatus.className = 'upload-status error';
        hideFileInfo();
        return;
      }
      
      if (!currentClassId) {
        uploadStatus.textContent = 'Please select a class first';
        uploadStatus.className = 'upload-status error';
        return;
      }
      
      if (!authToken) {
        uploadStatus.textContent = 'Authentication required. Please login.';
        uploadStatus.className = 'upload-status error';
        return;
      }

      uploadStatus.textContent = `Uploading "${file.name}"...`;
      uploadStatus.className = 'upload-status info';
      progressFill.style.width = '25%';

      const formData = new FormData();
      formData.append('video', file);
      formData.append('classId', currentClassId);

      try {
        const response = await fetch(`${apiBaseUrl}/stream/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          },
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to upload file');
        }

        const result = await response.json();
        progressFill.style.width = '100%';
        uploadStatus.textContent = `Video uploaded successfully! Click "Go Live" to start streaming.`;
        uploadStatus.className = 'upload-status success';
        
        // Load the uploaded video into the preview
        const previewVideo = document.getElementById('previewVideo');
        const placeholder = document.querySelector('.video-preview .placeholder');
        const videoOverlay = document.getElementById('videoOverlay');
        const videoReady = document.getElementById('videoReady');
        
        if (result.streamUrl) {
          previewVideo.src = result.streamUrl;
          previewVideo.style.display = 'block';
          placeholder.style.display = 'none';
          videoOverlay.style.display = 'flex';
          videoReady.style.display = 'block';
          
          // Store the stream info for when user clicks "Go Live"
          window.currentUploadedVideo = {
            url: result.streamUrl,
            filename: result.filename,
            originalName: file.name
          };
          
          uploadStatus.textContent = `"${file.name}" ready to stream! Click "Go Live" to broadcast.`;
        }

        // Clear after 8 seconds
        setTimeout(() => {
          uploadStatus.textContent = '';
          uploadStatus.className = 'upload-status';
          progressFill.style.width = '0';
          hideFileInfo();
        }, 8000);
      } catch (error) {
        console.error('Error uploading file:', error);
        uploadStatus.textContent = `Upload failed: ${error.message}`;
        uploadStatus.className = 'upload-status error';
        progressFill.style.width = '0';
        
        // Clear error after 5 seconds
        setTimeout(() => {
          uploadStatus.textContent = '';
          uploadStatus.className = 'upload-status';
        }, 5000);
      }
    }

    // --- Instructor notice/message demo ---
    async function sendNotice() {
      const val = document.getElementById('noticeInput').value.trim();
      if (!val) return;

      try {
        if (!currentClassId || !authToken) {
          alert('Please select a class and ensure you are logged in.');
          return;
        }
        
        await fetch(`${apiBaseUrl}/stream/notice/${currentClassId}`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ message: val })
        });

        alert('Notice sent: ' + val);
        document.getElementById('noticeInput').value = '';
      } catch (error) {
        console.error('Error sending notice:', error);
        alert('Error sending notice. Please try again.');
      }
    }
    document.getElementById('noticeSendBtn').onclick = sendNotice;

    // --- Bookmarks/timeline ---
    const timelineBar = document.getElementById('timelineBar');
    const bookmarkList = document.getElementById('bookmarkList');
    let bookmarks = [];
    document.getElementById('bookmarkBtn').onclick = () => {
      const time = new Date();
      const label = 'Bookmark at ' + time.toLocaleTimeString();
      bookmarks.push({ time: time.getTime(), label });
      updateBookmarks();
    };
    function updateBookmarks() {
      bookmarkList.innerHTML = bookmarks.map(bm => `<div>• ${bm.label}</div>`).join('');
      timelineBar.innerHTML = bookmarks.map((bm,i) =>
        `<div class="timeline-marker" style="left:${i*12+8}px"></div>`).join('');
    }

    // --- Copy to clipboard ---
    function copyToClipboard(id) {
      const val = document.getElementById(id).textContent;
      navigator.clipboard.writeText(val).then(() => {
        alert('Copied: ' + val);
      });
    }

    // --- Viewer count ---
    setInterval(async () => {
      try {
        if (currentClassId && authToken) {
          const response = await fetch(`${apiBaseUrl}/stream/viewers/${currentClassId}`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });
          if (response.ok) {
            const data = await response.json();
            document.getElementById('viewerCount').textContent = data.count || 0;
          }
        }
      } catch (error) {
        console.error('Error fetching viewer count:', error);
      }
    }, 1800);

    // --- Initialize page ---
    document.addEventListener('DOMContentLoaded', () => {
      loadClasses();
    });
    
    // Load classes immediately if DOM is already ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadClasses);
    } else {
      loadClasses();
    }
  </script>
</body>
</html>
