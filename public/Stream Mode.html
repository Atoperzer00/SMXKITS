<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SMX Instructor Streaming Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-bg: #101824;
      --panel-bg: #182233;
      --control-bg: #192637;
      --accent: #45a2ff;
      --accent-fade: #2478c9;
      --success: #11e38b;
      --error: #fa6060;
      --border: #25344b;
      --text-main: #e3e7ef;
      --text-secondary: #9bacc8;
      --paused: #ffe65e;
      --live: #ff5a5a;
      --rounded: 18px;
      --shadow: 0 6px 40px 0 #0005;
    }
    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: var(--main-bg);
      color: var(--text-main);
      min-height: 100vh;
      box-sizing: border-box;
    }
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px 18px 42px 18px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .header-title {
      font-size: 2.1rem;
      font-weight: 700;
      letter-spacing: .05em;
      color: var(--text-main);
    }
    .status-badge {
      padding: 0.36em 1.25em;
      border-radius: 1em;
      font-weight: 700;
      font-size: 1.1rem;
      background: var(--panel-bg);
      color: var(--text-secondary);
      border: 2.2px solid var(--border);
      margin-left: 16px;
      transition: background .14s;
    }
    .status-live { color: var(--live); border-color: var(--live); }
    .status-paused { color: var(--paused); border-color: var(--paused); }
    .status-offline { color: var(--text-secondary); border-color: var(--border); }
    .main-panel {
      display: flex;
      gap: 36px;
      flex-wrap: wrap;
    }
    .left-panel {
      flex: 2 1 480px;
      background: var(--panel-bg);
      border-radius: var(--rounded);
      padding: 28px 26px 32px 26px;
      box-shadow: var(--shadow);
      min-width: 400px;
      display: flex;
      flex-direction: column;
      min-height: 700px;
    }
    .right-panel {
      flex: 1 1 340px;
      background: var(--panel-bg);
      border-radius: var(--rounded);
      padding: 28px 26px 32px 26px;
      box-shadow: var(--shadow);
      min-width: 340px;
      max-width: 410px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    .panel-section {
      margin-bottom: 36px;
    }
    .section-title {
      font-size: 1.14rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 14px;
    }
    .class-select {
      width: 100%;
      background: var(--control-bg);
      color: var(--text-main);
      border: 1.7px solid var(--border);
      padding: 0.7em 1.2em;
      font-size: 1.02rem;
      border-radius: 9px;
      margin-bottom: 15px;
      font-family: inherit;
    }
    .video-preview {
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 13px;
      background: #101929;
      position: relative;
      box-shadow: 0 0 0 2px var(--accent-fade);
      margin-bottom: 10px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .video-preview video, .video-preview .placeholder {
      width: 100%;
      height: 100%;
      border-radius: 13px;
      object-fit: cover;
      display: block;
    }
    .video-preview .placeholder {
      background: #151d27 url('SMX%20Stream%20Loading%20Image.png') center/cover no-repeat;
      filter: brightness(.82) blur(.3px);
    }
    .video-preview .video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: 13px;
    }
    .video-preview:hover .video-overlay {
      opacity: 1;
    }
    .video-preview .play-button {
      width: 60px;
      height: 60px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .video-preview .play-button:hover {
      transform: scale(1.1);
    }
    .video-preview .video-ready {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--success);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .video-preview.drop-target {
      border: 3px dashed var(--accent);
      background: rgba(69, 162, 255, 0.1);
      transform: scale(1.02);
    }
    .video-preview.drop-target::after {
      content: '📹 Drop video here to load';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: var(--accent);
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 10;
      pointer-events: none;
    }
    .controls-row {
      display: flex;
      gap: 18px;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .control-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 0.6em 2.3em;
      font-size: 1.04rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .17s;
      box-shadow: 0 2px 12px #2172aa33;
    }
    .control-btn:active { background: var(--accent-fade); }
    .control-btn.paused { background: var(--paused); color: #2a2a13;}
    .control-btn.stop { background: var(--error); }
    .control-btn[disabled] { opacity: .64; cursor: not-allowed; }
    .viewers-label {
      margin-left: 20px;
      color: var(--text-secondary);
      font-size: 1.04rem;
      font-weight: 600;
    }
    .file-drop {
      border: 2px dashed var(--accent);
      border-radius: 12px;
      padding: 40px 20px;
      background: linear-gradient(135deg, var(--main-bg) 0%, #0f1520 100%);
      color: var(--accent);
      text-align: center;
      font-size: 1.1rem;
      margin-bottom: 18px;
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
      overflow: hidden;
    }
    .file-drop::before {
      content: '⬆';
      font-size: 2.5rem;
      display: block;
      margin-bottom: 12px;
      opacity: 0.7;
    }
    .file-drop:hover {
      background: linear-gradient(135deg, #0f1520 0%, var(--main-bg) 100%);
      border-color: var(--success);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(69, 162, 255, 0.15);
    }
    .file-drop.dragover { 
      background: linear-gradient(135deg, #16203b 0%, #1a2540 100%); 
      border-color: var(--success);
      transform: scale(1.02);
      box-shadow: 0 12px 35px rgba(17, 227, 139, 0.2);
    }
    .file-drop.dragover::before {
      content: '⬇';
      animation: bounce 0.6s infinite alternate;
    }
    .file-drop.has-file {
      border-color: var(--success);
      background: linear-gradient(135deg, #0a1a0a 0%, #0f1f0f 100%);
    }
    .file-drop.has-file::before {
      content: '🎬';
      color: var(--success);
    }
    .file-drop.has-file:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .file-drop.dragging {
      opacity: 0.7;
      transform: rotate(3deg) scale(0.95);
    }
    @keyframes bounce {
      0% { transform: translateY(0); }
      100% { transform: translateY(-8px); }
    }
    .file-browse-text {
      color: var(--success);
      text-decoration: underline;
      font-weight: 600;
      cursor: pointer;
      transition: color .2s;
    }
    .file-browse-text:hover {
      color: #00ff88;
    }
    .upload-status {
      margin-top: 15px;
      font-size: 0.95rem;
      font-weight: 500;
      min-height: 20px;
      color: var(--text-secondary);
    }
    .upload-status.success {
      color: var(--success);
    }
    .upload-status.error {
      color: var(--error);
    }
    .upload-status.info {
      color: var(--accent);
    }
    .progress-bar {
      background: #112233;
      border-radius: 8px;
      height: 12px;
      width: 100%;
      margin: 15px 0 8px 0;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--success) 100%);
      width: 0;
      transition: width .4s ease;
      border-radius: 8px;
      position: relative;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .file-info {
      background: var(--control-bg);
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 12px;
      border-left: 4px solid var(--accent);
      display: none;
      cursor: grab;
      transition: all 0.2s ease;
    }
    .file-info.show {
      display: block;
      animation: slideIn 0.3s ease;
    }
    .file-info:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(69, 162, 255, 0.2);
    }
    .file-info.dragging {
      cursor: grabbing;
      opacity: 0.7;
      transform: rotate(5deg) scale(0.95);
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .file-info-title {
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
    }
    .file-info-details {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Right Panel */
    .settings-section {
      margin-bottom: 30px;
      background: var(--control-bg);
      border-radius: 8px;
      padding: 14px 17px;
      box-shadow: 0 2px 8px #0213231e;
    }
    .settings-title {
      font-weight: 700;
      color: var(--text-main);
      font-size: 1.08rem;
      margin-bottom: 8px;
    }
    .settings-row {
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.98rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Stream Source Tabs */
    .stream-source-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }
    .source-tab {
      background: var(--control-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5em 1.2em;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
    }
    .source-tab:hover {
      background: var(--panel-bg);
      color: var(--text-main);
    }
    .source-tab.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    
    /* Live Controls */
    .live-controls {
      position: absolute;
      bottom: 15px;
      left: 15px;
      right: 15px;
      display: flex;
      gap: 10px;
      justify-content: center;
      background: rgba(16, 24, 36, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 12px;
    }
    .live-controls .control-btn {
      font-size: 0.9rem;
      padding: 0.5em 1.2em;
    }
    
    /* Live video styling */
    #liveVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: var(--rounded);
    }

    @media (max-width: 1000px) {
      .main-panel { flex-direction: column; gap: 18px;}
      .right-panel { max-width: 100%;}
    }
    @media (max-width: 700px) {
      .left-panel, .right-panel { min-width: unset; padding: 14px 5vw;}
      .container { padding: 18px 0 28px 0;}
      .stream-source-tabs { flex-direction: column; }
      .live-controls { flex-direction: column; }
    }

    /* Server Uploads Section */
    .server-uploads {
      margin-top: 12px;
      padding: 12px;
      background: var(--control-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .upload-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .upload-item:last-child {
      border-bottom: none;
    }
    .upload-item button {
      background: var(--error);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.4em 0.8em;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .upload-item button:hover {
      background: #e03e3e;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="header-title">Instructor Streaming Control Panel</span>
      <span class="status-badge status-offline" id="streamStatus">OFFLINE</span>
    </div>
    <div class="main-panel">
      <!-- Left: Video and Controls -->
      <div class="left-panel">
        <div class="panel-section">
          <div class="section-title">Class Selection</div>
          <select id="classSelect" class="class-select">
            <option value="">Select a class...</option>
            <option value="Alpha1">Alpha 1</option>
            <option value="Bravo2">Bravo 2</option>
            <!-- Dynamically populated from backend -->
          </select>
        </div>
        <div class="panel-section">
          <div class="section-title">Stream Source</div>
          <div class="stream-source-tabs">
            <button class="source-tab active" id="fileTab" onclick="switchToFileMode()">📁 File Upload</button>
            <button class="source-tab" id="liveTab" onclick="switchToLiveMode()">🔴 Live Camera/Screen</button>
          </div>
        </div>
        <div class="panel-section">
          <div class="section-title">Stream Preview</div>
          <div class="video-preview" id="videoPreview">
            <div class="placeholder"></div>
            <video id="previewVideo" style="display:none;" controls></video>
            <video id="liveVideo" style="display:none;" autoplay muted playsinline></video>
            <div class="video-overlay" id="videoOverlay" style="display:none;">
              <div class="play-button" id="playButton">▶</div>
            </div>
            <div class="video-ready" id="videoReady" style="display:none;">Ready to Stream</div>
            <div class="live-controls" id="liveControls" style="display:none;">
              <button class="control-btn" id="startCameraBtn">📹 Start Camera</button>
              <button class="control-btn" id="startScreenBtn">🖥️ Share Screen</button>
              <button class="control-btn stop" id="stopMediaBtn" style="display:none;">⏹️ Stop Media</button>
            </div>
          </div>
        </div>
        <div class="controls-row">
          <button class="control-btn" id="goLiveBtn">Go Live</button>
          <button class="control-btn paused" id="pauseBtn" disabled>Pause</button>
          <button class="control-btn stop" id="stopBtn" disabled>End Live</button>
          <span class="viewers-label">Viewers: <span id="viewerCount">0</span></span>
        </div>
      </div>
      <!-- Right: File Upload and Info -->
      <div class="right-panel">
        <div class="panel-section">
          <div class="section-title">Upload Video</div>
          <div class="file-drop" id="fileDrop">
            <input type="file" id="fileInput" accept="video/mp4" style="display:none;">
            <div><strong>Drop your MP4 video here</strong></div>
            <div style="margin-top: 8px; font-size: 0.95rem; opacity: 0.8;">
              or <span class="file-browse-text" id="fileBrowse">click to browse</span>
            </div>
            <div style="margin-top: 12px; font-size: 0.85rem; opacity: 0.6;">
              Maximum file size: 4GB • Auto-deleted after 24 hours
            </div>
            <div class="drag-instruction" id="dragInstruction" style="margin-top: 8px; font-size: 0.8rem; color: var(--success); display: none;">
              💡 You can drag this area to the video player to load the file
            </div>
          </div>
          <div class="upload-status" id="uploadStatus"></div>
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <div class="file-info" id="fileInfo">
            <div class="file-info-title" id="fileInfoTitle"></div>
            <div class="file-info-details" id="fileInfoDetails"></div>
            <div class="drag-hint" id="dragHint" style="font-size:0.8rem; color:var(--accent); margin-top:8px; display:none;">
              🎬 Drag this to the video player to load it
            </div>
            <button class="control-btn" id="uploadBtn" style="width:100%; margin-top:12px; display:none;">Upload to Server</button>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-title">Stream Information</div>
          <div class="settings-row">Class: <span id="classLabel">Not selected</span></div>
          <div class="settings-row">Status: <span id="streamStatusInfo">Offline</span></div>
          <div class="settings-row">Viewers: <span id="viewerCountInfo">0</span></div>
        </div>
        <!-- Add a section to display submitted files -->
        <div class="panel-section">
          <div class="section-title">Submitted Files</div>
          <div id="submittedFiles" class="server-uploads">
            <!-- Submitted files will be dynamically populated here -->
          </div>
        </div>
        
        <!-- Add a section to display server uploads -->
        <div class="panel-section">
          <div class="section-title">Server Uploads</div>
          <div id="serverUploads" class="server-uploads">
            <!-- Uploads will be dynamically populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // --- Configuration ---
    const apiBaseUrl = '/api';
    let currentClassId = null;
    let authToken = localStorage.getItem('token');
    
    // --- WebRTC Variables ---
    let localStream = null;
    let socket = null;
    let peerConnections = new Map();
    let isLiveMode = false;
    let isStreaming = false;
    let streamingMode = 'file'; // 'file' or 'webrtc'
    
    // --- Load classes on page load ---
    async function loadClasses() {
      try {
        if (!authToken) {
          console.warn('No auth token found');
          return;
        }
        
        const response = await fetch(`${apiBaseUrl}/classes`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        if (response.ok) {
          const classes = await response.json();
          const classSelect = document.getElementById('classSelect');
          
          // Clear existing options except the first one
          while (classSelect.children.length > 1) {
            classSelect.removeChild(classSelect.lastChild);
          }
          
          // Add classes to dropdown
          classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls._id;
            option.textContent = cls.name;
            classSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading classes:', error);
      }
    }
    
    // --- Class select, dynamic labels ---
    const classSelect = document.getElementById('classSelect');
    const classLabel = document.getElementById('classLabel');
    classSelect.addEventListener('change', () => {
      currentClassId = classSelect.value;
      classLabel.textContent = classSelect.options[classSelect.selectedIndex].text;
      
      // If WebRTC socket is connected and we're in live mode, join the new class room
      if (socket && isLiveMode && currentClassId) {
        socket.emit('instructor-join-class', { classId: currentClassId });
        console.log('🏫 Joined WebRTC class room:', currentClassId);
      }
    });

    // --- Video Preview controls (stub/demo for now) ---
    const goLiveBtn = document.getElementById('goLiveBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const streamStatus = document.getElementById('streamStatus');
    let liveState = 'offline'; // 'offline' | 'live' | 'paused'
    async function setStatus(status) {
      liveState = status;
      streamStatus.className = 'status-badge status-' + status;
      streamStatus.textContent = status === 'live' ? 'LIVE' : status === 'paused' ? 'PAUSED' : 'OFFLINE';
      document.getElementById('streamStatusInfo').textContent = status === 'live' ? 'Live' : status === 'paused' ? 'Paused' : 'Offline';
      goLiveBtn.disabled = (status === 'live');
      pauseBtn.disabled = (status !== 'live');
      stopBtn.disabled = (status === 'offline');

      try {
        if (!currentClassId) {
          alert('Please select a class first before going live.');
          return;
        }
        
        if (!authToken) {
          alert('Please login first.');
          return;
        }
        
        if (currentClassId && authToken) {
          const endpoint = status === 'live' ? 'start' : status === 'paused' ? 'pause' : 'stop';
          
          // Determine the source type
          let source = 'live';
          let requestBody = { source };
          
          // If we have an uploaded video and we're going live, use that
          if (status === 'live' && window.currentUploadedVideo) {
            source = 'upload';
            requestBody = { 
              source,
              streamUrl: window.currentUploadedVideo.url,
              filename: window.currentUploadedVideo.filename,
              originalName: window.currentUploadedVideo.originalName
            };
          }
          // If we only have a local video, warn user to upload first
          else if (status === 'live' && window.currentLocalVideo && !window.currentUploadedVideo) {
            alert('Please upload your video to the server first before going live. Click the "Upload to Server" button.');
            return;
          }
          
          console.log(`🎥 ${status.toUpperCase()} stream for class:`, currentClassId, 'with data:', requestBody);
          
          const response = await fetch(`${apiBaseUrl}/streams/${endpoint}/${currentClassId}`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(requestBody)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Failed to ${endpoint} stream`);
          }
          
          const result = await response.json();
          console.log(`✅ Stream ${endpoint} successful:`, result);
          
          // Control video playback based on status
          if (window.currentUploadedVideo || window.currentLocalVideo) {
            const previewVideo = document.getElementById('previewVideo');
            const videoOverlay = document.getElementById('videoOverlay');
            
            if (status === 'live') {
              // Start playing the video when going live
              if (previewVideo && previewVideo.src) {
                previewVideo.play().catch(e => console.log('Video autoplay prevented:', e));
                videoOverlay.style.display = 'none';
              }
            } else if (status === 'paused') {
              // Pause the video
              if (previewVideo && !previewVideo.paused) {
                previewVideo.pause();
                videoOverlay.style.display = 'flex';
              }
            } else if (status === 'offline') {
              // Stop the video and reset
              if (previewVideo) {
                previewVideo.pause();
                previewVideo.currentTime = 0;
                videoOverlay.style.display = 'flex';
              }
            }
          }
        }
      } catch (error) {
        console.error('Error updating stream status:', error);
        alert(`Error ${status === 'live' ? 'starting' : status === 'paused' ? 'pausing' : 'stopping'} stream: ${error.message}`);
        
        // Reset UI state on error
        liveState = 'offline';
        streamStatus.className = 'status-badge status-offline';
        streamStatus.textContent = 'OFFLINE';
        document.getElementById('streamStatusInfo').textContent = 'Offline';
        goLiveBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
      }
    }
    goLiveBtn.onclick = () => setStatus('live');
    pauseBtn.onclick = () => setStatus('paused');
    stopBtn.onclick = () => setStatus('offline');
    setStatus('offline');
    
    // Video preview controls
    const playButton = document.getElementById('playButton');
    const videoOverlay = document.getElementById('videoOverlay');
    const previewVideo = document.getElementById('previewVideo');
    
    playButton.onclick = () => {
      if (previewVideo.src) {
        previewVideo.play().then(() => {
          videoOverlay.style.display = 'none';
        }).catch(e => console.log('Video play error:', e));
      }
    };
    
    // Show overlay when video is paused
    previewVideo.addEventListener('pause', () => {
      if (window.currentUploadedVideo || window.currentLocalVideo) {
        videoOverlay.style.display = 'flex';
      }
    });
    
    // Hide overlay when video is playing
    previewVideo.addEventListener('play', () => {
      videoOverlay.style.display = 'none';
    });



    // --- File drop (Instant Stream) demo ---
    const fileDrop = document.getElementById('fileDrop');
    const fileInput = document.getElementById('fileInput');
    const fileBrowse = document.getElementById('fileBrowse');
    const uploadStatus = document.getElementById('uploadStatus');
    const progressFill = document.getElementById('progressFill');
    const fileInfo = document.getElementById('fileInfo');
    const fileInfoTitle = document.getElementById('fileInfoTitle');
    const fileInfoDetails = document.getElementById('fileInfoDetails');
    
    function showFileInfo(file) {
      const sizeGB = (file.size / 1024 / 1024 / 1024).toFixed(2);
      const sizeMB = (file.size / 1024 / 1024).toFixed(1);
      const displaySize = file.size > 1024 * 1024 * 1024 ? sizeGB + 'GB' : sizeMB + 'MB';
      
      fileInfoTitle.textContent = file.name;
      fileInfoDetails.textContent = `Size: ${displaySize} • Type: MP4 Video • Loaded in player`;
      fileInfo.classList.add('show');
      
      // Show upload button and drag hint
      document.getElementById('uploadBtn').style.display = 'block';
      document.getElementById('dragHint').style.display = 'block';
      
      uploadStatus.textContent = 'File loaded in player for preview';
      uploadStatus.className = 'upload-status info';
      progressFill.style.width = '0';
      
      // Load the file into the video player for immediate preview
      loadFileIntoPlayer(file);
      
      // Make file info draggable
      setupFileDragAndDrop(file);
    }
    
    function loadFileIntoPlayer(file) {
      if (!file || !file.type.startsWith('video/')) {
        console.warn('Invalid file type for video preview');
        return;
      }
      
      const previewVideo = document.getElementById('previewVideo');
      const placeholder = document.querySelector('.video-preview .placeholder');
      const videoOverlay = document.getElementById('videoOverlay');
      const videoReady = document.getElementById('videoReady');
      
      // Create a local URL for the file
      const fileURL = URL.createObjectURL(file);
      
      // Load the video
      previewVideo.src = fileURL;
      previewVideo.style.display = 'block';
      placeholder.style.display = 'none';
      videoOverlay.style.display = 'flex';
      videoReady.style.display = 'block';
      
      // Store the local file info
      window.currentLocalVideo = {
        file: file,
        url: fileURL,
        name: file.name
      };
      
      uploadStatus.textContent = `"${file.name}" loaded in player! You can preview it now or upload to stream.`;
      uploadStatus.className = 'upload-status success';
      
      // Add visual indicator to file drop area
      document.getElementById('fileDrop').classList.add('has-file');
      document.getElementById('dragInstruction').style.display = 'block';
      
      // Clean up the previous URL if it exists
      if (window.previousVideoURL) {
        URL.revokeObjectURL(window.previousVideoURL);
      }
      window.previousVideoURL = fileURL;
    }
    
    // Setup drag and drop from file info to video player
    function setupFileDragAndDrop(file) {
      const fileInfo = document.getElementById('fileInfo');
      const fileDrop = document.getElementById('fileDrop');
      const videoPreview = document.getElementById('videoPreview');
      
      // Make file info draggable
      fileInfo.draggable = true;
      
      // Also make the file drop area draggable when it has a file
      fileDrop.draggable = true;
      
      fileInfo.addEventListener('dragstart', (e) => {
        fileInfo.classList.add('dragging');
        e.dataTransfer.setData('text/plain', 'video-file');
        e.dataTransfer.effectAllowed = 'move';
        
        // Store file reference for drop handler
        window.draggedFile = file;
      });
      
      fileInfo.addEventListener('dragend', (e) => {
        fileInfo.classList.remove('dragging');
      });
      
      // Add drag handlers for file drop area too
      fileDrop.addEventListener('dragstart', (e) => {
        if (window.currentLocalVideo) {
          fileDrop.classList.add('dragging');
          e.dataTransfer.setData('text/plain', 'video-file');
          e.dataTransfer.effectAllowed = 'move';
          window.draggedFile = window.currentLocalVideo.file;
        } else {
          e.preventDefault(); // Don't allow dragging if no file
        }
      });
      
      fileDrop.addEventListener('dragend', (e) => {
        fileDrop.classList.remove('dragging');
      });
      
      // Setup video player as drop target
      videoPreview.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        videoPreview.classList.add('drop-target');
      });
      
      videoPreview.addEventListener('dragleave', (e) => {
        // Only remove if we're actually leaving the video preview area
        if (!videoPreview.contains(e.relatedTarget)) {
          videoPreview.classList.remove('drop-target');
        }
      });
      
      videoPreview.addEventListener('drop', (e) => {
        e.preventDefault();
        videoPreview.classList.remove('drop-target');
        
        if (window.draggedFile && e.dataTransfer.getData('text/plain') === 'video-file') {
          // Load the dragged file into the video player
          loadFileIntoPlayer(window.draggedFile);
          
          // Show success feedback
          const uploadStatus = document.getElementById('uploadStatus');
          uploadStatus.textContent = `"${window.draggedFile.name}" loaded into player!`;
          uploadStatus.className = 'upload-status success';
          
          // Clear after 3 seconds
          setTimeout(() => {
            uploadStatus.textContent = '';
            uploadStatus.className = 'upload-status';
          }, 3000);
          
          window.draggedFile = null;
        }
      });
    }
    
    function hideFileInfo() {
      fileInfo.classList.remove('show');
    }
    
    fileDrop.addEventListener('click', () => fileInput.click());
    fileBrowse.addEventListener('click', e => { e.stopPropagation(); fileInput.click(); });
    fileDrop.addEventListener('dragover', e => { e.preventDefault(); fileDrop.classList.add('dragover'); });
    fileDrop.addEventListener('dragleave', e => fileDrop.classList.remove('dragover'));
    fileDrop.addEventListener('drop', e => {
      e.preventDefault();
      fileDrop.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        showFileInfo(file);
        // Don't auto-upload, just load for preview
        // User can manually upload later if needed
      }
    });
    fileInput.addEventListener('change', e => {
      const file = fileInput.files[0];
      if (file) {
        showFileInfo(file);
        // Don't auto-upload, just load for preview
        // User can manually upload later if needed
      }
    });
    
    // Upload button handler
    document.getElementById('uploadBtn').addEventListener('click', () => {
      if (window.currentLocalVideo && window.currentLocalVideo.file) {
        handleFileUpload(window.currentLocalVideo.file);
      }
    });
    async function handleFileUpload(file) {
      if (!file || !file.name.endsWith('.mp4')) {
        uploadStatus.textContent = 'Please select an MP4 file only';
        uploadStatus.className = 'upload-status error';
        hideFileInfo();
        return;
      }
      
      // Check file size (4GB limit)
      const maxSize = 4 * 1024 * 1024 * 1024; // 4GB
      if (file.size > maxSize) {
        const currentSizeGB = (file.size / 1024 / 1024 / 1024).toFixed(2);
        uploadStatus.textContent = `File too large: ${currentSizeGB}GB (max 4GB)`;
        uploadStatus.className = 'upload-status error';
        hideFileInfo();
        return;
      }
      
      if (!currentClassId) {
        uploadStatus.textContent = 'Please select a class first';
        uploadStatus.className = 'upload-status error';
        return;
      }
      
      if (!authToken) {
        uploadStatus.textContent = 'Authentication required. Please login.';
        uploadStatus.className = 'upload-status error';
        return;
      }

      uploadStatus.textContent = `Uploading "${file.name}"...`;
      uploadStatus.className = 'upload-status info';
      progressFill.style.width = '25%';

      const formData = new FormData();
      formData.append('video', file);
      formData.append('classId', currentClassId);

      try {
        const response = await fetch(`${apiBaseUrl}/stream/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          },
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to upload file');
        }

        const result = await response.json();
        progressFill.style.width = '100%';
        uploadStatus.textContent = `Video uploaded successfully! Ready to stream.`;
        uploadStatus.className = 'upload-status success';
        
        // Hide upload button since file is now uploaded
        document.getElementById('uploadBtn').style.display = 'none';
        
        // Update file info
        fileInfoDetails.textContent = fileInfoDetails.textContent.replace('Loaded in player', 'Uploaded to server');
        
        // Load the uploaded video into the preview (replace local version)
        const previewVideo = document.getElementById('previewVideo');
        const placeholder = document.querySelector('.video-preview .placeholder');
        const videoOverlay = document.getElementById('videoOverlay');
        const videoReady = document.getElementById('videoReady');
        
        if (result.streamUrl) {
          // Clean up local video URL
          if (window.currentLocalVideo && window.currentLocalVideo.url) {
            URL.revokeObjectURL(window.currentLocalVideo.url);
          }
          
          previewVideo.src = result.streamUrl;
          previewVideo.style.display = 'block';
          placeholder.style.display = 'none';
          videoOverlay.style.display = 'flex';
          videoReady.style.display = 'block';
          
          // Store the stream info for when user clicks "Go Live"
          window.currentUploadedVideo = {
            url: result.streamUrl,
            filename: result.filename,
            originalName: file.name
          };
          
          // Clear local video reference
          window.currentLocalVideo = null;
          
          uploadStatus.textContent = `"${file.name}" ready to stream! Click "Go Live" to broadcast.`;
        }

        // Clear after 8 seconds
        setTimeout(() => {
          uploadStatus.textContent = '';
          uploadStatus.className = 'upload-status';
          progressFill.style.width = '0';
          hideFileInfo();
        }, 8000);
      } catch (error) {
        console.error('Error uploading file:', error);
        uploadStatus.textContent = `Upload failed: ${error.message}`;
        uploadStatus.className = 'upload-status error';
        progressFill.style.width = '0';
        
        // Clear error after 5 seconds
        setTimeout(() => {
          uploadStatus.textContent = '';
          uploadStatus.className = 'upload-status';
        }, 5000);
      }
    }



    // --- Viewer count ---
    setInterval(async () => {
      try {
        if (currentClassId && authToken) {
          const response = await fetch(`${apiBaseUrl}/stream/viewers/${currentClassId}`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });
          if (response.ok) {
            const data = await response.json();
            document.getElementById('viewerCount').textContent = data.count || 0;
            document.getElementById('viewerCountInfo').textContent = data.count || 0;
          }
        }
      } catch (error) {
        console.error('Error fetching viewer count:', error);
      }
    }, 1800);

    // --- WebRTC Functions ---
    function switchToFileMode() {
      isLiveMode = false;
      streamingMode = 'file';
      
      document.getElementById('fileTab').classList.add('active');
      document.getElementById('liveTab').classList.remove('active');
      
      document.getElementById('liveVideo').style.display = 'none';
      document.getElementById('liveControls').style.display = 'none';
      
      // Show file preview if a file is loaded, otherwise show placeholder
      const previewVideo = document.getElementById('previewVideo');
      const placeholder = document.querySelector('.video-preview .placeholder');
      
      if (window.currentLocalVideo && window.currentLocalVideo.url) {
        previewVideo.style.display = 'block';
        placeholder.style.display = 'none';
      } else {
        previewVideo.style.display = 'none';
        placeholder.style.display = 'flex';
      }
      
      // Stop any live stream
      if (localStream) {
        stopLiveMedia();
      }
      
      console.log('🔄 Switched to file upload mode');
    }
    
    function switchToLiveMode() {
      isLiveMode = true;
      streamingMode = 'webrtc';
      
      document.getElementById('liveTab').classList.add('active');
      document.getElementById('fileTab').classList.remove('active');
      
      document.getElementById('previewVideo').style.display = 'none';
      document.getElementById('liveVideo').style.display = 'block';
      document.getElementById('liveControls').style.display = 'flex';
      
      // Initialize Socket.IO for WebRTC
      if (!socket) {
        initializeWebRTCSocket();
      }
      
      console.log('🔄 Switched to live streaming mode');
    }
    
    function initializeWebRTCSocket() {
      socket = io();
      
      socket.on('connect', () => {
        console.log('🔌 WebRTC Socket connected');
        if (currentClassId) {
          socket.emit('instructor-join-class', { classId: currentClassId });
        }
      });
      
      socket.on('disconnect', () => {
        console.log('❌ WebRTC Socket disconnected');
      });
      
      socket.on('student-joined', (data) => {
        console.log('👤 Student joined:', data.studentId);
        if (isStreaming && localStream) {
          createPeerConnection(data.studentId);
        }
      });
      
      socket.on('student-left', (data) => {
        console.log('👋 Student left:', data.studentId);
        if (peerConnections.has(data.studentId)) {
          peerConnections.get(data.studentId).close();
          peerConnections.delete(data.studentId);
        }
      });
      
      socket.on('webrtc-answer', async (data) => {
        console.log('📡 Received answer from student:', data.from);
        const pc = peerConnections.get(data.from);
        if (pc) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
      });
      
      socket.on('webrtc-ice-candidate', async (data) => {
        console.log('🧊 Received ICE candidate from student:', data.from);
        const pc = peerConnections.get(data.from);
        if (pc) {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      });
    }
    
    async function startCamera() {
      try {
        console.log('📹 Starting camera...');
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: 1280, height: 720 },
          audio: true
        });
        
        document.getElementById('liveVideo').srcObject = localStream;
        document.getElementById('startCameraBtn').style.display = 'none';
        document.getElementById('startScreenBtn').style.display = 'none';
        document.getElementById('stopMediaBtn').style.display = 'inline-block';
        
        console.log('✅ Camera started successfully');
        
        // Notify students that WebRTC streaming has started
        if (socket && currentClassId) {
          socket.emit('instructor-started-webrtc', { 
            classId: currentClassId,
            mediaType: 'Camera'
          });
          console.log('📡 Notified students: WebRTC Camera streaming started');
        }
      } catch (error) {
        console.error('❌ Camera error:', error);
        alert('Failed to access camera. Please check permissions.');
      }
    }
    
    async function startScreen() {
      try {
        console.log('🖥️ Starting screen share...');
        localStream = await navigator.mediaDevices.getDisplayMedia({
          video: { width: 1920, height: 1080 },
          audio: true
        });
        
        document.getElementById('liveVideo').srcObject = localStream;
        document.getElementById('startCameraBtn').style.display = 'none';
        document.getElementById('startScreenBtn').style.display = 'none';
        document.getElementById('stopMediaBtn').style.display = 'inline-block';
        
        // Handle screen share end
        localStream.getVideoTracks()[0].addEventListener('ended', () => {
          console.log('🖥️ Screen share ended by user');
          stopLiveMedia();
        });
        
        console.log('✅ Screen share started successfully');
        
        // Notify students that WebRTC streaming has started
        if (socket && currentClassId) {
          socket.emit('instructor-started-webrtc', { 
            classId: currentClassId,
            mediaType: 'Screen Share'
          });
          console.log('📡 Notified students: WebRTC Screen Share streaming started');
        }
      } catch (error) {
        console.error('❌ Screen share error:', error);
        alert('Failed to start screen share. Please check permissions.');
      }
    }
    
    function stopLiveMedia() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
        document.getElementById('liveVideo').srcObject = null;
        
        document.getElementById('startCameraBtn').style.display = 'inline-block';
        document.getElementById('startScreenBtn').style.display = 'inline-block';
        document.getElementById('stopMediaBtn').style.display = 'none';
        
        if (isStreaming) {
          stopLiveStream();
        }
        
        console.log('⏹️ Live media stopped');
        
        // Notify students that WebRTC streaming has stopped
        if (socket && currentClassId) {
          socket.emit('instructor-stopped-webrtc', { 
            classId: currentClassId
          });
          console.log('📡 Notified students: WebRTC streaming stopped');
        }
      }
    }
    
    async function startLiveStream() {
      if (!currentClassId) {
        alert('Please select a class first');
        return;
      }
      
      if (!localStream) {
        alert('Please start camera or screen share first');
        return;
      }
      
      try {
        console.log('🔴 Starting WebRTC live stream...');
        isStreaming = true;
        
        // Update UI
        document.getElementById('streamStatus').textContent = 'LIVE';
        document.getElementById('streamStatus').className = 'status-badge status-live';
        document.getElementById('streamStatusInfo').textContent = 'Live (WebRTC)';
        
        // Notify server and students
        socket.emit('instructor-start-webrtc', { 
          classId: currentClassId,
          mediaType: localStream.getVideoTracks()[0].label.includes('screen') ? 'Screen Share' : 'Camera'
        });
        
        console.log('✅ WebRTC live stream started');
      } catch (error) {
        console.error('❌ WebRTC stream start error:', error);
        isStreaming = false;
        document.getElementById('streamStatus').textContent = 'ERROR';
        document.getElementById('streamStatus').className = 'status-badge status-offline';
      }
    }
    
    function stopLiveStream() {
      console.log('⏹️ Stopping WebRTC live stream...');
      isStreaming = false;
      
      // Update UI
      document.getElementById('streamStatus').textContent = 'OFFLINE';
      document.getElementById('streamStatus').className = 'status-badge status-offline';
      document.getElementById('streamStatusInfo').textContent = 'Offline';
      
      // Close all peer connections
      peerConnections.forEach((pc, studentId) => {
        pc.close();
      });
      peerConnections.clear();
      
      // Notify server and students
      if (currentClassId && socket) {
        socket.emit('instructor-stop-webrtc', { classId: currentClassId });
      }
      
      console.log('✅ WebRTC live stream stopped');
    }
    
    async function createPeerConnection(studentId) {
      console.log('🔗 Creating peer connection for student:', studentId);
      
      const pc = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });
      
      // Add local stream to peer connection
      if (localStream) {
        localStream.getTracks().forEach(track => {
          pc.addTrack(track, localStream);
        });
      }
      
      // Handle ICE candidates
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit('webrtc-ice-candidate', {
            to: studentId,
            candidate: event.candidate
          });
        }
      };
      
      // Handle connection state changes
      pc.onconnectionstatechange = () => {
        console.log(`🔗 Connection state with ${studentId}: ${pc.connectionState}`);
      };
      
      peerConnections.set(studentId, pc);
      
      // Create and send offer
      try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        socket.emit('webrtc-offer', {
          to: studentId,
          offer: offer
        });
        
        console.log(`📤 Sent offer to student: ${studentId}`);
      } catch (error) {
        console.error(`❌ Error creating offer for ${studentId}:`, error);
      }
    }
    
    // --- Event Listeners for WebRTC ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('startCameraBtn').addEventListener('click', startCamera);
      document.getElementById('startScreenBtn').addEventListener('click', startScreen);
      document.getElementById('stopMediaBtn').addEventListener('click', stopLiveMedia);
      
      // Modify existing Go Live button to handle both modes
      const goLiveBtn = document.getElementById('goLiveBtn');
      const originalGoLive = goLiveBtn.onclick;
      
      goLiveBtn.onclick = function() {
        if (streamingMode === 'webrtc') {
          startLiveStream();
        } else {
          // Call original file-based streaming function
          if (originalGoLive) originalGoLive();
        }
      };
      
      // Modify existing Stop button to handle both modes
      const stopBtn = document.getElementById('stopBtn');
      const originalStop = stopBtn.onclick;
      
      stopBtn.onclick = function() {
        if (streamingMode === 'webrtc') {
          stopLiveStream();
        } else {
          // Call original file-based stop function
          if (originalStop) originalStop();
        }
      };
    });

    // --- Initialize page ---
    document.addEventListener('DOMContentLoaded', () => {
      loadClasses();
    });
    
    // Load classes immediately if DOM is already ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadClasses);
    } else {
      loadClasses();
    }

    // --- Server Uploads ---
    async function fetchServerUploads() {
      try {
        const response = await fetch('/api/stream/uploads');
        if (!response.ok) throw new Error('Failed to fetch uploads');

        const uploads = await response.json();
        const container = document.getElementById('serverUploads');
        container.innerHTML = uploads.map(upload => `
          <div class="upload-item">
            <span>${upload.filename}</span>
            <button onclick="deleteUpload('${upload.filename}')">Delete</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error fetching uploads:', error);
      }
    }

    async function deleteUpload(filename) {
      try {
        const response = await fetch(`/api/stream/uploads/${filename}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete upload');

        alert('Upload deleted successfully');
        fetchServerUploads();
      } catch (error) {
        console.error('Error deleting upload:', error);
      }
    }

    // Fetch uploads on page load
    fetchServerUploads();

    // --- Persistent Submitted Files Management ---
    const SUBMITTED_FILES_KEY = 'smx_submitted_files';
    const LIVE_STREAM_VIDEO_KEY = 'liveStreamVideo';

    // Load submitted files from localStorage
    function loadSubmittedFiles() {
      try {
        const files = JSON.parse(localStorage.getItem(SUBMITTED_FILES_KEY) || '[]');
        console.log('📂 Loaded submitted files from localStorage:', files.length);
        displaySubmittedFiles(files);
        return files;
      } catch (error) {
        console.error('❌ Error loading submitted files:', error);
        return [];
      }
    }

    // Save submitted files to localStorage
    function saveSubmittedFiles(files) {
      try {
        localStorage.setItem(SUBMITTED_FILES_KEY, JSON.stringify(files));
        console.log('💾 Saved submitted files to localStorage:', files.length);
      } catch (error) {
        console.error('❌ Error saving submitted files:', error);
      }
    }

    // Add a new submitted file
    function addSubmittedFile(fileData) {
      const files = loadSubmittedFiles();
      const newFile = {
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        name: fileData.name,
        url: fileData.url,
        size: fileData.size,
        type: fileData.type,
        timestamp: new Date().toISOString(),
        originalFile: fileData.originalFile || null
      };
      
      files.unshift(newFile); // Add to beginning of array (most recent first)
      saveSubmittedFiles(files);
      displaySubmittedFiles(files);
      console.log('🟢 File added to submitted files:', newFile.name);
      return newFile;
    }

    // Delete a submitted file
    function deleteSubmittedFile(fileId) {
      const files = loadSubmittedFiles();
      const fileIndex = files.findIndex(f => f.id === fileId);
      
      if (fileIndex !== -1) {
        const deletedFile = files[fileIndex];
        files.splice(fileIndex, 1);
        saveSubmittedFiles(files);
        displaySubmittedFiles(files);
        console.log('🗑️ File deleted from submitted files:', deletedFile.name);
        
        // Clean up object URL if it exists
        if (deletedFile.url && deletedFile.url.startsWith('blob:')) {
          URL.revokeObjectURL(deletedFile.url);
        }
        
        return true;
      }
      return false;
    }

    // Display submitted files in the UI
    function displaySubmittedFiles(files) {
      const container = document.getElementById('submittedFiles');
      if (!container) return;

      if (files.length === 0) {
        container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic; padding: 12px;">No files submitted yet</div>';
        return;
      }

      container.innerHTML = files.map(file => {
        const fileSize = file.size ? formatFileSize(file.size) : 'Unknown size';
        const timestamp = new Date(file.timestamp).toLocaleString();
        
        return `
          <div class="upload-item" data-file-id="${file.id}">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--text-main);">${file.name}</div>
              <div style="font-size: 0.8rem; color: var(--text-secondary);">${fileSize} • ${timestamp}</div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button onclick="viewSubmittedFile('${file.id}')" style="background: var(--accent); color: white; border: none; border-radius: 4px; padding: 0.3em 0.6em; font-size: 0.8rem; cursor: pointer;">👁️ View</button>
              <button onclick="deleteSubmittedFile('${file.id}')" style="background: var(--error); color: white; border: none; border-radius: 4px; padding: 0.3em 0.6em; font-size: 0.8rem; cursor: pointer;">🗑️ Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // View a submitted file
    function viewSubmittedFile(fileId) {
      const files = loadSubmittedFiles();
      const file = files.find(f => f.id === fileId);
      
      if (file) {
        console.log('👁️ Viewing submitted file:', file.name);
        
        // Load the file into the video player
        const previewVideo = document.getElementById('previewVideo');
        const placeholder = document.querySelector('.video-preview .placeholder');
        const videoOverlay = document.getElementById('videoOverlay');
        const videoReady = document.getElementById('videoReady');
        
        previewVideo.src = file.url;
        previewVideo.style.display = 'block';
        placeholder.style.display = 'none';
        videoOverlay.style.display = 'flex';
        videoReady.style.display = 'block';
        
        // Update current video reference
        window.currentLocalVideo = {
          file: file.originalFile,
          url: file.url,
          name: file.name
        };
        
        // Update upload status
        const uploadStatus = document.getElementById('uploadStatus');
        uploadStatus.textContent = `"${file.name}" loaded from submitted files`;
        uploadStatus.className = 'upload-status success';
        
        // Clear status after 3 seconds
        setTimeout(() => {
          uploadStatus.textContent = '';
          uploadStatus.className = 'upload-status';
        }, 3000);
      }
    }

    // Format file size helper
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Enhanced Go Live functionality
    function enhancedGoLive() {
      console.log('📡 Go Live triggered');
      
      // Get the most recently submitted file
      const files = loadSubmittedFiles();
      if (files.length === 0) {
        alert('No submitted files available. Please upload a video first.');
        return;
      }
      
      const mostRecentFile = files[0]; // First item is most recent
      console.log('🎬 Using most recent file for live stream:', mostRecentFile.name);
      
      // Store the file for the streaming page
      localStorage.setItem(LIVE_STREAM_VIDEO_KEY, JSON.stringify(mostRecentFile));
      console.log('💾 Stored live stream video in localStorage');
      
      // Open SMXStream-new.html in a new tab
      const streamUrl = 'SMXStream-new.html';
      window.open(streamUrl, '_blank');
      console.log('🚀 Opened streaming page in new tab');
      
      // Continue with original go live functionality
      setStatus('live');
    }

    // Enhanced file handling to add files to submitted list
    function enhancedShowFileInfo(file) {
      // Call original showFileInfo
      showFileInfo(file);
      
      // Add file to submitted files list
      const fileData = {
        name: file.name,
        url: URL.createObjectURL(file),
        size: file.size,
        type: file.type,
        originalFile: file
      };
      
      addSubmittedFile(fileData);
    }

    // Make functions globally accessible
    window.deleteSubmittedFile = deleteSubmittedFile;
    window.viewSubmittedFile = viewSubmittedFile;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Override the original Go Live button
      const goLiveBtn = document.getElementById('goLiveBtn');
      if (goLiveBtn) {
        // Store original onclick handler
        const originalOnClick = goLiveBtn.onclick;
        
        // Replace with enhanced functionality
        goLiveBtn.onclick = function() {
          if (streamingMode === 'webrtc') {
            // Use original WebRTC functionality
            startLiveStream();
          } else {
            // Use enhanced file-based functionality
            enhancedGoLive();
          }
        };
      }

      // Override file input handlers to use enhanced functionality
      const fileDrop = document.getElementById('fileDrop');
      const fileInput = document.getElementById('fileInput');
      
      if (fileDrop) {
        // Remove existing event listeners by cloning the element
        const newFileDrop = fileDrop.cloneNode(true);
        fileDrop.parentNode.replaceChild(newFileDrop, fileDrop);
        
        // Add enhanced event listeners
        newFileDrop.addEventListener('click', () => fileInput.click());
        newFileDrop.addEventListener('dragover', e => { 
          e.preventDefault(); 
          newFileDrop.classList.add('dragover'); 
        });
        newFileDrop.addEventListener('dragleave', e => newFileDrop.classList.remove('dragover'));
        newFileDrop.addEventListener('drop', e => {
          e.preventDefault();
          newFileDrop.classList.remove('dragover');
          const file = e.dataTransfer.files[0];
          if (file) {
            enhancedShowFileInfo(file);
          }
        });
      }
      
      if (fileInput) {
        // Remove existing event listeners by cloning the element
        const newFileInput = fileInput.cloneNode(true);
        fileInput.parentNode.replaceChild(newFileInput, fileInput);
        
        // Add enhanced event listener
        newFileInput.addEventListener('change', e => {
          const file = newFileInput.files[0];
          if (file) {
            enhancedShowFileInfo(file);
          }
        });
      }
      
      // Load submitted files on page load
      loadSubmittedFiles();
    });

    // Load submitted files immediately if DOM is already ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadSubmittedFiles);
    } else {
      loadSubmittedFiles();
    }
  </script>
</body>
</html>
