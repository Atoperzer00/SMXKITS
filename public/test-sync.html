<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Data Synchronization</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: white;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .panel {
      background: #2d1810;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #444;
    }
    button {
      background: #ff6b35;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #f7931e;
    }
    textarea {
      width: 100%;
      height: 100px;
      background: #333;
      color: white;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 10px;
      font-family: monospace;
    }
    .log {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-weight: bold;
    }
    .status.success { background: #22c55e; }
    .status.error { background: #ef4444; }
    .status.warning { background: #f59e0b; }
  </style>
</head>
<body>
  <h1>Data Synchronization Test</h1>
  <p>This page helps test the synchronization between the edit page and keyboard training page.</p>
  
  <div class="container">
    <div class="panel">
      <h3>Current Data in localStorage</h3>
      <div id="currentData" style="background: #333; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
      <button onclick="refreshData()">Refresh Data</button>
      <button onclick="clearData()">Clear All Data</button>
    </div>
    
    <div class="panel">
      <h3>Test Editor</h3>
      <p>Module: <select id="moduleSelect"></select></p>
      <p>Practice: <select id="practiceSelect"></select></p>
      <textarea id="testText" placeholder="Enter test text here..."></textarea>
      <br>
      <button onclick="saveTestData()">Save Test Data</button>
      <button onclick="loadTestData()">Load Selected Practice</button>
    </div>
  </div>
  
  <div class="panel">
    <h3>Synchronization Status</h3>
    <div id="syncStatus"></div>
    <button onclick="testSync()">Test Synchronization</button>
    <button onclick="triggerEvents()">Trigger All Events</button>
  </div>
  
  <div class="panel">
    <h3>Event Log</h3>
    <div id="eventLog" class="log"></div>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <script>
    let eventLog = [];
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      eventLog.push(logMessage);
      document.getElementById('eventLog').textContent = eventLog.join('\n');
      document.getElementById('eventLog').scrollTop = document.getElementById('eventLog').scrollHeight;
      console.log(logMessage);
    }
    
    function clearLog() {
      eventLog = [];
      document.getElementById('eventLog').textContent = '';
    }
    
    function refreshData() {
      const data = localStorage.getItem('smx_typing_tests');
      if (data) {
        try {
          const parsed = JSON.parse(data);
          document.getElementById('currentData').textContent = JSON.stringify(parsed, null, 2);
          populateSelectors(parsed);
          log('Data refreshed successfully');
        } catch (e) {
          document.getElementById('currentData').textContent = 'Error parsing data: ' + e.message;
          log('Error parsing data: ' + e.message);
        }
      } else {
        document.getElementById('currentData').textContent = 'No data found in localStorage';
        log('No data found in localStorage');
      }
    }
    
    function populateSelectors(data) {
      const moduleSelect = document.getElementById('moduleSelect');
      const practiceSelect = document.getElementById('practiceSelect');
      
      moduleSelect.innerHTML = '';
      practiceSelect.innerHTML = '';
      
      if (data.modules && data.moduleNames) {
        data.moduleNames.forEach((name, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = `${index}: ${name}`;
          moduleSelect.appendChild(option);
        });
        
        if (data.modules[0]) {
          data.modules[0].forEach((_, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Practice ${index + 1}`;
            practiceSelect.appendChild(option);
          });
        }
      }
      
      moduleSelect.onchange = () => {
        const moduleIndex = parseInt(moduleSelect.value);
        practiceSelect.innerHTML = '';
        if (data.modules[moduleIndex]) {
          data.modules[moduleIndex].forEach((_, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Practice ${index + 1}`;
            practiceSelect.appendChild(option);
          });
        }
      };
    }
    
    function loadTestData() {
      const data = JSON.parse(localStorage.getItem('smx_typing_tests') || '{}');
      const moduleIndex = parseInt(document.getElementById('moduleSelect').value);
      const practiceIndex = parseInt(document.getElementById('practiceSelect').value);
      
      if (data.modules && data.modules[moduleIndex] && data.modules[moduleIndex][practiceIndex]) {
        document.getElementById('testText').value = data.modules[moduleIndex][practiceIndex];
        log(`Loaded Module ${moduleIndex}, Practice ${practiceIndex}`);
      } else {
        log(`No data found for Module ${moduleIndex}, Practice ${practiceIndex}`);
      }
    }
    
    function saveTestData() {
      const data = JSON.parse(localStorage.getItem('smx_typing_tests') || '{}');
      const moduleIndex = parseInt(document.getElementById('moduleSelect').value);
      const practiceIndex = parseInt(document.getElementById('practiceSelect').value);
      const newText = document.getElementById('testText').value;
      
      if (!data.modules) {
        log('No valid data structure found');
        return;
      }
      
      if (!data.modules[moduleIndex]) {
        log(`Module ${moduleIndex} not found`);
        return;
      }
      
      data.modules[moduleIndex][practiceIndex] = newText;
      
      // Save using the same method as edit-typing-tests.html
      localStorage.setItem('smx_typing_tests', JSON.stringify(data));
      localStorage.setItem('smx_typing_tests_timestamp', Date.now().toString());
      
      // Trigger events
      window.dispatchEvent(new CustomEvent('typingTestsUpdated', {
        detail: { data: data }
      }));
      
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('smx_typing_updates');
        channel.postMessage({
          type: 'typing_tests_updated',
          data: data,
          timestamp: Date.now()
        });
        channel.close();
      }
      
      localStorage.setItem('smx_typing_tests_update_trigger', Date.now().toString());
      
      log(`Saved Module ${moduleIndex}, Practice ${practiceIndex}: "${newText.substring(0, 50)}..."`);
      refreshData();
    }
    
    function clearData() {
      if (confirm('Are you sure you want to clear all typing test data?')) {
        localStorage.removeItem('smx_typing_tests');
        localStorage.removeItem('smx_typing_tests_timestamp');
        localStorage.removeItem('smx_typing_tests_update_trigger');
        refreshData();
        log('All data cleared');
      }
    }
    
    function testSync() {
      const statusDiv = document.getElementById('syncStatus');
      statusDiv.innerHTML = '';
      
      // Test localStorage
      const data = localStorage.getItem('smx_typing_tests');
      if (data) {
        statusDiv.innerHTML += '<div class="status success">✓ localStorage data exists</div>';
      } else {
        statusDiv.innerHTML += '<div class="status error">✗ No localStorage data found</div>';
      }
      
      // Test BroadcastChannel support
      if (typeof BroadcastChannel !== 'undefined') {
        statusDiv.innerHTML += '<div class="status success">✓ BroadcastChannel supported</div>';
      } else {
        statusDiv.innerHTML += '<div class="status warning">⚠ BroadcastChannel not supported (using fallback)</div>';
      }
      
      // Test timestamp
      const timestamp = localStorage.getItem('smx_typing_tests_timestamp');
      if (timestamp) {
        const date = new Date(parseInt(timestamp));
        statusDiv.innerHTML += `<div class="status success">✓ Last update: ${date.toLocaleString()}</div>`;
      } else {
        statusDiv.innerHTML += '<div class="status warning">⚠ No timestamp found</div>';
      }
      
      log('Synchronization test completed');
    }
    
    function triggerEvents() {
      const data = JSON.parse(localStorage.getItem('smx_typing_tests') || '{}');
      
      // Trigger custom event
      window.dispatchEvent(new CustomEvent('typingTestsUpdated', {
        detail: { data: data }
      }));
      log('Triggered typingTestsUpdated event');
      
      // Trigger BroadcastChannel
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('smx_typing_updates');
        channel.postMessage({
          type: 'typing_tests_updated',
          data: data,
          timestamp: Date.now()
        });
        channel.close();
        log('Triggered BroadcastChannel message');
      }
      
      // Update timestamp
      localStorage.setItem('smx_typing_tests_timestamp', Date.now().toString());
      localStorage.setItem('smx_typing_tests_update_trigger', Date.now().toString());
      log('Updated timestamps');
    }
    
    // Event listeners
    window.addEventListener('storage', function(e) {
      if (e.key === 'smx_typing_tests' || e.key === 'smx_typing_tests_update_trigger') {
        log('Storage event detected: ' + e.key);
        refreshData();
      }
    });
    
    window.addEventListener('typingTestsUpdated', function(e) {
      log('typingTestsUpdated event detected');
    });
    
    if (typeof BroadcastChannel !== 'undefined') {
      const channel = new BroadcastChannel('smx_typing_updates');
      channel.addEventListener('message', function(e) {
        if (e.data.type === 'typing_tests_updated') {
          log('BroadcastChannel message received');
        }
      });
    }
    
    // Initialize
    refreshData();
    testSync();
    log('Test page initialized');
  </script>
</body>
</html>