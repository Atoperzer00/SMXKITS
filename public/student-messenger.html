<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SMX KITS - Student Messenger</title>
  <link rel="stylesheet" href="style.css" />
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
      --card-gradient: linear-gradient(145deg, #16213e 0%, #0f1419 100%);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: #b8c5d6;
      --text-accent: #64b5f6;
      --shadow-primary: 0 20px 40px rgba(0, 0, 0, 0.3);
      --shadow-hover: 0 30px 60px rgba(0, 0, 0, 0.4);
      --border-radius: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --online-green: #00cc66;
      --away-orange: #ff9900;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark-gradient);
      color: var(--text-primary);
      overflow: hidden;
      line-height: 1.6;
      height: 100vh;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
      z-index: -1;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-20px) rotate(1deg); }
      66% { transform: translateY(10px) rotate(-1deg); }
    }

    .messaging-layout {
      display: flex;
      height: 100vh;
      background: transparent;
    }

    /* Header Bar */
    .messaging-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: var(--card-gradient);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      z-index: 1000;
      box-shadow: var(--shadow-primary);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .back-button {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-accent);
    }

    .back-button:hover {
      background: var(--accent-gradient);
      color: white;
      transform: scale(1.1);
    }

    .messaging-title {
      font-size: 1.8rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header-button {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 25px;
      padding: 0.7rem 1.5rem;
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-button:hover {
      background: var(--accent-gradient);
      color: white;
      transform: translateY(-2px);
    }

    /* Sidebar - Contact List */
    .contacts-sidebar {
      width: 320px;
      background: var(--card-gradient);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--glass-border);
      margin-top: 70px;
      height: calc(100vh - 70px);
      display: flex;
      flex-direction: column;
    }

    .contacts-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--glass-border);
      background: var(--glass-bg);
    }

    .search-box {
      width: 100%;
      padding: 0.8rem 1rem;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 25px;
      color: var(--text-primary);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .search-box::placeholder {
      color: var(--text-secondary);
    }

    .contacts-tabs {
      display: flex;
      gap: 0.5rem;
    }

    .tab-button {
      flex: 1;
      padding: 0.6rem;
      background: transparent;
      border: 1px solid var(--glass-border);
      border-radius: 15px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.8rem;
      font-weight: 500;
    }

    .tab-button.active {
      background: var(--accent-gradient);
      color: white;
      border-color: transparent;
    }

    .contacts-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      border-left: 3px solid transparent;
      position: relative;
    }

    .contact-item:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .contact-item.active {
      background: rgba(79, 172, 254, 0.15);
      border-left-color: var(--accent-gradient);
    }

    .contact-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
      position: relative;
    }

    .status-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--dark-gradient);
    }

    .status-online { background: var(--online-green); }
    .status-away { background: var(--away-orange); }
    .status-offline { background: var(--text-secondary); }

    .contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
      margin-bottom: 0.2rem;
    }

    .contact-status {
      color: var(--text-secondary);
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .last-message {
      color: var(--text-secondary);
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 0.2rem;
    }

    .conversation-time {
      color: var(--text-secondary);
      font-size: 0.7rem;
      position: absolute;
      top: 1rem;
      right: 1rem;
    }

    .unread-badge {
      background: var(--accent-gradient);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      position: absolute;
      top: 0.8rem;
      right: 0.8rem;
    }

    /* Main Chat Area */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-top: 70px;
      height: calc(100vh - 70px);
    }

    .chat-header {
      padding: 1.5rem 2rem;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .chat-user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--secondary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      position: relative;
    }

    .chat-user-details h3 {
      color: var(--text-primary);
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .chat-user-details p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .chat-actions {
      display: flex;
      gap: 1rem;
    }

    .chat-action-btn {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-accent);
    }

    .chat-action-btn:hover {
      background: var(--accent-gradient);
      color: white;
      transform: scale(1.1);
    }

    /* Messages Area */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      display: flex;
      gap: 1rem;
      max-width: 70%;
      animation: messageSlide 0.3s ease-out;
    }

    .message.sent {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.received {
      align-self: flex-start;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .message.sent .message-avatar {
      background: var(--secondary-gradient);
    }

    .message-content {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 1rem 1.5rem;
      position: relative;
    }

    .message.sent .message-content {
      background: var(--accent-gradient);
      color: white;
    }

    .message-text {
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }

    .message-time {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-align: right;
    }

    .message.sent .message-time {
      color: rgba(255, 255, 255, 0.8);
    }

    /* Message Input Area */
    .message-input-area {
      padding: 1.5rem 2rem;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--glass-border);
      display: flex;
      gap: 1rem;
      align-items: flex-end;
    }

    .input-actions {
      display: flex;
      gap: 0.5rem;
    }

    .input-action-btn {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-accent);
    }

    .input-action-btn:hover {
      background: var(--accent-gradient);
      color: white;
      transform: scale(1.1);
    }

    .message-input {
      flex: 1;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 25px;
      padding: 1rem 1.5rem;
      color: var(--text-primary);
      font-size: 1rem;
      resize: none;
      min-height: 50px;
      max-height: 120px;
      font-family: inherit;
    }

    .message-input::placeholder {
      color: var(--text-secondary);
    }

    .send-button {
      background: var(--accent-gradient);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      color: white;
      font-size: 1.2rem;
    }

    .send-button:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-hover);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--card-gradient);
      border-radius: var(--border-radius);
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-primary);
      border: 1px solid var(--glass-border);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-close:hover {
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <div class="messaging-layout">
    <!-- Header Bar -->
    <div class="messaging-header">
      <div class="header-left">
        <button class="back-button" onclick="goBack()">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="messaging-title">Student Messenger</h1>
      </div>
      <div class="header-actions">
        <button class="header-button" onclick="openNewChatModal()">
          <i class="fas fa-plus"></i>
          New Chat
        </button>
        <div class="online-status" style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
          <div class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--online-green);"></div>
          <span>Connected</span>
        </div>
      </div>
    </div>

    <!-- Sidebar - Conversations List -->
    <div class="contacts-sidebar">
      <div class="contacts-header">
        <input type="text" class="search-box" placeholder="Search conversations..." onkeyup="searchConversations(this.value)">
        <div class="contacts-tabs">
          <button class="tab-button active" onclick="switchTab('recent')">Recent</button>
          <button class="tab-button" onclick="switchTab('unread')">Unread</button>
          <button class="tab-button" onclick="switchTab('all')">All</button>
        </div>
      </div>
      <div class="contacts-list" id="conversationsList">
        <!-- Conversations will be loaded here -->
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
      <div class="chat-header">
        <div class="chat-user-info">
          <div class="chat-user-avatar">
            <div class="status-indicator status-online"></div>
          </div>
          <div class="chat-user-details">
            <h3 id="chatUserName">Select a contact</h3>
            <p id="chatUserStatus">Choose someone to start messaging</p>
          </div>
        </div>
        <div class="chat-actions">
          <button class="chat-action-btn" onclick="attachFile()">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="chat-action-btn" onclick="recordVoice()">
            <i class="fas fa-microphone"></i>
          </button>
        </div>
      </div>

      <div class="messages-container">
        <!-- Messages will be loaded here -->
      </div>

      <div class="message-input-area">
        <div class="input-actions">
          <button class="input-action-btn" onclick="attachFile()">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="input-action-btn" onclick="insertEmoji()">
            <i class="fas fa-smile"></i>
          </button>
        </div>
        <textarea 
          id="messageInput" 
          class="message-input" 
          placeholder="Type your message..." 
          onkeydown="handleKeyDown(event)"
          oninput="handleTyping()"
        ></textarea>
        <button class="send-button" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- New Chat Modal -->
  <div class="modal" id="newChatModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Start New Conversation</h3>
        <button class="modal-close" onclick="closeModal('newChatModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 1rem;">
          <input type="text" id="userSearch" style="width: 100%; padding: 0.8rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-primary);" placeholder="Search users..." oninput="searchUsersInModal()">
        </div>
        <div id="userSearchResults" style="max-height: 300px; overflow-y: auto;">
          <!-- Search results will appear here -->
        </div>
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button onclick="closeModal('newChatModal')" style="padding: 0.8rem 1.5rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-primary); cursor: pointer;">Cancel</button>
          <button onclick="startNewChat()" style="padding: 0.8rem 1.5rem; background: var(--accent-gradient); border: none; border-radius: 10px; color: white; cursor: pointer; font-weight: 600;">Start Chat</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentContact = null;
    let currentContactId = null;
    let currentContactType = 'individual';
    let typingTimer;
    let isTyping = false;
    let socket;
    let selectedUserForNewChat = null;
    let currentUser = null;
    let contacts = [];
    let conversations = [];
    let onlineUsers = new Set(); // Track online users

    // Initialize Socket.IO connection
    function initializeSocket() {
      socket = io();
      
      socket.on('connect', function() {
        console.log('Connected to server');
        updateConnectionStatus(true);
        
        // Join user to their private room for direct messages
        if (currentUser) {
          socket.emit('join_user_room', { userId: currentUser.id });
        }
      });

      socket.on('disconnect', function() {
        console.log('Disconnected from server');
        updateConnectionStatus(false);
      });

      // Handle incoming direct messages
      socket.on('direct_message', function(message) {
        receiveDirectMessage(message);
      });

      // Handle conversation updates
      socket.on('conversation_updated', function(data) {
        updateConversationList();
      });

      socket.on('typing', function(data) {
        showTypingIndicator(data.username);
      });

      socket.on('stop_typing', function(data) {
        hideTypingIndicator();
      });

      socket.on('error', function(data) {
        showNotification(data.message, 'error');
      });

      // Handle online status updates
      socket.on('user_online', function(data) {
        console.log('👤 User came online:', data.userId);
        onlineUsers.add(data.userId);
        updateContactOnlineStatus(data.userId, true);
      });

      socket.on('user_offline', function(data) {
        console.log('👤 User went offline:', data.userId);
        onlineUsers.delete(data.userId);
        updateContactOnlineStatus(data.userId, false);
      });

      // Handle online users list
      socket.on('online_users', function(data) {
        console.log('👥 Online users list:', data.users);
        onlineUsers = new Set(data.users);
        updateAllContactsOnlineStatus();
      });
    }

    // Initialize the messaging interface
    document.addEventListener('DOMContentLoaded', async function() {
      // Get current user info
      await initializeUser();
      
      // Initialize socket connection
      initializeSocket();
      
      // Load conversations and contacts
      await loadConversations();
      await loadContacts(); // Keep for new chat modal
      
      // Check if we came from a specific contact
      const selectedContact = localStorage.getItem('selectedContact');
      if (selectedContact) {
        // Find the contact and select them
        const contact = contacts.find(c => c._id === selectedContact);
        if (contact) {
          selectContact(contact._id, contact.name, contact.role);
        }
        localStorage.removeItem('selectedContact');
      } else {
        // Show welcome message if no contact selected
        showWelcomeMessage();
      }

      // Auto-resize message input
      const messageInput = document.getElementById('messageInput');
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });
    });

    // Initialize current user from localStorage/token
    async function initializeUser() {
      // Try to get user data from the user object first (dashboard format)
      const userData = localStorage.getItem('user');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          currentUser = {
            id: user.id,
            name: user.name,
            role: user.role,
            token: user.token
          };
          console.log('✅ Current user initialized from user object:', currentUser);
          return;
        } catch (e) {
          console.warn('⚠️ Failed to parse user data from localStorage');
        }
      }

      // Fallback to individual localStorage items
      const token = localStorage.getItem('token');
      const userName = localStorage.getItem('userName');
      const userRole = localStorage.getItem('role');
      const userId = localStorage.getItem('userId');
      
      if (!token || !userName) {
        console.error('❌ Missing user data, redirecting to login');
        window.location.href = 'login.html';
        return;
      }

      currentUser = {
        id: userId || 'temp-id',
        name: userName,
        role: userRole || 'student',
        token: token
      };

      console.log('✅ Current user initialized from individual items:', currentUser);
    }

    // Load available contacts based on user role
    async function loadContacts() {
      try {
        const response = await fetch('/api/direct-messages/contacts', {
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          contacts = await response.json();
          renderContactsList();
        } else {
          console.error('Failed to load contacts');
          // Show welcome message with demo contact
          showWelcomeMessage();
        }
      } catch (error) {
        console.error('Error loading contacts:', error);
        showWelcomeMessage();
      }
    }

    // Load user's conversations
    async function loadConversations() {
      try {
        const response = await fetch('/api/direct-messages/conversations', {
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          conversations = await response.json();
          renderConversationsList();
        } else {
          console.error('Failed to load conversations');
          showWelcomeMessage();
        }
      } catch (error) {
        console.error('Error loading conversations:', error);
        showWelcomeMessage();
      }
    }

    // Render conversations list in sidebar
    function renderConversationsList() {
      const conversationsList = document.getElementById('conversationsList');
      
      if (conversations.length === 0) {
        conversationsList.innerHTML = `
          <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
            <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>No conversations yet</p>
            <p style="font-size: 0.8rem; margin-top: 0.5rem;">Start a new conversation to see it here</p>
            <button onclick="openNewChatModal()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--accent-gradient); border: none; border-radius: 15px; color: white; font-size: 0.8rem; cursor: pointer;">
              <i class="fas fa-plus" style="margin-right: 0.5rem;"></i>
              New Chat
            </button>
          </div>
        `;
        return;
      }

      conversationsList.innerHTML = conversations.map(conversation => {
        const otherParticipant = conversation.otherParticipant;
        if (!otherParticipant) return '';
        
        const initials = otherParticipant.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const roleColor = otherParticipant.role === 'instructor' ? 'var(--primary-gradient)' : 
                         otherParticipant.role === 'admin' ? 'var(--secondary-gradient)' : 
                         'var(--accent-gradient)';
        
        const lastMessage = conversation.lastMessage;
        const lastMessageText = lastMessage ? lastMessage.content : 'No messages yet';
        const lastMessageTime = lastMessage ? formatTime(new Date(lastMessage.timestamp)) : '';
        const unreadCount = conversation.unreadCount || 0;
        
        const isOnline = onlineUsers.has(otherParticipant.id);
        const statusClass = isOnline ? 'status-online' : 'status-offline';
        
        return `
          <div class="contact-item" data-contact-id="${otherParticipant.id}" onclick="selectContact('${otherParticipant.id}', '${otherParticipant.name}', '${otherParticipant.role}')">
            <div class="contact-avatar" style="background: ${roleColor};">
              ${initials}
              <div class="status-indicator ${statusClass}"></div>
            </div>
            <div class="contact-info">
              <div class="contact-name">${otherParticipant.name}</div>
              <div class="last-message">${lastMessageText}</div>
            </div>
            ${lastMessageTime ? `<div class="conversation-time">${lastMessageTime}</div>` : ''}
            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // Render contacts list in sidebar (for new chat modal)
    function renderContactsList() {
      // This function is now only used for the new chat modal
      // The main sidebar shows conversations
    }

    // Format time for conversation list
    function formatTime(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'now';
      if (minutes < 60) return `${minutes}m`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;
      return date.toLocaleDateString();
    }

    // Show welcome message when no contacts or conversations
    function showWelcomeMessage() {
      const messagesContainer = document.querySelector('.messages-container');
      const chatUserName = document.getElementById('chatUserName');
      const chatUserStatus = document.getElementById('chatUserStatus');
      
      // Update header
      if (chatUserName) chatUserName.textContent = 'SMX KITS Student Messenger';
      if (chatUserStatus) chatUserStatus.textContent = 'Welcome to the messaging system';
      
      // Show welcome message
      messagesContainer.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 2rem;">
          <div style="background: var(--accent-gradient); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 2rem;">
            <i class="fas fa-comments" style="font-size: 2rem; color: white;"></i>
          </div>
          <h2 style="color: var(--text-primary); margin-bottom: 1rem;">Welcome to SMX KITS Student Messenger!</h2>
          <p style="color: var(--text-secondary); max-width: 500px; line-height: 1.6; margin-bottom: 2rem;">
            This is your secure messaging platform where you can communicate with instructors, administrators, and fellow students. 
            Here's how to get started:
          </p>
          <div style="text-align: left; max-width: 400px; color: var(--text-secondary);">
            <div style="margin-bottom: 1rem;">
              <i class="fas fa-user-friends" style="color: var(--text-accent); margin-right: 0.5rem;"></i>
              <strong>Find Contacts:</strong> Your instructors and classmates will appear in the left sidebar
            </div>
            <div style="margin-bottom: 1rem;">
              <i class="fas fa-comment-dots" style="color: var(--text-accent); margin-right: 0.5rem;"></i>
              <strong>Start Chatting:</strong> Click on any contact to begin a conversation
            </div>
            <div style="margin-bottom: 1rem;">
              <i class="fas fa-bell" style="color: var(--text-accent); margin-right: 0.5rem;"></i>
              <strong>Stay Updated:</strong> You'll receive real-time notifications for new messages
            </div>
            <div>
              <i class="fas fa-shield-alt" style="color: var(--text-accent); margin-right: 0.5rem;"></i>
              <strong>Secure & Private:</strong> All messages are encrypted and stored securely
            </div>
          </div>
          <button onclick="openNewChatModal()" style="margin-top: 2rem; padding: 1rem 2rem; background: var(--accent-gradient); border: none; border-radius: 25px; color: white; font-weight: 600; cursor: pointer; transition: var(--transition);">
            <i class="fas fa-plus" style="margin-right: 0.5rem;"></i>
            Start Your First Conversation
          </button>
        </div>
      `;
    }

    function updateConnectionStatus(connected) {
      const statusElement = document.querySelector('.online-status span');
      const statusDot = document.querySelector('.status-dot');
      
      if (connected) {
        statusElement.textContent = 'Connected';
        statusDot.style.background = 'var(--online-green)';
      } else {
        statusElement.textContent = 'Disconnected';
        statusDot.style.background = 'var(--secondary-gradient)';
      }
    }

    function goBack() {
      window.location.href = 'dashboard.html';
    }

    function selectContact(contactId, contactName, contactRole) {
      currentContactId = contactId;
      currentContact = contactName;
      currentContactType = contactRole;
      
      // Update active contact in sidebar
      document.querySelectorAll('.contact-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Find and activate the clicked contact
      const contactItems = document.querySelectorAll('.contact-item');
      contactItems.forEach(item => {
        if (item.onclick && item.onclick.toString().includes(contactId)) {
          item.classList.add('active');
        }
      });

      // Update chat header
      updateChatHeader(contactName, contactRole);
      
      // Load messages for this contact
      loadConversationMessages(contactId);
    }

    // Load messages for a specific conversation
    async function loadConversationMessages(contactId) {
      try {
        const response = await fetch(`/api/direct-messages/conversation/${contactId}`, {
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const messages = await response.json();
          renderMessages(messages);
        } else {
          console.error('Failed to load conversation');
          renderMessages([]);
        }
      } catch (error) {
        console.error('Error loading conversation:', error);
        renderMessages([]);
      }
    }

    // Render messages in the chat area
    function renderMessages(messages) {
      const messagesContainer = document.querySelector('.messages-container');
      
      if (messages.length === 0) {
        messagesContainer.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 2rem;">
            <div style="background: var(--glass-bg); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
              <i class="fas fa-comment" style="font-size: 1.5rem; color: var(--text-accent);"></i>
            </div>
            <p style="color: var(--text-secondary);">No messages yet</p>
            <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.5rem;">Start the conversation by sending a message below</p>
          </div>
        `;
        return;
      }

      console.log('🔍 Rendering messages:');
      console.log('   - Current user ID:', currentUser?.id);
      console.log('   - Messages count:', messages.length);
      
      messagesContainer.innerHTML = messages.map(message => {
        const isFromCurrentUser = message.sender.id === currentUser?.id;
        const messageClass = isFromCurrentUser ? 'sent' : 'received';
        const senderInitials = message.sender.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        console.log(`   - Message from ${message.sender.name} (${message.sender.id}): ${isFromCurrentUser ? 'SENT' : 'RECEIVED'}`);
        
        return `
          <div class="message ${messageClass}">
            <div class="message-avatar">${isFromCurrentUser ? 'ME' : senderInitials}</div>
            <div class="message-content">
              <div class="message-text">${message.content}</div>
              <div class="message-time">${time}</div>
            </div>
          </div>
        `;
      }).join('');

      scrollToBottom();
    }

    // Send a message
    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const content = messageInput.value.trim();
      
      if (!content || !currentContactId) {
        return;
      }

      try {
        const response = await fetch('/api/direct-messages/send', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            recipientId: currentContactId,
            content: content
          })
        });

        if (response.ok) {
          const message = await response.json();
          
          // Add message to UI immediately
          addMessageToUI(message);
          
          // Clear input
          messageInput.value = '';
          messageInput.style.height = 'auto';
          
          // Update conversation list
          updateConversationList();
        } else {
          showNotification('Failed to send message', 'error');
        }
      } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Error sending message', 'error');
      }
    }

    // Add message to UI
    function addMessageToUI(message, isFromCurrentUser = null) {
      const messagesContainer = document.querySelector('.messages-container');
      
      // Determine if message is from current user
      if (isFromCurrentUser === null) {
        isFromCurrentUser = message.sender.id === currentUser?.id;
      }
      
      console.log('🔍 Adding message to UI:');
      console.log('   - Message sender ID:', message.sender.id);
      console.log('   - Current user ID:', currentUser?.id);
      console.log('   - Is from current user:', isFromCurrentUser);
      
      const messageClass = isFromCurrentUser ? 'sent' : 'received';
      const senderInitials = message.sender.name.split(' ').map(n => n[0]).join('').toUpperCase();
      const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      const messageElement = document.createElement('div');
      messageElement.className = `message ${messageClass}`;
      messageElement.innerHTML = `
        <div class="message-avatar">${isFromCurrentUser ? 'ME' : senderInitials}</div>
        <div class="message-content">
          <div class="message-text">${message.content}</div>
          <div class="message-time">${time}</div>
        </div>
      `;
      
      // Remove welcome message if it exists
      const welcomeMessage = messagesContainer.querySelector('[style*="justify-content: center"]');
      if (welcomeMessage) {
        messagesContainer.innerHTML = '';
      }
      
      messagesContainer.appendChild(messageElement);
      scrollToBottom();
    }

    // Handle incoming direct messages
    function receiveDirectMessage(message) {
      // Only show if it's for the current conversation
      if (currentContactId && 
          (message.sender.id === currentContactId || message.recipient.id === currentContactId)) {
        addMessageToUI(message);
      }
      
      // Update conversation list
      updateConversationList();
      
      // Show notification if not in current conversation
      if (!currentContactId || message.sender.id !== currentContactId) {
        showNotification(`New message from ${message.sender.name}`, 'info');
      }
    }

    // Update conversation list
    async function updateConversationList() {
      try {
        await loadConversations();
        console.log('Conversation list updated');
      } catch (error) {
        console.error('Error updating conversation list:', error);
      }
    }

    function updateChatHeader(contactName, contactRole) {
      const chatUserName = document.getElementById('chatUserName');
      const chatUserStatus = document.getElementById('chatUserStatus');
      const chatUserAvatar = document.querySelector('.chat-user-avatar');

      if (chatUserName) chatUserName.textContent = contactName;
      if (chatUserStatus) {
        const isOnline = onlineUsers.has(currentContactId);
        const statusText = isOnline ? 
          (contactRole === 'instructor' ? 'Online - Available for questions' :
           contactRole === 'admin' ? 'Online - Administrative support' :
           'Online - Student') :
          'Offline';
        chatUserStatus.textContent = statusText;
      }
      
      if (chatUserAvatar) {
        const initials = contactName.split(' ').map(n => n[0]).join('').toUpperCase();
        const roleColor = contactRole === 'instructor' ? 'var(--primary-gradient)' : 
                         contactRole === 'admin' ? 'var(--secondary-gradient)' : 
                         'var(--accent-gradient)';
        
        chatUserAvatar.textContent = initials;
        chatUserAvatar.style.background = roleColor;
        
        // Add status indicator
        const existingIndicator = chatUserAvatar.querySelector('.status-indicator');
        if (existingIndicator) {
          existingIndicator.remove();
        }
        
        const statusIndicator = document.createElement('div');
        const isOnline = onlineUsers.has(currentContactId);
        statusIndicator.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
        chatUserAvatar.appendChild(statusIndicator);
      }
    }

    // Update contact online status
    function updateContactOnlineStatus(userId, isOnline) {
      // Update in contacts list
      const contactElements = document.querySelectorAll('.contact-item');
      contactElements.forEach(element => {
        if (element.dataset.contactId === userId) {
          const statusIndicator = element.querySelector('.status-indicator');
          if (statusIndicator) {
            statusIndicator.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
          }
        }
      });

      // Update chat header if this is the current contact
      if (currentContactId === userId) {
        const contact = contacts.find(c => c._id === userId);
        if (contact) {
          updateChatHeader(contact.name, contact.role);
        }
      }
    }

    // Update all contacts online status
    function updateAllContactsOnlineStatus() {
      contacts.forEach(contact => {
        updateContactOnlineStatus(contact._id, onlineUsers.has(contact._id));
      });
    }

    // Handle key down events for message input
    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // Handle typing indicators
    function handleTyping() {
      if (!isTyping && currentContactId) {
        isTyping = true;
        if (socket) {
          socket.emit('typing', {
            room: currentContactId,
            username: currentUser.name
          });
        }
      }

      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        isTyping = false;
        if (socket) {
          socket.emit('stop_typing', { room: currentContactId });
        }
      }, 1000);
    }

    // Scroll to bottom of messages
    function scrollToBottom() {
      const messagesContainer = document.querySelector('.messages-container');
      if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? 'var(--secondary-gradient)' : 'var(--accent-gradient)'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: var(--shadow-primary);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.style.transform = 'translateX(0)', 100);
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // Modal functions
    function openNewChatModal() {
      const modal = document.getElementById('newChatModal');
      modal.classList.add('active');
      loadAvailableUsers();
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('active');
    }

    function loadAvailableUsers() {
      const userSearchResults = document.getElementById('userSearchResults');
      
      if (contacts.length === 0) {
        userSearchResults.innerHTML = `
          <div style="padding: 1rem; text-align: center; color: var(--text-secondary);">
            <p>No contacts available</p>
          </div>
        `;
        return;
      }

      userSearchResults.innerHTML = contacts.map(contact => {
        const initials = contact.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const roleColor = contact.role === 'instructor' ? 'var(--primary-gradient)' : 
                         contact.role === 'admin' ? 'var(--secondary-gradient)' : 
                         'var(--accent-gradient)';
        
        return `
          <div style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem; cursor: pointer; border-radius: 8px;" onclick="selectUserForChat(this, '${contact._id}', '${contact.name}', '${contact.role}')">
            <div style="width: 35px; height: 35px; border-radius: 50%; background: ${roleColor}; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">${initials}</div>
            <div>
              <div style="font-weight: 600; color: var(--text-primary);">${contact.name}</div>
              <div style="font-size: 0.8rem; color: var(--text-secondary);">Online - ${contact.role.charAt(0).toUpperCase() + contact.role.slice(1)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function selectUserForChat(element, userId, userName, userRole) {
      // Remove previous selection
      document.querySelectorAll('#userSearchResults > div').forEach(div => {
        div.style.background = 'transparent';
      });
      
      // Highlight selected user
      element.style.background = 'rgba(79, 172, 254, 0.15)';
      
      selectedUserForNewChat = { id: userId, name: userName, role: userRole };
    }

    function startNewChat() {
      if (!selectedUserForNewChat) {
        showNotification('Please select a user to chat with', 'error');
        return;
      }

      // Close modal
      closeModal('newChatModal');
      
      // Select the contact
      selectContact(selectedUserForNewChat.id, selectedUserForNewChat.name, selectedUserForNewChat.role);
      
      // Reset selection
      selectedUserForNewChat = null;
    }

    function searchUsersInModal() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const userItems = document.querySelectorAll('#userSearchResults > div');
      
      userItems.forEach(item => {
        const userName = item.querySelector('div:last-child > div:first-child').textContent.toLowerCase();
        item.style.display = userName.includes(searchTerm) ? 'flex' : 'none';
      });
    }

    function searchConversations(searchTerm) {
      const conversationItems = document.querySelectorAll('.contact-item');
      conversationItems.forEach(item => {
        const contactName = item.querySelector('.contact-name')?.textContent.toLowerCase() || '';
        const lastMessage = item.querySelector('.last-message')?.textContent.toLowerCase() || '';
        const matches = contactName.includes(searchTerm.toLowerCase()) || 
                       lastMessage.includes(searchTerm.toLowerCase());
        item.style.display = matches ? 'flex' : 'none';
      });
    }

    function searchContacts(searchTerm) {
      // Keep this for backward compatibility
      searchConversations(searchTerm);
    }

    // Placeholder functions for UI elements
    function attachFile() {
      showNotification('File attachment feature coming soon!', 'info');
    }

    function insertEmoji() {
      showNotification('Emoji picker coming soon!', 'info');
    }

    function recordVoice() {
      showNotification('Voice message feature coming soon!', 'info');
    }

    function showTypingIndicator(username) {
      // Placeholder for typing indicator
      console.log(`${username} is typing...`);
    }

    function hideTypingIndicator() {
      // Placeholder for hiding typing indicator
      console.log('Stopped typing');
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Filter conversations based on tab
      const conversationItems = document.querySelectorAll('.contact-item');
      conversationItems.forEach(item => {
        const unreadBadge = item.querySelector('.unread-badge');
        const hasUnread = unreadBadge && parseInt(unreadBadge.textContent) > 0;
        
        switch(tab) {
          case 'all':
            item.style.display = 'flex';
            break;
          case 'recent':
            // Show all conversations, sorted by most recent (already sorted from API)
            item.style.display = 'flex';
            break;
          case 'unread':
            item.style.display = hasUnread ? 'flex' : 'none';
            break;
        }
      });
    }
  </script>
</body>
</html>