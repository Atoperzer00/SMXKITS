<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Server Tile Test</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .success { background: #d4edda; border-color: #c3e6cb; }
    .error { background: #f8d7da; border-color: #f5c6cb; }
    .info { background: #d1ecf1; border-color: #bee5eb; }
    .tile-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
    .tile-item { text-align: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .tile-item img { max-width: 100%; height: auto; border: 1px solid #999; }
    .tile-item.success { background: #d4edda; }
    .tile-item.error { background: #f8d7da; }
  </style>
</head>
<body>
  <h1>üîß Server Tile Configuration Test</h1>
  
  <div class="test-section info">
    <h3>üìç Environment Information</h3>
    <p><strong>Current URL:</strong> <span id="current-url"></span></p>
    <p><strong>Base URL:</strong> <span id="base-url"></span></p>
    <p><strong>Protocol:</strong> <span id="protocol"></span></p>
  </div>

  <div class="test-section" id="server-test">
    <h3>üåê Server Response Test</h3>
    <div id="server-results"></div>
  </div>

  <div class="test-section" id="tile-test">
    <h3>üó∫Ô∏è Tile Accessibility Test</h3>
    <div id="tile-results"></div>
    <div class="tile-grid" id="tile-grid"></div>
  </div>

  <script>
    // Display environment info
    document.getElementById('current-url').textContent = window.location.href;
    document.getElementById('base-url').textContent = window.location.origin;
    document.getElementById('protocol').textContent = window.location.protocol;

    // Test server response
    async function testServerResponse() {
      const serverResults = document.getElementById('server-results');
      const serverTest = document.getElementById('server-test');
      
      try {
        const response = await fetch('/');
        serverResults.innerHTML = `
          <p>‚úÖ Server responding: HTTP ${response.status} ${response.statusText}</p>
          <p>Content-Type: ${response.headers.get('content-type') || 'Not specified'}</p>
        `;
        serverTest.className = 'test-section success';
      } catch (error) {
        serverResults.innerHTML = `<p>‚ùå Server error: ${error.message}</p>`;
        serverTest.className = 'test-section error';
      }
    }

    // Test tile accessibility
    async function testTileAccessibility() {
      const tileResults = document.getElementById('tile-results');
      const tileGrid = document.getElementById('tile-grid');
      const tileTest = document.getElementById('tile-test');
      
      // Test tiles from different zoom levels
      const testTiles = [
        { path: 'altis/0/0/0.png', desc: 'Zoom 0 - Base tile' },
        { path: 'altis/1/0/0.png', desc: 'Zoom 1 - Low detail' },
        { path: 'altis/1/0/1.png', desc: 'Zoom 1 - Adjacent tile' },
        { path: 'altis/2/0/0.png', desc: 'Zoom 2 - Medium detail' },
        { path: 'altis/6/16/9.png', desc: 'Zoom 6 - High detail (known)' },
        { path: 'altis/6/32/18.png', desc: 'Zoom 6 - High detail (test)' }
      ];

      let successCount = 0;
      let totalTests = testTiles.length;
      let results = [];

      for (const tile of testTiles) {
        try {
          const response = await fetch(tile.path);
          const tileItem = document.createElement('div');
          tileItem.className = 'tile-item';
          
          if (response.ok) {
            successCount++;
            const blob = await response.blob();
            const img = document.createElement('img');
            img.src = URL.createObjectURL(blob);
            img.alt = tile.desc;
            
            tileItem.className += ' success';
            tileItem.innerHTML = `
              <h4>‚úÖ ${tile.desc}</h4>
              <p>${tile.path}</p>
              <p>Size: ${blob.size} bytes</p>
            `;
            tileItem.appendChild(img);
            
            results.push(`‚úÖ ${tile.path} - ${blob.size} bytes`);
          } else {
            tileItem.className += ' error';
            tileItem.innerHTML = `
              <h4>‚ùå ${tile.desc}</h4>
              <p>${tile.path}</p>
              <p>HTTP ${response.status}: ${response.statusText}</p>
            `;
            results.push(`‚ùå ${tile.path} - HTTP ${response.status}`);
          }
          
          tileGrid.appendChild(tileItem);
          
        } catch (error) {
          const tileItem = document.createElement('div');
          tileItem.className = 'tile-item error';
          tileItem.innerHTML = `
            <h4>‚ùå ${tile.desc}</h4>
            <p>${tile.path}</p>
            <p>Error: ${error.message}</p>
          `;
          tileGrid.appendChild(tileItem);
          results.push(`‚ùå ${tile.path} - ${error.message}`);
        }
      }

      // Update results summary
      tileResults.innerHTML = `
        <p><strong>Test Results:</strong> ${successCount}/${totalTests} tiles accessible</p>
        <ul>${results.map(r => `<li>${r}</li>`).join('')}</ul>
      `;

      if (successCount === totalTests) {
        tileTest.className = 'test-section success';
      } else if (successCount > 0) {
        tileTest.className = 'test-section info';
      } else {
        tileTest.className = 'test-section error';
      }
    }

    // Test CORS headers
    async function testCORS() {
      try {
        const response = await fetch('altis/6/16/9.png');
        console.log('CORS Headers:');
        console.log('Access-Control-Allow-Origin:', response.headers.get('Access-Control-Allow-Origin'));
        console.log('Access-Control-Allow-Methods:', response.headers.get('Access-Control-Allow-Methods'));
      } catch (error) {
        console.error('CORS test failed:', error);
      }
    }

    // Run all tests
    async function runAllTests() {
      console.log('üöÄ Starting server and tile tests...');
      
      await testServerResponse();
      await testTileAccessibility();
      await testCORS();
      
      console.log('‚úÖ All tests completed');
    }

    // Start tests when page loads
    window.addEventListener('load', runAllTests);
  </script>
</body>
</html>