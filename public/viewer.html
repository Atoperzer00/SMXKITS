<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMX Stream Viewer - Tactical Intelligence Training</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --tactical-black: #0a0a0a;
      --tactical-dark: #1a1a1a;
      --tactical-gray: #2a2a2a;
      --tactical-light-gray: #3a3a3a;
      --tactical-green: #00ff41;
      --tactical-amber: #ffb000;
      --tactical-red: #ff0040;
      --tactical-blue: #00a8ff;
      --tactical-text: #e0e0e0;
      --tactical-text-dim: #a0a0a0;
      --tactical-border: #333333;
      --tactical-overlay: rgba(0, 0, 0, 0.8);
      --tactical-glow: 0 0 10px rgba(0, 255, 65, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      background: var(--tactical-black);
      color: var(--tactical-text);
      overflow: hidden;
      user-select: none;
    }

    .viewer-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: var(--tactical-black);
      display: flex;
      flex-direction: column;
    }

    /* Video Player */
    .video-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--tactical-dark);
      overflow: hidden;
    }

    #videoPlayer {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: var(--tactical-black);
    }

    /* Waiting Screen */
    .waiting-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--tactical-black);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .waiting-content {
      text-align: center;
      max-width: 600px;
      padding: 2rem;
    }

    .waiting-title {
      font-size: 2.5rem;
      color: var(--tactical-green);
      margin-bottom: 1rem;
      text-shadow: var(--tactical-glow);
      letter-spacing: 2px;
    }

    .waiting-subtitle {
      font-size: 1.2rem;
      color: var(--tactical-text-dim);
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .waiting-spinner {
      width: 60px;
      height: 60px;
      border: 3px solid var(--tactical-gray);
      border-top: 3px solid var(--tactical-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .connection-status {
      font-size: 0.9rem;
      color: var(--tactical-amber);
      margin-top: 1rem;
    }

    /* Video Controls */
    .video-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, var(--tactical-overlay));
      padding: 2rem 2rem 1rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 20;
    }

    .video-wrapper:hover .video-controls,
    .video-controls.show {
      opacity: 1;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .control-btn {
      background: var(--tactical-gray);
      border: 1px solid var(--tactical-border);
      color: var(--tactical-text);
      width: 40px;
      height: 40px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
    }

    .control-btn:hover {
      background: var(--tactical-light-gray);
      border-color: var(--tactical-green);
      box-shadow: var(--tactical-glow);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .time-display {
      font-size: 0.9rem;
      color: var(--tactical-text);
      min-width: 120px;
      text-align: center;
      font-family: 'Consolas', monospace;
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .volume-slider {
      width: 80px;
      height: 4px;
      background: var(--tactical-gray);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--tactical-green);
      border-radius: 50%;
      cursor: pointer;
    }

    /* Timeline */
    .timeline-container {
      position: relative;
      flex: 1;
      height: 60px;
      background: var(--tactical-gray);
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
    }

    .timeline-track {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--tactical-gray);
    }

    .timeline-buffered {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--tactical-light-gray);
      transition: width 0.1s ease;
    }

    .timeline-progress {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--tactical-green), var(--tactical-blue));
      transition: width 0.1s ease;
    }

    .timeline-thumbnails {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      pointer-events: none;
    }

    .timeline-thumbnail {
      flex: 1;
      height: 100%;
      background-size: cover;
      background-position: center;
      border-right: 1px solid var(--tactical-border);
      opacity: 0.7;
    }

    .timeline-thumbnail:last-child {
      border-right: none;
    }

    .timeline-scrubber {
      position: absolute;
      top: -5px;
      width: 4px;
      height: 70px;
      background: var(--tactical-green);
      border-radius: 2px;
      box-shadow: var(--tactical-glow);
      transform: translateX(-2px);
      transition: left 0.1s ease;
    }

    /* Hover Preview */
    .timeline-preview {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--tactical-overlay);
      border: 1px solid var(--tactical-border);
      border-radius: 4px;
      padding: 0.5rem;
      display: none;
      z-index: 30;
    }

    .preview-thumbnail {
      width: 160px;
      height: 90px;
      background: var(--tactical-gray);
      border-radius: 2px;
      margin-bottom: 0.5rem;
    }

    .preview-time {
      font-size: 0.8rem;
      color: var(--tactical-text);
      text-align: center;
    }

    /* Status Indicators */
    .status-bar {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 25;
    }

    .status-indicator {
      background: var(--tactical-overlay);
      border: 1px solid var(--tactical-border);
      border-radius: 4px;
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--tactical-red);
    }

    .status-dot.live {
      background: var(--tactical-green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-dot.buffering {
      background: var(--tactical-amber);
    }

    /* Fullscreen Styles */
    .viewer-container:-webkit-full-screen {
      background: var(--tactical-black);
    }

    .viewer-container:-moz-full-screen {
      background: var(--tactical-black);
    }

    .viewer-container:fullscreen {
      background: var(--tactical-black);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .waiting-title {
        font-size: 2rem;
      }
      
      .controls-row {
        gap: 0.5rem;
      }
      
      .control-btn {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
      
      .timeline-container {
        height: 50px;
      }
      
      .volume-control {
        display: none;
      }
    }

    /* Loading Animation */
    .loading-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 15;
      display: none;
    }

    .loading-overlay.show {
      display: block;
    }

    /* Error State */
    .error-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--tactical-black);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .error-screen.show {
      display: flex;
    }

    .error-title {
      font-size: 2rem;
      color: var(--tactical-red);
      margin-bottom: 1rem;
    }

    .error-message {
      color: var(--tactical-text-dim);
      text-align: center;
      max-width: 500px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="viewer-container" id="viewerContainer">
    <!-- Video Player -->
    <div class="video-wrapper" id="videoWrapper">
      <video id="videoPlayer" playsinline></video>
      
      <!-- Video Controls -->
      <div class="video-controls" id="videoControls">
        <div class="controls-row">
          <button class="control-btn" id="playPauseBtn" title="Play/Pause">
            <span id="playIcon">‚ñ∂</span>
          </button>
          
          <div class="volume-control">
            <button class="control-btn" id="muteBtn" title="Mute">
              <span id="volumeIcon">üîä</span>
            </button>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
          </div>
          
          <div class="time-display" id="timeDisplay">
            00:00 / 00:00
          </div>
          
          <div class="timeline-container" id="timelineContainer">
            <div class="timeline-track"></div>
            <div class="timeline-buffered" id="timelineBuffered"></div>
            <div class="timeline-progress" id="timelineProgress"></div>
            <div class="timeline-thumbnails" id="timelineThumbnails"></div>
            <div class="timeline-scrubber" id="timelineScrubber"></div>
          </div>
          
          <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
            <span>‚õ∂</span>
          </button>
        </div>
      </div>
      
      <!-- Timeline Preview -->
      <div class="timeline-preview" id="timelinePreview">
        <div class="preview-thumbnail" id="previewThumbnail"></div>
        <div class="preview-time" id="previewTime">00:00</div>
      </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot" id="connectionDot"></div>
        <span id="connectionStatus">CONNECTING</span>
      </div>
      <div class="status-indicator" id="viewerCount" style="display: none;">
        <span>üë• <span id="viewerCountText">0</span> VIEWERS</span>
      </div>
    </div>
    
    <!-- Waiting Screen -->
    <div class="waiting-screen" id="waitingScreen">
      <div class="waiting-content">
        <div class="waiting-title">SMX TACTICAL VIEWER</div>
        <div class="waiting-subtitle">
          Establishing secure connection to intelligence feed...<br>
          Standby for live tactical video stream.
        </div>
        <div class="waiting-spinner"></div>
        <div class="connection-status" id="waitingStatus">
          Initializing connection protocols...
        </div>
      </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="waiting-spinner"></div>
    </div>
    
    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen">
      <div class="error-title">CONNECTION FAILED</div>
      <div class="error-message" id="errorMessage">
        Unable to establish connection to tactical feed.<br>
        Please verify your access credentials and try again.
      </div>
    </div>
  </div>

  <script>
    // --- Global Variables ---
    let hls = null;
    let socket = null;
    let classId = null;
    let streamKey = null;
    let isConnected = false;
    let isPlaying = false;
    let currentTime = 0;
    let duration = 0;
    let thumbnails = [];
    let thumbnailInterval = 5; // seconds
    let lastThumbnailTime = 0;
    let viewerId = null;
    let streamCheckInterval = null;
    let controlsTimeout = null;

    // DOM Elements
    const videoPlayer = document.getElementById('videoPlayer');
    const waitingScreen = document.getElementById('waitingScreen');
    const errorScreen = document.getElementById('errorScreen');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const videoControls = document.getElementById('videoControls');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playIcon = document.getElementById('playIcon');
    const muteBtn = document.getElementById('muteBtn');
    const volumeIcon = document.getElementById('volumeIcon');
    const volumeSlider = document.getElementById('volumeSlider');
    const timeDisplay = document.getElementById('timeDisplay');
    const timelineContainer = document.getElementById('timelineContainer');
    const timelineBuffered = document.getElementById('timelineBuffered');
    const timelineProgress = document.getElementById('timelineProgress');
    const timelineThumbnails = document.getElementById('timelineThumbnails');
    const timelineScrubber = document.getElementById('timelineScrubber');
    const timelinePreview = document.getElementById('timelinePreview');
    const previewThumbnail = document.getElementById('previewThumbnail');
    const previewTime = document.getElementById('previewTime');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const connectionDot = document.getElementById('connectionDot');
    const connectionStatus = document.getElementById('connectionStatus');
    const viewerCount = document.getElementById('viewerCount');
    const viewerCountText = document.getElementById('viewerCountText');
    const waitingStatus = document.getElementById('waitingStatus');
    const errorMessage = document.getElementById('errorMessage');

    // --- Initialization ---
    function init() {
      // Generate unique viewer ID
      viewerId = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      // Get class ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      classId = urlParams.get('classId');
      
      if (!classId) {
        showError('No class ID provided in URL');
        return;
      }
      
      // Initialize socket connection
      initializeSocket();
      
      // Setup event listeners
      setupEventListeners();
      
      // Start checking for stream
      checkForStream();
      
      console.log(`üé• SMX Viewer initialized for class: ${classId}`);
    }

    // --- Socket.IO Connection ---
    function initializeSocket() {
      try {
        socket = io();
        
        socket.on('connect', () => {
          console.log('üì° Socket connected');
          updateConnectionStatus('CONNECTED', true);
          
          // Join class room for stream updates
          socket.emit('join-stream', { classId, viewerId });
        });
        
        socket.on('disconnect', () => {
          console.log('üì° Socket disconnected');
          updateConnectionStatus('DISCONNECTED', false);
        });
        
        socket.on('stream-live', (data) => {
          if (data.classId === classId) {
            console.log('üî¥ Stream is now live');
            waitingStatus.textContent = 'Stream detected - Connecting...';
            startVideoPlayer();
          }
        });
        
        socket.on('stream-offline', (data) => {
          if (data.classId === classId) {
            console.log('‚èπÔ∏è Stream went offline');
            stopVideoPlayer();
            showWaitingScreen();
          }
        });
        
        socket.on('viewer-count', (data) => {
          if (data.classId === classId) {
            updateViewerCount(data.count);
          }
        });
        
        socket.on('connect_error', (error) => {
          console.error('Socket connection error:', error);
          updateConnectionStatus('ERROR', false);
        });
        
      } catch (error) {
        console.error('Failed to initialize socket:', error);
        updateConnectionStatus('ERROR', false);
      }
    }

    // --- Stream Detection ---
    async function checkForStream() {
      const streamUrl = `http://198.211.107.134/hls/${classId}.m3u8`;
      
      try {
        waitingStatus.textContent = 'Scanning for tactical feed...';
        
        const response = await fetch(streamUrl, { 
          method: 'HEAD',
          cache: 'no-cache'
        });
        
        if (response.ok) {
          console.log('‚úÖ Stream found, starting player');
          streamKey = classId;
          startVideoPlayer();
        } else {
          // Stream not available yet, keep checking
          waitingStatus.textContent = 'Awaiting instructor to begin transmission...';
          streamCheckInterval = setTimeout(checkForStream, 3000);
        }
        
      } catch (error) {
        console.log('Stream not available yet, retrying...');
        waitingStatus.textContent = 'Establishing secure channel...';
        streamCheckInterval = setTimeout(checkForStream, 3000);
      }
    }

    // --- Video Player Management ---
    function startVideoPlayer() {
      if (streamCheckInterval) {
        clearTimeout(streamCheckInterval);
        streamCheckInterval = null;
      }
      
      const streamUrl = `http://198.211.107.134/hls/${classId}.m3u8`;
      
      if (Hls.isSupported()) {
        hls = new Hls({
          enableWorker: true,
          lowLatencyMode: true,
          backBufferLength: 90
        });
        
        hls.loadSource(streamUrl);
        hls.attachMedia(videoPlayer);
        
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          console.log('üì∫ HLS manifest parsed');
          hideWaitingScreen();
          videoPlayer.play().catch(e => {
            console.log('Autoplay prevented, user interaction required');
          });
        });
        
        hls.on(Hls.Events.FRAG_LOADED, () => {
          updateBufferedProgress();
          generateThumbnailIfNeeded();
        });
        
        hls.on(Hls.Events.ERROR, (event, data) => {
          console.error('HLS Error:', data);
          if (data.fatal) {
            handleStreamError(data);
          }
        });
        
      } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari native HLS support
        videoPlayer.src = streamUrl;
        videoPlayer.addEventListener('loadedmetadata', () => {
          hideWaitingScreen();
          videoPlayer.play().catch(e => {
            console.log('Autoplay prevented, user interaction required');
          });
        });
      } else {
        showError('HLS not supported in this browser');
      }
    }

    function stopVideoPlayer() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      videoPlayer.src = '';
      videoPlayer.load();
      
      // Clear thumbnails
      thumbnails = [];
      updateThumbnailTimeline();
      
      isPlaying = false;
      updatePlayButton();
    }

    function handleStreamError(data) {
      console.error('Fatal HLS error:', data);
      
      if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
        // Network error - stream might have ended
        console.log('Network error detected, checking if stream ended...');
        showWaitingScreen();
        checkForStream();
      } else {
        showError(`Stream error: ${data.details}`);
      }
    }

    // --- UI State Management ---
    function showWaitingScreen() {
      waitingScreen.style.display = 'flex';
      errorScreen.classList.remove('show');
      loadingOverlay.classList.remove('show');
      updateConnectionStatus('WAITING', false);
    }

    function hideWaitingScreen() {
      waitingScreen.style.display = 'none';
      updateConnectionStatus('LIVE', true);
      
      // Notify server that viewer is now watching
      if (socket) {
        socket.emit('viewer-joined', { classId, viewerId });
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorScreen.classList.add('show');
      waitingScreen.style.display = 'none';
      loadingOverlay.classList.remove('show');
      updateConnectionStatus('ERROR', false);
    }

    function updateConnectionStatus(status, isLive) {
      connectionStatus.textContent = status;
      
      if (isLive) {
        connectionDot.classList.add('live');
        connectionDot.classList.remove('buffering');
      } else if (status === 'BUFFERING') {
        connectionDot.classList.add('buffering');
        connectionDot.classList.remove('live');
      } else {
        connectionDot.classList.remove('live', 'buffering');
      }
    }

    function updateViewerCount(count) {
      viewerCountText.textContent = count;
      viewerCount.style.display = count > 0 ? 'block' : 'none';
    }

    // --- Video Controls ---
    function setupEventListeners() {
      // Video events
      videoPlayer.addEventListener('play', () => {
        isPlaying = true;
        updatePlayButton();
      });
      
      videoPlayer.addEventListener('pause', () => {
        isPlaying = false;
        updatePlayButton();
      });
      
      videoPlayer.addEventListener('timeupdate', () => {
        currentTime = videoPlayer.currentTime;
        duration = videoPlayer.duration || 0;
        updateTimeDisplay();
        updateProgressBar();
        generateThumbnailIfNeeded();
      });
      
      videoPlayer.addEventListener('waiting', () => {
        loadingOverlay.classList.add('show');
        updateConnectionStatus('BUFFERING', false);
      });
      
      videoPlayer.addEventListener('playing', () => {
        loadingOverlay.classList.remove('show');
        updateConnectionStatus('LIVE', true);
      });
      
      // Control buttons
      playPauseBtn.addEventListener('click', togglePlayPause);
      muteBtn.addEventListener('click', toggleMute);
      volumeSlider.addEventListener('input', updateVolume);
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      
      // Timeline interaction
      timelineContainer.addEventListener('click', seekToPosition);
      timelineContainer.addEventListener('mousemove', showTimelinePreview);
      timelineContainer.addEventListener('mouseleave', hideTimelinePreview);
      
      // Controls visibility
      document.addEventListener('mousemove', showControls);
      document.addEventListener('keydown', handleKeyboard);
      
      // Touch events for mobile
      document.addEventListener('touchstart', showControls);
    }

    function togglePlayPause() {
      if (videoPlayer.paused) {
        videoPlayer.play();
      } else {
        videoPlayer.pause();
      }
    }

    function updatePlayButton() {
      playIcon.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
    }

    function toggleMute() {
      videoPlayer.muted = !videoPlayer.muted;
      updateVolumeIcon();
    }

    function updateVolume() {
      videoPlayer.volume = volumeSlider.value;
      updateVolumeIcon();
    }

    function updateVolumeIcon() {
      if (videoPlayer.muted || videoPlayer.volume === 0) {
        volumeIcon.textContent = 'üîá';
      } else if (videoPlayer.volume < 0.5) {
        volumeIcon.textContent = 'üîâ';
      } else {
        volumeIcon.textContent = 'üîä';
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    function showControls() {
      videoControls.classList.add('show');
      
      if (controlsTimeout) {
        clearTimeout(controlsTimeout);
      }
      
      controlsTimeout = setTimeout(() => {
        videoControls.classList.remove('show');
      }, 3000);
    }

    function handleKeyboard(e) {
      switch (e.code) {
        case 'Space':
          e.preventDefault();
          togglePlayPause();
          break;
        case 'KeyM':
          toggleMute();
          break;
        case 'KeyF':
          toggleFullscreen();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          seekRelative(-10);
          break;
        case 'ArrowRight':
          e.preventDefault();
          seekRelative(10);
          break;
      }
    }

    // --- Timeline Management ---
    function updateTimeDisplay() {
      const current = formatTime(currentTime);
      const total = formatTime(duration);
      timeDisplay.textContent = `${current} / ${total}`;
    }

    function updateProgressBar() {
      if (duration > 0) {
        const progress = (currentTime / duration) * 100;
        timelineProgress.style.width = `${progress}%`;
        timelineScrubber.style.left = `${progress}%`;
      }
    }

    function updateBufferedProgress() {
      if (videoPlayer.buffered.length > 0 && duration > 0) {
        const buffered = videoPlayer.buffered.end(videoPlayer.buffered.length - 1);
        const progress = (buffered / duration) * 100;
        timelineBuffered.style.width = `${progress}%`;
      }
    }

    function seekToPosition(e) {
      const rect = timelineContainer.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const percentage = clickX / rect.width;
      const seekTime = percentage * duration;
      
      if (seekTime >= 0 && seekTime <= duration) {
        videoPlayer.currentTime = seekTime;
      }
    }

    function seekRelative(seconds) {
      const newTime = currentTime + seconds;
      if (newTime >= 0 && newTime <= duration) {
        videoPlayer.currentTime = newTime;
      }
    }

    function showTimelinePreview(e) {
      if (duration === 0) return;
      
      const rect = timelineContainer.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const percentage = mouseX / rect.width;
      const previewTimeValue = percentage * duration;
      
      // Position preview
      timelinePreview.style.left = `${e.clientX}px`;
      timelinePreview.style.display = 'block';
      
      // Update preview time
      previewTime.textContent = formatTime(previewTimeValue);
      
      // Find closest thumbnail
      const thumbnail = findClosestThumbnail(previewTimeValue);
      if (thumbnail) {
        previewThumbnail.style.backgroundImage = `url(${thumbnail.dataUrl})`;
      }
    }

    function hideTimelinePreview() {
      timelinePreview.style.display = 'none';
    }

    // --- Thumbnail Generation ---
    function generateThumbnailIfNeeded() {
      if (currentTime - lastThumbnailTime >= thumbnailInterval) {
        generateThumbnail();
        lastThumbnailTime = currentTime;
      }
    }

    function generateThumbnail() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = 160;
      canvas.height = 90;
      
      try {
        ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
        
        thumbnails.push({
          time: currentTime,
          dataUrl: dataUrl
        });
        
        // Limit thumbnail count to prevent memory issues
        if (thumbnails.length > 100) {
          thumbnails.shift();
        }
        
        updateThumbnailTimeline();
        
      } catch (error) {
        console.warn('Could not generate thumbnail:', error);
      }
    }

    function updateThumbnailTimeline() {
      timelineThumbnails.innerHTML = '';
      
      if (thumbnails.length === 0 || duration === 0) return;
      
      thumbnails.forEach(thumbnail => {
        const thumbnailElement = document.createElement('div');
        thumbnailElement.className = 'timeline-thumbnail';
        thumbnailElement.style.backgroundImage = `url(${thumbnail.dataUrl})`;
        thumbnailElement.style.left = `${(thumbnail.time / duration) * 100}%`;
        thumbnailElement.style.width = `${thumbnailInterval / duration * 100}%`;
        timelineThumbnails.appendChild(thumbnailElement);
      });
    }

    function findClosestThumbnail(time) {
      if (thumbnails.length === 0) return null;
      
      let closest = thumbnails[0];
      let minDiff = Math.abs(time - closest.time);
      
      for (let i = 1; i < thumbnails.length; i++) {
        const diff = Math.abs(time - thumbnails[i].time);
        if (diff < minDiff) {
          minDiff = diff;
          closest = thumbnails[i];
        }
      }
      
      return closest;
    }

    // --- Utility Functions ---
    function formatTime(seconds) {
      if (isNaN(seconds)) return '00:00';
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      } else {
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
    }

    // --- Cleanup ---
    window.addEventListener('beforeunload', () => {
      if (socket) {
        socket.emit('viewer-left', { classId, viewerId });
      }
      
      if (hls) {
        hls.destroy();
      }
      
      if (streamCheckInterval) {
        clearTimeout(streamCheckInterval);
      }
    });

    // --- Initialize Application ---
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMX Stream Viewer - Tactical Intelligence Training</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --tactical-black: #0a0a0a;
      --tactical-dark: #1a1a1a;
      --tactical-gray: #2a2a2a;
      --tactical-light-gray: #3a3a3a;
      --tactical-green: #00ff41;
      --tactical-amber: #ffb000;
      --tactical-red: #ff0040;
      --tactical-blue: #00a8ff;
      --tactical-text: #e0e0e0;
      --tactical-text-dim: #a0a0a0;
      --tactical-border: #333333;
      --tactical-overlay: rgba(0, 0, 0, 0.8);
      --tactical-glow: 0 0 10px rgba(0, 255, 65, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      background: var(--tactical-black);
      color: var(--tactical-text);
      overflow: hidden;
      user-select: none;
    }

    .viewer-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: var(--tactical-black);
      display: flex;
      flex-direction: column;
    }

    /* Video Player */
    .video-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--tactical-dark);
      overflow: hidden;
    }

    #videoPlayer {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: var(--tactical-black);
    }

    /* Waiting Screen */
    .waiting-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--tactical-black);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .waiting-content {
      text-align: center;
      max-width: 600px;
      padding: 2rem;
    }

    .waiting-title {
      font-size: 2.5rem;
      color: var(--tactical-green);
      margin-bottom: 1rem;
      text-shadow: var(--tactical-glow);
      letter-spacing: 2px;
    }

    .waiting-subtitle {
      font-size: 1.2rem;
      color: var(--tactical-text-dim);
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .waiting-spinner {
      width: 60px;
      height: 60px;
      border: 3px solid var(--tactical-gray);
      border-top: 3px solid var(--tactical-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .connection-status {
      font-size: 0.9rem;
      color: var(--tactical-amber);
      margin-top: 1rem;
    }

    /* Video Controls */
    .video-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, var(--tactical-overlay));
      padding: 2rem 2rem 1rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 20;
    }

    .video-wrapper:hover .video-controls,
    .video-controls.show {
      opacity: 1;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .control-btn {
      background: var(--tactical-gray);
      border: 1px solid var(--tactical-border);
      color: var(--tactical-text);
      width: 40px;
      height: 40px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
    }

    .control-btn:hover {
      background: var(--tactical-light-gray);
      border-color: var(--tactical-green);
      box-shadow: var(--tactical-glow);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .time-display {
      font-size: 0.9rem;
      color: var(--tactical-text);
      min-width: 120px;
      text-align: center;
      font-family: 'Consolas', monospace;
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .volume-slider {
      width: 80px;
      height: 4px;
      background: var(--tactical-gray);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--tactical-green);
      border-radius: 50%;
      cursor: pointer;
    }

    /* Timeline */
    .timeline-container {
      position: relative;
      flex: 1;
      height: 60px;
      background: var(--tactical-gray);
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
    }

    .timeline-track {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--tactical-gray);
    }

    .timeline-buffered {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--tactical-light-gray);
      transition: width 0.1s ease;
    }

    .timeline-progress {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--tactical-green), var(--tactical-blue));
      transition: width 0.1s ease;
    }

    .timeline-thumbnails {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      pointer-events: none;
    }

    .timeline-thumbnail {
      flex: 1;
      height: 100%;
      background-size: cover;
      background-position: center;
      border-right: 1px solid var(--tactical-border);
      opacity: 0.7;
    }

    .timeline-thumbnail:last-child {
      border-right: none;
    }

    .timeline-scrubber {
      position: absolute;
      top: -5px;
      width: 4px;
      height: 70px;
      background: var(--tactical-green);
      border-radius: 2px;
      box-shadow: var(--tactical-glow);
      transform: translateX(-2px);
      transition: left 0.1s ease;
    }

    /* Hover Preview */
    .timeline-preview {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--tactical-overlay);
      border: 1px solid var(--tactical-border);
      border-radius: 4px;
      padding: 0.5rem;
      display: none;
      z-index: 30;
    }

    .preview-thumbnail {
      width: 160px;
      height: 90px;
      background: var(--tactical-gray);
      border-radius: 2px;
      margin-bottom: 0.5rem;
    }

    .preview-time {
      font-size: 0.8rem;
      color: var(--tactical-text);
      text-align: center;
    }

    /* Status Indicators */
    .status-bar {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 25;
    }

    .status-indicator {
      background: var(--tactical-overlay);
      border: 1px solid var(--tactical-border);
      border-radius: 4px;
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--tactical-red);
    }

    .status-dot.live {
      background: var(--tactical-green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-dot.buffering {
      background: var(--tactical-amber);
    }

    /* Fullscreen Styles */
    .viewer-container:-webkit-full-screen {
      background: var(--tactical-black);
    }

    .viewer-container:-moz-full-screen {
      background: var(--tactical-black);
    }

    .viewer-container:fullscreen {
      background: var(--tactical-black);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .waiting-title {
        font-size: 2rem;
      }
      
      .controls-row {
        gap: 0.5rem;
      }
      
      .control-btn {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
      
      .timeline-container {
        height: 50px;
      }
      
      .volume-control {
        display: none;
      }
    }

    /* Loading Animation */
    .loading-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 15;
      display: none;
    }

    .loading-overlay.show {
      display: block;
    }

    /* Error State */
    .error-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--tactical-black);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .error-screen.show {
      display: flex;
    }

    .error-title {
      font-size: 2rem;
      color: var(--tactical-red);
      margin-bottom: 1rem;
    }

    .error-message {
      color: var(--tactical-text-dim);
      text-align: center;
      max-width: 500px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="viewer-container" id="viewerContainer">
    <!-- Video Player -->
    <div class="video-wrapper" id="videoWrapper">
      <video id="videoPlayer" playsinline></video>
      
      <!-- Video Controls -->
      <div class="video-controls" id="videoControls">
        <div class="controls-row">
          <button class="control-btn" id="playPauseBtn" title="Play/Pause">
            <span id="playIcon">‚ñ∂</span>
          </button>
          
          <div class="volume-control">
            <button class="control-btn" id="muteBtn" title="Mute">
              <span id="volumeIcon">üîä</span>
            </button>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
          </div>
          
          <div class="time-display" id="timeDisplay">
            00:00 / 00:00
          </div>
          
          <div class="timeline-container" id="timelineContainer">
            <div class="timeline-track"></div>
            <div class="timeline-buffered" id="timelineBuffered"></div>
            <div class="timeline-progress" id="timelineProgress"></div>
            <div class="timeline-thumbnails" id="timelineThumbnails"></div>
            <div class="timeline-scrubber" id="timelineScrubber"></div>
          </div>
          
          <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
            <span>‚õ∂</span>
          </button>
        </div>
      </div>
      
      <!-- Timeline Preview -->
      <div class="timeline-preview" id="timelinePreview">
        <div class="preview-thumbnail" id="previewThumbnail"></div>
        <div class="preview-time" id="previewTime">00:00</div>
      </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot" id="connectionDot"></div>
        <span id="connectionStatus">CONNECTING</span>
      </div>
      <div class="status-indicator" id="viewerCount" style="display: none;">
        <span>üë• <span id="viewerCountText">0</span> VIEWERS</span>
      </div>
    </div>
    
    <!-- Waiting Screen -->
    <div class="waiting-screen" id="waitingScreen">
      <div class="waiting-content">
        <div class="waiting-title">SMX TACTICAL VIEWER</div>
        <div class="waiting-subtitle">
          Establishing secure connection to intelligence feed...<br>
          Standby for live tactical video stream.
        </div>
        <div class="waiting-spinner"></div>
        <div class="connection-status" id="waitingStatus">
          Initializing connection protocols...
        </div>
      </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="waiting-spinner"></div>
    </div>
    
    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen">
      <div class="error-title">CONNECTION FAILED</div>
      <div class="error-message" id="errorMessage">
        Unable to establish connection to tactical feed.<br>
        Please verify your access credentials and try again.
      </div>
    </div>
  </div>

  <script>
    // --- Global Variables ---
    let hls = null;
    let socket = null;
    let classId = null;
    let streamKey = null;
    let isConnected = false;
    let isPlaying = false;
    let currentTime = 0;
    let duration = 0;
    let thumbnails = [];
    let thumbnailInterval = 5; // seconds
    let lastThumbnailTime = 0;
    let viewerId = null;
    let streamCheckInterval = null;
    let controlsTimeout = null;

    // DOM Elements
    const videoPlayer = document.getElementById('videoPlayer');
    const waitingScreen = document.getElementById('waitingScreen');
    const errorScreen = document.getElementById('errorScreen');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const videoControls = document.getElementById('videoControls');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playIcon = document.getElementById('playIcon');
    const muteBtn = document.getElementById('muteBtn');
    const volumeIcon = document.getElementById('volumeIcon');
    const volumeSlider = document.getElementById('volumeSlider');
    const timeDisplay = document.getElementById('timeDisplay');
    const timelineContainer = document.getElementById('timelineContainer');
    const timelineBuffered = document.getElementById('timelineBuffered');
    const timelineProgress = document.getElementById('timelineProgress');
    const timelineThumbnails = document.getElementById('timelineThumbnails');
    const timelineScrubber = document.getElementById('timelineScrubber');
    const timelinePreview = document.getElementById('timelinePreview');
    const previewThumbnail = document.getElementById('previewThumbnail');
    const previewTime = document.getElementById('previewTime');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const connectionDot = document.getElementById('connectionDot');
    const connectionStatus = document.getElementById('connectionStatus');
    const viewerCount = document.getElementById('viewerCount');
    const viewerCountText = document.getElementById('viewerCountText');
    const waitingStatus = document.getElementById('waitingStatus');
    const errorMessage = document.getElementById('errorMessage');

    // --- Initialization ---
    function init() {
      // Generate unique viewer ID
      viewerId = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      // Get class ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      classId = urlParams.get('classId');
      
      if (!classId) {
        showError('No class ID provided in URL');
        return;
      }
      
      // Initialize socket connection
      initializeSocket();
      
      // Setup event listeners
      setupEventListeners();
      
      // Start checking for stream
      checkForStream();
      
      console.log(`üé• SMX Viewer initialized for class: ${classId}`);
    }

    // --- Socket.IO Connection ---
    function initializeSocket() {
      try {
        socket = io();
        
        socket.on('connect', () => {
          console.log('üì° Socket connected');
          updateConnectionStatus('CONNECTED', true);
          
          // Join class room for stream updates
          socket.emit('join-stream', { classId, viewerId });
        });
        
        socket.on('disconnect', () => {
          console.log('üì° Socket disconnected');
          updateConnectionStatus('DISCONNECTED', false);
        });
        
        socket.on('stream-live', (data) => {
          if (data.classId === classId) {
            console.log('üî¥ Stream is now live');
            waitingStatus.textContent = 'Stream detected - Connecting...';
            startVideoPlayer();
          }
        });
        
        socket.on('stream-offline', (data) => {
          if (data.classId === classId) {
            console.log('‚èπÔ∏è Stream went offline');
            stopVideoPlayer();
            showWaitingScreen();
          }
        });
        
        socket.on('viewer-count', (data) => {
          if (data.classId === classId) {
            updateViewerCount(data.count);
          }
        });
        
        socket.on('connect_error', (error) => {
          console.error('Socket connection error:', error);
          updateConnectionStatus('ERROR', false);
        });
        
      } catch (error) {
        console.error('Failed to initialize socket:', error);
        updateConnectionStatus('ERROR', false);
      }
    }

    // --- Stream Detection ---
    async function checkForStream() {
      const streamUrl = `http://198.211.107.134/hls/${classId}.m3u8`;
      
      try {
        waitingStatus.textContent = 'Scanning for tactical feed...';
        
        const response = await fetch(streamUrl, { 
          method: 'HEAD',
          cache: 'no-cache'
        });
        
        if (response.ok) {
          console.log('‚úÖ Stream found, starting player');
          streamKey = classId;
          startVideoPlayer();
        } else {
          // Stream not available yet, keep checking
          waitingStatus.textContent = 'Awaiting instructor to begin transmission...';
          streamCheckInterval = setTimeout(checkForStream, 3000);
        }
        
      } catch (error) {
        console.log('Stream not available yet, retrying...');
        waitingStatus.textContent = 'Establishing secure channel...';
        streamCheckInterval = setTimeout(checkForStream, 3000);
      }
    }

    // --- Video Player Management ---
    function startVideoPlayer() {
      if (streamCheckInterval) {
        clearTimeout(streamCheckInterval);
        streamCheckInterval = null;
      }
      
      const streamUrl = `http://198.211.107.134/hls/${classId}.m3u8`;
      
      if (Hls.isSupported()) {
        hls = new Hls({
          enableWorker: true,
          lowLatencyMode: true,
          backBufferLength: 90
        });
        
        hls.loadSource(streamUrl);
        hls.attachMedia(videoPlayer);
        
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          console.log('üì∫ HLS manifest parsed');
          hideWaitingScreen();
          videoPlayer.play().catch(e => {
            console.log('Autoplay prevented, user interaction required');
          });
        });
        
        hls.on(Hls.Events.FRAG_LOADED, () => {
          updateBufferedProgress();
          generateThumbnailIfNeeded();
        });
        
        hls.on(Hls.Events.ERROR, (event, data) => {
          console.error('HLS Error:', data);
          if (data.fatal) {
            handleStreamError(data);
          }
        });
        
      } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari native HLS support
        videoPlayer.src = streamUrl;
        videoPlayer.addEventListener('loadedmetadata', () => {
          hideWaitingScreen();
          videoPlayer.play().catch(e => {
            console.log('Autoplay prevented, user interaction required');
          });
        });
      } else {
        showError('HLS not supported in this browser');
      }
    }

    function stopVideoPlayer() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      videoPlayer.src = '';
      videoPlayer.load();
      
      // Clear thumbnails
      thumbnails = [];
      updateThumbnailTimeline();
      
      isPlaying = false;
      updatePlayButton();
    }

    function handleStreamError(data) {
      console.error('Fatal HLS error:', data);
      
      if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
        // Network error - stream might have ended
        console.log('Network error detected, checking if stream ended...');
        showWaitingScreen();
        checkForStream();
      } else {
        showError(`Stream error: ${data.details}`);
      }
    }

    // --- UI State Management ---
    function showWaitingScreen() {
      waitingScreen.style.display = 'flex';
      errorScreen.classList.remove('show');
      loadingOverlay.classList.remove('show');
      updateConnectionStatus('WAITING', false);
    }

    function hideWaitingScreen() {
      waitingScreen.style.display = 'none';
      updateConnectionStatus('LIVE', true);
      
      // Notify server that viewer is now watching
      if (socket) {
        socket.emit('viewer-joined', { classId, viewerId });
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorScreen.classList.add('show');
      waitingScreen.style.display = 'none';
      loadingOverlay.classList.remove('show');
      updateConnectionStatus('ERROR', false);
    }

    function updateConnectionStatus(status, isLive) {
      connectionStatus.textContent = status;
      
      if (isLive) {
        connectionDot.classList.add('live');
        connectionDot.classList.remove('buffering');
      } else if (status === 'BUFFERING') {
        connectionDot.classList.add('buffering');
        connectionDot.classList.remove('live');
      } else {
        connectionDot.classList.remove('live', 'buffering');
      }
    }

    function updateViewerCount(count) {
      viewerCountText.textContent = count;
      viewerCount.style.display = count > 0 ? 'block' : 'none';
    }

    // --- Video Controls ---
    function setupEventListeners() {
      // Video events
      videoPlayer.addEventListener('play', () => {
        isPlaying = true;
        updatePlayButton();
      });
      
      videoPlayer.addEventListener('pause', () => {
        isPlaying = false;
        updatePlayButton();
      });
      
      videoPlayer.addEventListener('timeupdate', () => {
        currentTime = videoPlayer.currentTime;
        duration = videoPlayer.duration || 0;
        updateTimeDisplay();
        updateProgressBar();
        generateThumbnailIfNeeded();
      });
      
      videoPlayer.addEventListener('waiting', () => {
        loadingOverlay.classList.add('show');
        updateConnectionStatus('BUFFERING', false);
      });
      
      videoPlayer.addEventListener('playing', () => {
        loadingOverlay.classList.remove('show');
        updateConnectionStatus('LIVE', true);
      });
      
      // Control buttons
      playPauseBtn.addEventListener('click', togglePlayPause);
      muteBtn.addEventListener('click', toggleMute);
      volumeSlider.addEventListener('input', updateVolume);
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      
      // Timeline interaction
      timelineContainer.addEventListener('click', seekToPosition);
      timelineContainer.addEventListener('mousemove', showTimelinePreview);
      timelineContainer.addEventListener('mouseleave', hideTimelinePreview);
      
      // Controls visibility
      document.addEventListener('mousemove', showControls);
      document.addEventListener('keydown', handleKeyboard);
      
      // Touch events for mobile
      document.addEventListener('touchstart', showControls);
    }

    function togglePlayPause() {
      if (videoPlayer.paused) {
        videoPlayer.play();
      } else {
        videoPlayer.pause();
      }
    }

    function updatePlayButton() {
      playIcon.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
    }

    function toggleMute() {
      videoPlayer.muted = !videoPlayer.muted;
      updateVolumeIcon();
    }

    function updateVolume() {
      videoPlayer.volume = volumeSlider.value;
      updateVolumeIcon();
    }

    function updateVolumeIcon() {
      if (videoPlayer.muted || videoPlayer.volume === 0) {
        volumeIcon.textContent = 'üîá';
      } else if (videoPlayer.volume < 0.5) {
        volumeIcon.textContent = 'üîâ';
      } else {
        volumeIcon.textContent = 'üîä';
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    function showControls() {
      videoControls.classList.add('show');
      
      if (controlsTimeout) {
        clearTimeout(controlsTimeout);
      }
      
      controlsTimeout = setTimeout(() => {
        videoControls.classList.remove('show');
      }, 3000);
    }

    function handleKeyboard(e) {
      switch (e.code) {
        case 'Space':
          e.preventDefault();
          togglePlayPause();
          break;
        case 'KeyM':
          toggleMute();
          break;
        case 'KeyF':
          toggleFullscreen();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          seekRelative(-10);
          break;
        case 'ArrowRight':
          e.preventDefault();
          seekRelative(10);
          break;
      }
    }

    // --- Timeline Management ---
    function updateTimeDisplay() {
      const current = formatTime(currentTime);
      const total = formatTime(duration);
      timeDisplay.textContent = `${current} / ${total}`;
    }

    function updateProgressBar() {
      if (duration > 0) {
        const progress = (currentTime / duration) * 100;
        timelineProgress.style.width = `${progress}%`;
        timelineScrubber.style.left = `${progress}%`;
      }
    }

    function updateBufferedProgress() {
      if (videoPlayer.buffered.length > 0 && duration > 0) {
        const buffered = videoPlayer.buffered.end(videoPlayer.buffered.length - 1);
        const progress = (buffered / duration) * 100;
        timelineBuffered.style.width = `${progress}%`;
      }
    }

    function seekToPosition(e) {
      const rect = timelineContainer.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const percentage = clickX / rect.width;
      const seekTime = percentage * duration;
      
      if (seekTime >= 0 && seekTime <= duration) {
        videoPlayer.currentTime = seekTime;
      }
    }

    function seekRelative(seconds) {
      const newTime = currentTime + seconds;
      if (newTime >= 0 && newTime <= duration) {
        videoPlayer.currentTime = newTime;
      }
    }

    function showTimelinePreview(e) {
      if (duration === 0) return;
      
      const rect = timelineContainer.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const percentage = mouseX / rect.width;
      const previewTimeValue = percentage * duration;
      
      // Position preview
      timelinePreview.style.left = `${e.clientX}px`;
      timelinePreview.style.display = 'block';
      
      // Update preview time
      previewTime.textContent = formatTime(previewTimeValue);
      
      // Find closest thumbnail
      const thumbnail = findClosestThumbnail(previewTimeValue);
      if (thumbnail) {
        previewThumbnail.style.backgroundImage = `url(${thumbnail.dataUrl})`;
      }
    }

    function hideTimelinePreview() {
      timelinePreview.style.display = 'none';
    }

    // --- Thumbnail Generation ---
    function generateThumbnailIfNeeded() {
      if (currentTime - lastThumbnailTime >= thumbnailInterval) {
        generateThumbnail();
        lastThumbnailTime = currentTime;
      }
    }

    function generateThumbnail() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = 160;
      canvas.height = 90;
      
      try {
        ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
        
        thumbnails.push({
          time: currentTime,
          dataUrl: dataUrl
        });
        
        // Limit thumbnail count to prevent memory issues
        if (thumbnails.length > 100) {
          thumbnails.shift();
        }
        
        updateThumbnailTimeline();
        
      } catch (error) {
        console.warn('Could not generate thumbnail:', error);
      }
    }

    function updateThumbnailTimeline() {
      timelineThumbnails.innerHTML = '';
      
      if (thumbnails.length === 0 || duration === 0) return;
      
      thumbnails.forEach(thumbnail => {
        const thumbnailElement = document.createElement('div');
        thumbnailElement.className = 'timeline-thumbnail';
        thumbnailElement.style.backgroundImage = `url(${thumbnail.dataUrl})`;
        thumbnailElement.style.left = `${(thumbnail.time / duration) * 100}%`;
        thumbnailElement.style.width = `${thumbnailInterval / duration * 100}%`;
        timelineThumbnails.appendChild(thumbnailElement);
      });
    }

    function findClosestThumbnail(time) {
      if (thumbnails.length === 0) return null;
      
      let closest = thumbnails[0];
      let minDiff = Math.abs(time - closest.time);
      
      for (let i = 1; i < thumbnails.length; i++) {
        const diff = Math.abs(time - thumbnails[i].time);
        if (diff < minDiff) {
          minDiff = diff;
          closest = thumbnails[i];
        }
      }
      
      return closest;
    }

    // --- Utility Functions ---
    function formatTime(seconds) {
      if (isNaN(seconds)) return '00:00';
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      } else {
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
    }

    // --- Cleanup ---
    window.addEventListener('beforeunload', () => {
      if (socket) {
        socket.emit('viewer-left', { classId, viewerId });
      }
      
      if (hls) {
        hls.destroy();
      }
      
      if (streamCheckInterval) {
        clearTimeout(streamCheckInterval);
      }
    });

    // --- Initialize Application ---
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>