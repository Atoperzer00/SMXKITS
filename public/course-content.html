<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SMX KITS - Course Content</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      --secondary-gradient: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
      --accent-gradient: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
      --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
      --card-gradient: linear-gradient(145deg, #2d1810 0%, #1a0f08 100%);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: #b8c5d6;
      --text-accent: #ffa726;
      --shadow-primary: 0 20px 40px rgba(0, 0, 0, 0.3);
      --shadow-hover: 0 30px 60px rgba(0, 0, 0, 0.4);
      --border-radius: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark-gradient);
      color: var(--text-primary);
      overflow-x: hidden;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(255, 107, 53, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(247, 147, 30, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 140, 66, 0.1) 0%, transparent 50%);
      z-index: -1;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-20px) rotate(1deg); }
      66% { transform: translateY(10px) rotate(-1deg); }
    }

    /* Top Navigation Bar */
    .top-navbar {
      background: rgba(15, 20, 25, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .navbar-logo {
      height: 40px;
      filter: drop-shadow(0 5px 15px rgba(255, 107, 53, 0.3));
    }

    .navbar-title {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .navbar-nav {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .nav-link {
      color: var(--text-secondary);
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-link:hover {
      color: var(--text-primary);
      background: var(--glass-bg);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.5rem 1rem;
      background: var(--glass-bg);
      border-radius: 25px;
      border: 1px solid var(--glass-border);
    }

    .user-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1rem;
    }

    /* Main Content */
    .course-content {
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .course-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .course-title {
      font-size: 2.5rem;
      font-weight: 800;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .course-subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    /* Fullscreen Slideshow Container */
    .slideshow-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 2000;
      display: flex;
      flex-direction: column;
    }

    .slideshow-container.active {
      display: flex;
    }

    /* Course Preview */
    .course-preview {
      margin-bottom: 2rem;
    }

    .preview-card {
      background: var(--card-gradient);
      border-radius: var(--border-radius);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-primary);
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .preview-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    .preview-image {
      position: relative;
      height: 400px;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .preview-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .play-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background: var(--primary-gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      opacity: 0.9;
      transition: var(--transition);
    }

    .preview-card:hover .play-overlay {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.1);
    }

    .preview-info {
      padding: 1.5rem;
      text-align: center;
    }

    .preview-info h3 {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .preview-info p {
      color: var(--text-secondary);
    }

    /* Hover Controls */
    .slideshow-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 1rem 2rem;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      opacity: 0;
      transform: translateY(-100%);
      transition: all 0.3s ease;
      z-index: 10;
    }

    .export-notes-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .slideshow-container:hover .slideshow-header {
      opacity: 1;
      transform: translateY(0);
    }

    .module-selector {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
    }

    .module-select {
      background: rgba(255, 255, 255, 0.1);
      color: #000000;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .module-select option {
      background: #ffffff;
      color: #000000;
    }

    .module-select:focus {
      outline: none;
      border-color: var(--text-accent);
      box-shadow: 0 0 8px rgba(255, 167, 38, 0.3);
    }

    .slide-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .slide-viewer {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      position: relative;
    }

    .slide-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: var(--transition);
    }

    /* Streamlined Bottom Controls */
    .slide-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 0.75rem 1.5rem;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      opacity: 0;
      transform: translateY(100%);
      transition: all 0.3s ease;
      z-index: 10;
    }

    .slideshow-container:hover .slide-controls {
      opacity: 1;
      transform: translateY(0);
    }

    .slide-nav {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .slide-control-btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-weight: 500;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .slide-control-btn:hover:not(:disabled) {
      background: var(--primary-gradient);
      border-color: transparent;
      transform: translateY(-1px);
    }

    .slide-control-btn:disabled {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.3);
      cursor: not-allowed;
      transform: none;
    }

    .slide-counter {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .slide-tools {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .tool-btn {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-accent);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 0.5rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      font-size: 0.9rem;
    }

    .tool-btn:hover {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
      transform: translateY(-1px);
    }

    .tool-btn.active {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    /* Exit Fullscreen Button */
    .exit-fullscreen {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 0.5rem;
      cursor: pointer;
      transition: var(--transition);
      z-index: 15;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .exit-fullscreen:hover {
      background: rgba(255, 0, 0, 0.8);
    }

    /* Notes Panel - Hover Based */
    .notes-panel {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 800px;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(15px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 20;
      max-height: 60vh;
      overflow: hidden;
    }

    .notes-panel.expanded {
      opacity: 1;
      visibility: visible;
    }

    .notes-tabs {
      display: flex;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .notes-tab {
      flex: 1;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .notes-tab.active {
      background: var(--primary-gradient);
      color: white;
    }

    .notes-content {
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .instructor-notes {
      color: var(--text-secondary);
      line-height: 1.6;
      font-size: 0.95rem;
    }

    /* Student Notes Bubble */
    .student-notes-bubble {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 1rem;
      min-height: 120px;
      position: relative;
    }

    .student-notes-input {
      width: 100%;
      min-height: 100px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      resize: none;
      outline: none;
      line-height: 1.5;
    }

    .student-notes-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
      font-style: italic;
    }

    .student-notes-input:focus {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Auto-save indicator */
    .save-indicator {
      position: absolute;
      bottom: 0.5rem;
      right: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-accent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .save-indicator.show {
      opacity: 1;
    }

    /* General Module Notes */
    .module-notes-section {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-primary);
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .module-notes-header {
      padding: 1.5rem 2rem;
      background: var(--card-gradient);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .module-notes-header:hover {
      background: linear-gradient(145deg, #3d2818 0%, #2a1510 100%);
    }

    .module-notes-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-accent);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .module-notes-toggle {
      font-size: 1.2rem;
      color: var(--text-accent);
      transition: var(--transition);
    }

    .module-notes-content {
      padding: 0 2rem;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .module-notes-content.expanded {
      padding: 2rem;
      max-height: 500px;
    }

    .module-notes-input {
      width: 100%;
      min-height: 150px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 1rem;
      color: var(--text-primary);
      font-family: inherit;
      resize: vertical;
      transition: var(--transition);
    }

    .module-notes-input:focus {
      outline: none;
      border-color: var(--text-accent);
      box-shadow: 0 0 10px rgba(255, 167, 38, 0.3);
    }



    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent-gradient);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-gradient);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .top-navbar {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }
      
      .course-content {
        padding: 1rem;
      }
      
      .course-title {
        font-size: 2rem;
      }
      
      .slideshow-header {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
        padding: 0.75rem 1rem;
      }
      
      .slide-controls {
        flex-direction: column;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
      }

      .slide-nav {
        order: 2;
        gap: 0.75rem;
      }

      .slide-tools {
        order: 1;
      }

      .slide-control-btn {
        padding: 0.6rem 1.2rem;
        font-size: 0.8rem;
      }

      .tool-btn {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
      }

      .notes-panel {
        width: 95%;
        bottom: 60px;
      }

      .preview-image {
        height: 250px;
      }

      .play-overlay {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Check -->
  <script>
    // Immediate authentication check
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    
    if (!token || !role) {
      // No authentication found, redirect immediately
      window.location.replace('/login.html');
      // Stop execution to prevent content from loading
      throw new Error('Authentication required');
    }
    
    // We are authenticated, continue loading
    console.log('✅ Authentication verified - loading course content');
  </script>

  <!-- Top Navigation Bar -->
  <nav class="top-navbar">
    <div class="navbar-brand">
      <img src="SMXKITS.png" alt="SMXKITS Logo" class="navbar-logo" />
      <span class="navbar-title">Course Content</span>
    </div>
    <div class="navbar-nav">
      <a href="dashboard.html" class="nav-link">
        <i class="fas fa-tachometer-alt"></i>
        Dashboard
      </a>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">S</div>
        <span id="studentName">Student</span>
      </div>
      <a href="#" onclick="logout()" class="nav-link">
        <i class="fas fa-sign-out-alt"></i>
        Logout
      </a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="course-content">
    <!-- Course Header -->
    <div class="course-header">
      <h1 class="course-title" id="courseTitle">INTRODUCTION TO FMV</h1>
      <p class="course-subtitle">Interactive training modules with comprehensive content</p>
    </div>

    <!-- Slideshow Container -->
    <div class="slideshow-container" id="slideshowContainer">
      <!-- Exit Fullscreen Button -->
      <button class="exit-fullscreen" onclick="exitSlideshow()" title="Exit Slideshow">
        <i class="fas fa-times"></i>
      </button>

      <!-- Notes Panel (Hidden by default) -->
      <div class="notes-panel" id="notesPanel">
        <div class="notes-tabs">
          <button class="notes-tab active" onclick="switchNotesTab('instructor')">
            <i class="fas fa-chalkboard-teacher"></i>
            Instructor Notes
          </button>
          <button class="notes-tab" onclick="switchNotesTab('student')">
            <i class="fas fa-sticky-note"></i>
            My Notes
          </button>
          <button class="notes-tab" onclick="switchNotesTab('module')">
            <i class="fas fa-book"></i>
            Module Notes
          </button>
        </div>
        <div class="notes-content">
          <div id="instructorNotesContent" class="instructor-notes">
            <p>Instructor notes for this slide will appear here...</p>
          </div>
          <div id="studentNotesContent" class="student-notes-bubble" style="display: none;">
            <textarea 
              id="studentNotesInput" 
              class="student-notes-input" 
              placeholder="Student notes here..."
            ></textarea>
            <div class="save-indicator" id="saveIndicator">
              <i class="fas fa-check"></i> Saved
            </div>
          </div>
          <div id="moduleNotesContent" class="student-notes-bubble" style="display: none;">
            <textarea 
              id="moduleNotesInputSlideshow" 
              class="student-notes-input" 
              placeholder="Add your general notes for this module..."
            ></textarea>
            <div class="save-indicator" id="moduleSaveIndicator">
              <i class="fas fa-check"></i> Saved
            </div>
          </div>
        </div>
      </div>

      <!-- Slideshow Header -->
      <div class="slideshow-header">
        <div class="module-selector">
          <label for="moduleSelect">
            <i class="fas fa-layer-group"></i>
            Module:
          </label>
          <select id="moduleSelect" class="module-select">
            <option value="fmv">INTRODUCTION TO FMV</option>
            <option value="f3ead">F3EAD</option>
          </select>
        </div>
        <div class="slide-info">
          <i class="fas fa-images"></i>
          <span>Slide <span id="currentSlideNum">1</span> of <span id="totalSlides">20</span></span>
        </div>
        <div class="export-notes-section">
          <button class="tool-btn" onclick="exportAllStudentNotes()" title="Export All Student Notes">
            <i class="fas fa-download"></i>
          </button>
        </div>
      </div>

      <!-- Slide Viewer -->
      <div class="slide-viewer">
        <img id="currentSlide" class="slide-image" src="" alt="Current Slide" />
      </div>

      <!-- Slide Controls -->
      <div class="slide-controls">
        <div class="slide-nav">
          <button id="prevSlide" class="slide-control-btn">
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <button id="nextSlide" class="slide-control-btn">
            Next
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <div class="slide-counter">
          <i class="fas fa-presentation"></i>
          <span id="slideProgress">1 / 20</span>
        </div>

        <div class="slide-tools">
          <button class="tool-btn" id="notesBtn" onclick="toggleNotesPanel()" title="Toggle Notes">
            <i class="fas fa-sticky-note"></i>
          </button>
          <button class="tool-btn" onclick="toggleFullscreen()" title="Fullscreen">
            <i class="fas fa-expand"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Course Content Preview (when not in slideshow) -->
    <div class="course-preview" id="coursePreview" style="display: none;">
      <div class="preview-card" onclick="enterSlideshow()">
        <div class="preview-image">
          <img id="previewSlide" src="" alt="Course Preview" />
          <div class="play-overlay">
            <i class="fas fa-play"></i>
          </div>
        </div>
        <div class="preview-info">
          <h3 id="previewTitle">INTRODUCTION TO FMV</h3>
          <p>Click to start slideshow presentation</p>
        </div>
      </div>
    </div>

    <!-- General Module Notes -->
    <div class="module-notes-section" style="display: none;">
      <div class="module-notes-header" onclick="toggleModuleNotes()">
        <div class="module-notes-title">
          <i class="fas fa-book"></i>
          General Module Notes
        </div>
        <i class="fas fa-chevron-down module-notes-toggle" id="moduleNotesToggle"></i>
      </div>
      <div class="module-notes-content" id="moduleNotesContent">
        <textarea 
          id="moduleNotesInput" 
          class="module-notes-input" 
          placeholder="Add your general notes for this module..."
        ></textarea>
        <div class="notes-actions" style="margin-top: 1rem;">
          <button class="btn-save" onclick="saveModuleNotes()">
            <i class="fas fa-save"></i>
            Save Module Notes
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- JavaScript for Course Content -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Set student name and avatar if available
      const studentName = localStorage.getItem('studentName') || 'Student';
      document.getElementById('studentName').textContent = studentName;
      document.getElementById('userAvatar').textContent = studentName.charAt(0).toUpperCase();

      // Slide configuration for different modules
      const modules = {
        fmv: {
          title: 'INTRODUCTION TO FMV',
          slideCount: 20,
          basePath: 'INTRODUCTION TO FMV/',
          slides: [
            'SLIDE 1.jpg', 'SLIDE 2.jpg', 'SLIDE 3.jpg', 'SLIDE 4.jpg', 'SLIDE 5.jpg',
            'SLIDE 6.jpg', 'SLIDE 7.jpg', 'SLIDE 8.jpg', 'SLIDE 9.jpg', 'SLIDE 10.jpg',
            'SLIDE 11.jpg', 'SLIDE 12.jpg', 'SLIDE 13.jpg', 'SLIDE 14.jpg', 'SLIDE 15.jpg',
            'SLIDE 16.jpg', 'SLIDE 17.jpg', 'SLIDE 18.jpg', 'SLIDE 19.jpg', 'SLIDE 20.jpg'
          ],
          instructorNotes: {
            1: "Welcome to the Introduction to FMV course. This slide introduces the fundamental concepts of Full Motion Video analysis.",
            2: "Explain the importance of FMV in modern intelligence operations and surveillance.",
            3: "Discuss the technical specifications and requirements for FMV systems.",
            4: "Cover the basic principles of video compression and streaming.",
            5: "Introduce the different types of sensors used in FMV collection."
          }
        },
        f3ead: {
          title: 'F3EAD',
          slideCount: 37,
          basePath: 'F3EAD/F3EAD/',
          slides: [
            'SLIDE 1.jpg', 'SLIDE 2.jpg', 'SLIDE 3.jpg', 'SLIDE 4.jpg', 'SLIDE 5.jpg',
            'SLIDE 6.jpg', 'SLIDE 7.jpg', 'SLIDE 8.jpg', 'SLIDE 9.jpg', 'SLIDE 10.jpg',
            'SLIDE 11.jpg', 'SLIDE 12.jpg', 'SLIDE 13.jpg', 'SLIDE 14.jpg', 'SLIDE 15.jpg',
            'SLIDE 16.jpg', 'SLIDE 17.jpg', 'SLIDE 18.jpg', 'SLIDE 19.jpg', 'SLIDE 20.jpg',
            'SLIDE 21.jpg', 'SLIDE 22.jpg', 'SLIDE 23.jpg', 'SLIDE 24.jpg', 'SLIDE 25.jpg',
            'SLIDE 26.jpg', 'SLIDE 27.jpg', 'SLIDE 28.jpg', 'SLIDE 29.jpg', 'SLIDE 30.jpg',
            'SLIDE 31.jpg', 'SLIDE 32.jpg', 'SLIDE 33.jpg', 'SLIDE 34.jpg', 'SLIDE 35.jpg',
            'SLIDE 36.jpg', 'SLIDE 37.jpg'
          ],
          instructorNotes: {
            1: "Introduction to F3EAD - Find, Fix, Finish, Exploit, Analyze, Disseminate methodology.",
            2: "Explain the Find phase - locating targets and areas of interest.",
            3: "Detail the Fix phase - confirming target location and characteristics.",
            4: "Cover the Finish phase - executing the mission or operation.",
            5: "Discuss the Exploit phase - gathering intelligence from the operation."
          }
        }
      };

      // Current state
      let currentModule = 'fmv';
      let currentSlide = 1;
      let activeNotesTab = 'instructor';
      
      // DOM elements
      const currentSlideEl = document.getElementById('currentSlide');
      const previewSlideEl = document.getElementById('previewSlide');
      const currentSlideNumEl = document.getElementById('currentSlideNum');
      const totalSlidesEl = document.getElementById('totalSlides');
      const slideProgressEl = document.getElementById('slideProgress');
      const moduleSelectEl = document.getElementById('moduleSelect');
      const courseTitle = document.getElementById('courseTitle');
      const previewTitle = document.getElementById('previewTitle');
      const prevBtn = document.getElementById('prevSlide');
      const nextBtn = document.getElementById('nextSlide');
      const notesPanel = document.getElementById('notesPanel');
      const notesBtn = document.getElementById('notesBtn');
      const slideshowContainer = document.getElementById('slideshowContainer');
      const coursePreview = document.getElementById('coursePreview');
      const studentNotesInput = document.getElementById('studentNotesInput');
      const saveIndicator = document.getElementById('saveIndicator');
      
      // Initialize the viewer - Start directly in slideshow mode
      updateModuleInfo();
      updateSlideDisplay();
      updatePreview();
      loadStudentNotes();
      loadModuleNotes();
      
      // Start in slideshow mode immediately
      enterSlideshow();
      
      // Auto-save functionality for student notes
      let saveTimeout;
      studentNotesInput.addEventListener('input', function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          autoSaveStudentNotes();
        }, 1000); // Auto-save after 1 second of no typing
      });
      
      studentNotesInput.addEventListener('blur', function() {
        autoSaveStudentNotes();
      });

      // Auto-save functionality for module notes in slideshow
      const moduleNotesInputSlideshow = document.getElementById('moduleNotesInputSlideshow');
      let moduleSaveTimeout;
      moduleNotesInputSlideshow.addEventListener('input', function() {
        clearTimeout(moduleSaveTimeout);
        moduleSaveTimeout = setTimeout(() => {
          autoSaveModuleNotes();
        }, 1000); // Auto-save after 1 second of no typing
      });
      
      moduleNotesInputSlideshow.addEventListener('blur', function() {
        autoSaveModuleNotes();
      });
      
      // Event Listeners
      moduleSelectEl.addEventListener('change', function() {
        currentModule = this.value;
        currentSlide = 1;
        updateModuleInfo();
        updateSlideDisplay();
        updateCourseTitle();
        updatePreview();
        loadStudentNotes();
        loadModuleNotes();
      });
      
      prevBtn.addEventListener('click', function() {
        if (currentSlide > 1) {
          saveCurrentSlideNotes();
          currentSlide--;
          updateSlideDisplay();
          loadStudentNotes();
        }
      });
      
      nextBtn.addEventListener('click', function() {
        if (currentSlide < modules[currentModule].slideCount) {
          saveCurrentSlideNotes();
          currentSlide++;
          updateSlideDisplay();
          loadStudentNotes();
        }
      });
      
      // Key navigation
      document.addEventListener('keydown', function(e) {
        if (slideshowContainer.classList.contains('active')) {
          if (e.key === 'ArrowLeft' && currentSlide > 1) {
            prevBtn.click();
          } else if (e.key === 'ArrowRight' && currentSlide < modules[currentModule].slideCount) {
            nextBtn.click();
          } else if (e.key === 'Escape') {
            if (notesPanel.classList.contains('expanded')) {
              closeNotesPanel();
            } else {
              exitSlideshow();
            }
          }
        }
      });
      
      // Functions
      function updateModuleInfo() {
        const module = modules[currentModule];
        totalSlidesEl.textContent = module.slideCount;
        currentSlideNumEl.textContent = currentSlide;
        slideProgressEl.textContent = `${currentSlide} / ${module.slideCount}`;
      }

      function updateCourseTitle() {
        const module = modules[currentModule];
        courseTitle.textContent = module.title;
        previewTitle.textContent = module.title;
      }

      function updatePreview() {
        const module = modules[currentModule];
        const slideFileName = module.slides[0]; // Show first slide as preview
        const rawPath = `${module.basePath}${slideFileName}`;
        const encodedPath = rawPath.replace(/ /g, '%20');
        previewSlideEl.src = encodedPath;
      }
      
      function updateSlideDisplay() {
        const module = modules[currentModule];
        const slideFileName = module.slides[currentSlide - 1];
        
        // Build the path with proper encoding
        const rawPath = `${module.basePath}${slideFileName}`;
        
        // Try different encoding methods
        const paths = [
          rawPath.replace(/ /g, '%20'),  // Manual space encoding
          encodeURI(rawPath),            // Standard URI encoding
          rawPath                        // Raw path (browser might handle it)
        ];
        
        console.log('=== Slide Display Debug ===');
        console.log('Module:', currentModule);
        console.log('Slide:', currentSlide);
        console.log('Raw path:', rawPath);
        console.log('Trying paths:', paths);
        
        let pathIndex = 0;
        
        function tryNextPath() {
          if (pathIndex < paths.length) {
            const currentPath = paths[pathIndex];
            console.log(`Trying path ${pathIndex + 1}:`, currentPath);
            currentSlideEl.src = currentPath;
            pathIndex++;
          } else {
            console.error('❌ All paths failed for slide:', slideFileName);
            currentSlideEl.style.opacity = '1';
          }
        }
        
        currentSlideEl.onload = function() {
          this.style.opacity = '1';
          console.log('✅ Image loaded successfully:', this.src);
        };
        
        currentSlideEl.onerror = function() {
          console.log(`❌ Path failed: ${this.src}`);
          tryNextPath();
        };
        
        // Start with the first path
        currentSlideEl.style.opacity = '0.5';
        tryNextPath();
        
        // Update UI
        updateModuleInfo();
        prevBtn.disabled = currentSlide === 1;
        nextBtn.disabled = currentSlide === module.slideCount;
        
        // Update instructor notes
        updateInstructorNotes();
      }

      function updateInstructorNotes() {
        const module = modules[currentModule];
        const instructorNotesContent = document.getElementById('instructorNotesContent');
        const notes = module.instructorNotes && module.instructorNotes[currentSlide] 
          ? module.instructorNotes[currentSlide] 
          : 'No instructor notes available for this slide.';
        instructorNotesContent.innerHTML = `<p>${notes}</p>`;
      }

      function toggleNotesPanel() {
        const isExpanded = notesPanel.classList.contains('expanded');
        if (isExpanded) {
          closeNotesPanel();
        } else {
          openNotesPanel();
        }
      }

      function openNotesPanel() {
        notesPanel.classList.add('expanded');
        notesBtn.classList.add('active');
      }

      function closeNotesPanel() {
        notesPanel.classList.remove('expanded');
        notesBtn.classList.remove('active');
      }

      function switchNotesTab(tab) {
        activeNotesTab = tab;
        const tabs = document.querySelectorAll('.notes-tab');
        tabs.forEach(t => t.classList.remove('active'));
        
        // Hide all content areas
        document.getElementById('instructorNotesContent').style.display = 'none';
        document.getElementById('studentNotesContent').style.display = 'none';
        document.getElementById('moduleNotesContent').style.display = 'none';
        
        if (tab === 'instructor') {
          tabs[0].classList.add('active');
          document.getElementById('instructorNotesContent').style.display = 'block';
        } else if (tab === 'student') {
          tabs[1].classList.add('active');
          document.getElementById('studentNotesContent').style.display = 'block';
        } else if (tab === 'module') {
          tabs[2].classList.add('active');
          document.getElementById('moduleNotesContent').style.display = 'block';
          // Load module notes when switching to this tab
          loadModuleNotesInSlideshow();
        }
      }

      function saveStudentNotes() {
        const notes = document.getElementById('studentNotesInput').value;
        const key = `studentNotes_${currentModule}_slide_${currentSlide}`;
        localStorage.setItem(key, notes);
        
        // Show save confirmation
        const saveBtn = event.target;
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
        setTimeout(() => {
          saveBtn.innerHTML = originalText;
        }, 2000);
      }

      function loadStudentNotes() {
        const key = `studentNotes_${currentModule}_slide_${currentSlide}`;
        const notes = localStorage.getItem(key) || '';
        document.getElementById('studentNotesInput').value = notes;
      }

      function saveCurrentSlideNotes() {
        if (activeNotesTab === 'student') {
          const notes = document.getElementById('studentNotesInput').value;
          const key = `studentNotes_${currentModule}_slide_${currentSlide}`;
          localStorage.setItem(key, notes);
        }
      }

      function saveModuleNotes() {
        const notes = document.getElementById('moduleNotesInput').value;
        const key = `moduleNotes_${currentModule}`;
        localStorage.setItem(key, notes);
        
        // Show save confirmation
        const saveBtn = event.target;
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
        setTimeout(() => {
          saveBtn.innerHTML = originalText;
        }, 2000);
      }

      function loadModuleNotes() {
        const key = `moduleNotes_${currentModule}`;
        const notes = localStorage.getItem(key) || '';
        document.getElementById('moduleNotesInput').value = notes;
      }

      function loadModuleNotesInSlideshow() {
        const key = `moduleNotes_${currentModule}`;
        const notes = localStorage.getItem(key) || '';
        document.getElementById('moduleNotesInputSlideshow').value = notes;
      }

      function autoSaveModuleNotes() {
        const notes = document.getElementById('moduleNotesInputSlideshow').value;
        const key = `moduleNotes_${currentModule}`;
        localStorage.setItem(key, notes);
        
        // Also update the hidden module notes input
        document.getElementById('moduleNotesInput').value = notes;
        
        // Show save indicator
        const moduleSaveIndicator = document.getElementById('moduleSaveIndicator');
        moduleSaveIndicator.classList.add('show');
        setTimeout(() => {
          moduleSaveIndicator.classList.remove('show');
        }, 2000);
      }

      function enterSlideshow() {
        slideshowContainer.classList.add('active');
        coursePreview.style.display = 'none';
        document.body.style.overflow = 'hidden';
      }

      function exitSlideshow() {
        slideshowContainer.classList.remove('active');
        coursePreview.style.display = 'block';
        document.body.style.overflow = 'auto';
        closeNotesPanel();
      }

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      }

      function autoSaveStudentNotes() {
        const notes = studentNotesInput.value;
        const key = `studentNotes_${currentModule}_slide_${currentSlide}`;
        localStorage.setItem(key, notes);
        
        // Show save indicator
        saveIndicator.classList.add('show');
        setTimeout(() => {
          saveIndicator.classList.remove('show');
        }, 2000);
      }

      function exportAllStudentNotes() {
        let allNotes = '';
        const studentName = localStorage.getItem('studentName') || 'Student';
        const timestamp = new Date().toLocaleString();
        
        allNotes += `SMX KITS - Student Notes Export\n`;
        allNotes += `Student: ${studentName}\n`;
        allNotes += `Export Date: ${timestamp}\n`;
        allNotes += `${'='.repeat(50)}\n\n`;
        
        // Export notes from all modules
        Object.keys(modules).forEach(moduleKey => {
          const module = modules[moduleKey];
          let moduleHasNotes = false;
          let moduleNotes = '';
          
          // Check for general module notes
          const moduleNotesKey = `moduleNotes_${moduleKey}`;
          const generalNotes = localStorage.getItem(moduleNotesKey);
          if (generalNotes && generalNotes.trim()) {
            moduleNotes += `\nGENERAL MODULE NOTES:\n${'-'.repeat(25)}\n${generalNotes}\n\n`;
            moduleHasNotes = true;
          }
          
          // Check for slide-specific notes
          for (let slideNum = 1; slideNum <= module.slideCount; slideNum++) {
            const slideNotesKey = `studentNotes_${moduleKey}_slide_${slideNum}`;
            const slideNotes = localStorage.getItem(slideNotesKey);
            if (slideNotes && slideNotes.trim()) {
              moduleNotes += `SLIDE ${slideNum} NOTES:\n${'-'.repeat(15)}\n${slideNotes}\n\n`;
              moduleHasNotes = true;
            }
          }
          
          // Add module section if it has notes
          if (moduleHasNotes) {
            allNotes += `MODULE: ${module.title}\n`;
            allNotes += `${'='.repeat(module.title.length + 8)}\n`;
            allNotes += moduleNotes;
            allNotes += `\n${'*'.repeat(60)}\n\n`;
          }
        });
        
        if (allNotes.split('\n').length <= 6) {
          allNotes += 'No student notes found to export.\n';
        }
        
        // Create and download the file
        const blob = new Blob([allNotes], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SMX_KITS_Student_Notes_${studentName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Show confirmation
        const exportBtn = event.target.closest('.tool-btn');
        const originalHTML = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="fas fa-check"></i>';
        exportBtn.style.background = 'var(--primary-gradient)';
        exportBtn.style.color = 'white';
        
        setTimeout(() => {
          exportBtn.innerHTML = originalHTML;
          exportBtn.style.background = '';
          exportBtn.style.color = '';
        }, 2000);
      }

      // Make functions globally available
      window.switchNotesTab = switchNotesTab;
      window.saveStudentNotes = saveStudentNotes;
      window.saveModuleNotes = saveModuleNotes;
      window.toggleNotesPanel = toggleNotesPanel;
      window.toggleFullscreen = toggleFullscreen;
      window.enterSlideshow = enterSlideshow;
      window.exitSlideshow = exitSlideshow;
      window.exportAllStudentNotes = exportAllStudentNotes;
    });

    // Module Notes Toggle
    function toggleModuleNotes() {
      const moduleNotesContent = document.getElementById('moduleNotesContent');
      const moduleNotesToggle = document.getElementById('moduleNotesToggle');
      
      if (moduleNotesContent.classList.contains('expanded')) {
        moduleNotesContent.classList.remove('expanded');
        moduleNotesToggle.style.transform = 'rotate(0deg)';
      } else {
        moduleNotesContent.classList.add('expanded');
        moduleNotesToggle.style.transform = 'rotate(180deg)';
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('studentName');
      window.location.replace('/login.html');
    }
  </script>
</body>
</html>