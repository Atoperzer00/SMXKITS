<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Student – SMX KITS</title>
  <style>
    body {
      background-color: #121820;
      color: #e0e6ed;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 40px;
    }
    h2 {
      color: #70b8ff;
      font-size: 28px;
      margin-bottom: 20px;
    }
    a {
      color: #70b8ff;
      text-decoration: none;
      transition: color 0.3s;
    }
    a:hover {
      color: #ffffff;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      max-width: 400px;
      padding: 12px 14px;
      margin-top: 8px;
      background-color: #1e2a35;
      border: 1px solid #2e3c4d;
      border-radius: 8px;
      color: #e0e6ed;
      font-size: 15px;
      transition: border 0.3s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #70b8ff;
    }
    button {
      margin-top: 30px;
      padding: 12px 28px;
      background-color: #1da1f2;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0d8ddb;
    }
    #studentResult {
      margin-top: 32px;
      white-space: pre-wrap;
      background-color: #1e2a35;
      padding: 18px;
      border-radius: 10px;
      border: 1px solid #2e3c4d;
      font-family: monospace;
      max-width: 800px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
  </style>
</head>
<body>
  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    if (!token || !role) {
      window.location.replace('/login.html');
    } else if (role !== 'admin' && role !== 'instructor') {
      alert('Access denied. Admin or Instructor privileges required.');
      window.location.replace('/dashboard.html');
    }
  </script>
  <div class="header">
    <h2>Add Student</h2>
    <a href="admin-dashboard.html">← Back to Dashboard</a>
  </div>
  <form id="studentForm" onsubmit="addStudent(event)">
    <label>Name <input required id="studentName" /></label>
    <label>Email <input required type="email" id="studentEmail" /></label>
    <label>Username <input required id="studentUsername" /></label>
    <label>Password <input required type="password" id="studentPassword" /></label>
    <label>Assign to Class
      <select id="studentClass"></select>
    </label>
    <button type="submit">Add Student</button>
  </form>
  <div id="studentResult"></div>
  <script>
    const classes = [
      { classId: 'CLS-20240607-001', name: 'Alpha 1' },
      { classId: 'CLS-20240608-002', name: 'Bravo 2' }
    ];
    function fillClassDropdown() {
      document.getElementById('studentClass').innerHTML =
        classes.map(c => `<option value="${c.classId}">${c.name}</option>`).join('');
    }
    fillClassDropdown();
    async function addStudent(e) {
      e.preventDefault();
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Authentication token missing. Please log in again.');
          window.location.href = '/login.html';
          return;
        }
        
        // Prepare student data
        const studentData = {
          name: document.getElementById('studentName').value,
          email: document.getElementById('studentEmail').value,
          username: document.getElementById('studentUsername').value,
          password: document.getElementById('studentPassword').value,
          classId: document.getElementById('studentClass').value,
          role: 'student'
        };
        
        // Send to backend API
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(studentData)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to add student');
        }
        
        const result = await response.json();
        
        // Display success
        document.getElementById('studentResult').innerText = 'Student Added Successfully:\n' + 
          JSON.stringify({
            name: studentData.name,
            email: studentData.email,
            username: studentData.username,
            classId: studentData.classId,
            role: 'student'
          }, null, 2);
          
        // Reset form
        document.getElementById('studentForm').reset();
        fillClassDropdown();
        
      } catch (error) {
        document.getElementById('studentResult').innerText = `Error: ${error.message}`;
        console.error('Failed to add student:', error);
      }
    }
  </script>
</body>
</html>