<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tile Fix Test</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css">
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 500px; border: 2px solid #333; }
        #debug { margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .log { margin: 5px 0; padding: 5px; background: white; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <h1>üîß Tile Loading Fix Test</h1>
    <p>Testing the fixed Altis map configuration to ensure tiles load correctly.</p>
    
    <div id="map"></div>
    
    <div id="debug">
        <h3>Debug Information:</h3>
        <div id="debugLog"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="altis.js"></script>
    
    <script>
        let map;
        let tileLoadCount = 0;
        let tileErrorCount = 0;
        
        function log(message, type = 'info') {
            console.log(message);
            const debugLog = document.getElementById('debugLog');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = new Date().toLocaleTimeString() + ': ' + message;
            debugLog.appendChild(logDiv);
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        function testTileLoading() {
            log('üöÄ Starting tile loading test...', 'info');
            
            // Check if Altis config is loaded
            if (typeof Arma3Map === 'undefined' || !Arma3Map.Maps.altis) {
                log('‚ùå Arma3Map.Maps.altis not available!', 'error');
                return;
            }
            
            const config = Arma3Map.Maps.altis;
            log('‚úÖ Altis config loaded successfully', 'success');
            log(`üìä Config: minZoom=${config.minZoom}, maxZoom=${config.maxZoom}, center=[${config.center}]`, 'info');
            log(`üó∫Ô∏è Bounds: [[${config.bounds[0]}], [${config.bounds[1]}]]`, 'info');
            log(`üéØ Tile pattern: ${config.tilePattern}`, 'info');
            
            // Create map
            try {
                map = L.map('map', {
                    crs: config.CRS,
                    minZoom: config.minZoom,
                    maxZoom: config.maxZoom,
                    maxBounds: config.bounds,
                    maxBoundsViscosity: 1.0
                }).setView(config.center, config.defaultZoom);
                
                log('‚úÖ Map created successfully', 'success');
                
                // Create custom tile layer with error tracking
                const tileLayer = L.tileLayer(config.tilePattern, {
                    attribution: config.attribution,
                    tileSize: config.tileSize,
                    bounds: config.bounds
                });
                
                // Track tile loading events
                tileLayer.on('tileload', function(e) {
                    tileLoadCount++;
                    const coords = e.coords;
                    log(`‚úÖ Tile loaded: ${coords.z}/${coords.x}/${coords.y}`, 'success');
                });
                
                tileLayer.on('tileerror', function(e) {
                    tileErrorCount++;
                    const coords = e.coords;
                    log(`‚ùå Tile error: ${coords.z}/${coords.x}/${coords.y} - ${e.error}`, 'error');
                });
                
                tileLayer.on('loading', function() {
                    log('üîÑ Starting to load tiles...', 'info');
                });
                
                tileLayer.on('load', function() {
                    log(`üéâ Tile loading complete! Loaded: ${tileLoadCount}, Errors: ${tileErrorCount}`, 
                        tileErrorCount === 0 ? 'success' : 'error');
                });
                
                tileLayer.addTo(map);
                
                // Add city markers if available
                if (config.cities) {
                    config.cities.forEach(city => {
                        L.marker([city.y, city.x])
                            .addTo(map)
                            .bindPopup(`<b>${city.name}</b><br>Coords: [${city.x}, ${city.y}]`);
                    });
                    log(`üèôÔ∏è Added ${config.cities.length} city markers`, 'success');
                }
                
                // Add map bounds visualization
                const boundsRect = L.rectangle(config.bounds, {
                    color: '#ff0000',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.1,
                    dashArray: '5, 5'
                }).addTo(map);
                boundsRect.bindPopup('Map Bounds');
                
                log('üî≤ Map bounds visualization added', 'info');
                
            } catch (error) {
                log(`‚ùå Error creating map: ${error.message}`, 'error');
            }
        }
        
        // Test direct tile access
        function testDirectTileAccess() {
            const testTiles = [
                'altis/0/0/0.png',
                'altis/1/0/0.png',
                'altis/2/1/1.png',
                'altis/6/32/32.png',
                'altis/6/0/0.png',
                'altis/6/63/63.png'
            ];
            
            log('üîç Testing direct tile access...', 'info');
            
            testTiles.forEach(tilePath => {
                const img = new Image();
                img.onload = function() {
                    log(`‚úÖ Direct access OK: ${tilePath}`, 'success');
                };
                img.onerror = function() {
                    log(`‚ùå Direct access FAILED: ${tilePath}`, 'error');
                };
                img.src = tilePath;
            });
        }
        
        // Initialize when page loads
        $(document).ready(function() {
            log('üìÑ Page loaded, starting tests...', 'info');
            testDirectTileAccess();
            setTimeout(testTileLoading, 1000);
        });
    </script>
</body>
</html>