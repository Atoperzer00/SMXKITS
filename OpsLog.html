<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Target Log Generator (Advanced)</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #fff;
    }
    .container { display: flex; height: 100vh; }
    .sidebar {
      width: 370px;
      background: #232323;
      padding: 24px 18px 18px 18px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      border-right: 1.5px solid #333;
    }
    .quick-btns { display: flex; gap: 8px; margin-bottom: 18px; }
    .quick-btn {
      flex: 1;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 0;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .quick-btn:hover { background: #444; }
    .sidebar label { margin: 0 0 7px 0; font-size: 14px; display: flex; align-items: center; }
    .sidebar .lock-icon {
      margin-left: auto;
      cursor: pointer;
      font-size: 16px;
      color: #aaa;
      transition: color 0.2s;
    }
    .sidebar .locked { color: orange; }
    input, select, textarea {
      width: 100%;
      padding: 7px 7px 7px 11px;
      margin: 3px 0 12px 0;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 15px;
    }
    textarea { min-height: 32px; resize: vertical; overflow: hidden; }
    .submit-btn { width: 100%; padding: 10px; background: #22c55e; border: none; color: #fff; font-weight: bold; border-radius: 4px; cursor: pointer; margin-top: 6px;}
    .form-section { margin-bottom: 14px; }
    .log-panel { flex: 1; padding: 30px; overflow-y: auto; background: #141414; display: flex; flex-direction: column; gap: 16px;}
    .bubble {
      background: #191919;
      color: #fff;
      padding: 17px 18px 17px 16px;
      border-radius: 10px;
      max-width: 87%;
      position: relative;
      border-left: 6px solid orange;
      transition: border-color 0.3s;
      cursor: grab;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 2px 8px #0007;
    }
    .bubble-menu {
      position: absolute;
      top: 12px; right: 15px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 2;
    }
    .menu-btn, .history-btn {
      background: #222;
      border-radius: 6px;
      width: 28px; height: 28px;
      display: flex;
      align-items: center; justify-content: center;
      cursor: pointer;
      border: 1.5px solid #444;
      transition: background 0.18s, border 0.18s;
    }
    .menu-btn:hover, .history-btn:hover { background: #333; border: 1.5px solid #f80;}
    .bubble .qc-orange { border-left-color: orange; }
    .bubble .qc-yellow { border-left-color: yellow; }
    .bubble .qc-green { border-left-color: limegreen; }
    .bubble .qc-red { border-left-color: red; }
    .sidebar.drag-over { outline: 2px dashed #22c55e; background: #232a23; }
    /* Overlay styling */
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(20,20,20,0.94);
      display: flex;
      align-items: center; justify-content: center;
      z-index: 10;
    }
    .overlay-content {
      background: #232323;
      border-radius: 14px;
      padding: 28px 32px;
      min-width: 420px;
      min-height: 300px;
      box-shadow: 0 10px 32px #000b;
      display: flex; flex-direction: column; gap: 20px;
      position: relative;
    }
    .close-overlay {
      position: absolute; top: 13px; right: 15px;
      background: transparent; border: none; color: #fff; font-size: 20px; cursor: pointer;
      transition: color 0.2s;
    }
    .close-overlay:hover { color: #ff9900;}
    .update-btn {
      margin-top: 12px;
      padding: 10px 0;
      width: 100%;
      background: orange;
      border: none;
      color: #222;
      font-weight: bold;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    /* History overlay */
    .history-columns { display: flex; gap: 36px;}
    .history-column { flex: 1; }
    .history-column h4 { margin-top: 0; }
    /* Custom MGRS style */
    input.mgrs-input[readonly] { background: #252525; color: #aaa; cursor: not-allowed; }
  </style>
</head>
<body>
<div class="container">
  <aside class="sidebar" id="sidebar">
    <div class="quick-btns">
      <button class="quick-btn" id="onTargetBtn">On Target</button>
      <button class="quick-btn" id="rtbBtn">RTB</button>
    </div>
    <form id="logForm">
      <div class="form-section">
        <label>Classification
          <span class="lock-icon" data-input="classification">ðŸ”’</span>
          <select name="classification" disabled>
            <option>No Classification</option>
          </select>
        </label>
        <label>Asset Name
          <span class="lock-icon" data-input="asset">ðŸ”’</span>
          <input type="text" name="asset" autocomplete="off"/>
        </label>
        <label>Sensor
          <span class="lock-icon" data-input="sensor">ðŸ”’</span>
          <select name="sensor">
            <option>FMV</option>
          </select>
        </label>
        <label>Operation Name
          <span class="lock-icon" data-input="operation">ðŸ”’</span>
          <input type="text" name="operation" value="OBJ"/>
        </label>
        <label>Team Name
          <span class="lock-icon" data-input="team">ðŸ”’</span>
          <input type="text" name="team"/>
        </label>
        <label>Zulu Time
          <span class="lock-icon" data-input="zulu">ðŸ”’</span>
          <input type="time" name="zulu"/>
        </label>
        <label>MGRS
          <span class="lock-icon" data-input="mgrs">ðŸ”’</span>
          <input type="text" class="mgrs-input" name="mgrs" pattern="\d{3} \d{2} \d{5} \d{5}" readonly/>
        </label>
        <label>Location Description
          <span class="lock-icon" data-input="location">ðŸ”’</span>
          <input type="text" name="location"/>
        </label>
        <label>Target Description
          <span class="lock-icon" data-input="target">ðŸ”’</span>
          <input type="text" name="target"/>
        </label>
      </div>
      <div class="form-section" id="followSection">
        <button type="button" id="createFollowBtn" class="quick-btn" style="background:#222;margin-bottom:8px;">Create Follow</button>
        <!-- Follow steps will be injected here -->
      </div>
      <div class="form-section">
        <label>Activity
          <span class="lock-icon" data-input="activity">ðŸ”’</span>
          <input type="text" name="activity"/>
        </label>
        <label>Males
          <span class="lock-icon" data-input="males">ðŸ”’</span>
          <input type="number" name="males" min="0"/>
        </label>
        <label>Females
          <span class="lock-icon" data-input="females">ðŸ”’</span>
          <input type="number" name="females" min="0"/>
        </label>
        <label>Children
          <span class="lock-icon" data-input="children">ðŸ”’</span>
          <input type="number" name="children" min="0"/>
        </label>
        <label>Vehicles
          <span class="lock-icon" data-input="vehicles">ðŸ”’</span>
          <input type="number" name="vehicles" min="0"/>
        </label>
        <label>IA Notes
          <span class="lock-icon" data-input="iaNotes">ðŸ”’</span>
          <textarea name="iaNotes" rows="3"></textarea>
        </label>
      </div>
      <button type="submit" class="submit-btn">Submit</button>
    </form>
  </aside>
  <main class="log-panel" id="logPanel"></main>
</div>

<!-- Overlays for edit/history -->
<div class="overlay" id="editOverlay" style="display:none;">
  <div class="overlay-content" id="editOverlayContent">
    <button class="close-overlay" id="closeEditOverlay">&times;</button>
    <form id="editForm"></form>
    <button class="update-btn" id="updateBtn">Update</button>
  </div>
</div>
<div class="overlay" id="historyOverlay" style="display:none;">
  <div class="overlay-content" id="historyOverlayContent">
    <button class="close-overlay" id="closeHistoryOverlay">&times;</button>
    <div class="history-columns">
      <div class="history-column">
        <h4>Original</h4>
        <div id="originalLog"></div>
      </div>
      <div class="history-column">
        <h4>Changes</h4>
        <div id="changesLog"></div>
      </div>
    </div>
  </div>
</div>

<script>
const form = document.getElementById('logForm');
const logPanel = document.getElementById('logPanel');
const sidebar = document.getElementById('sidebar');
const mgrsInput = form.elements.namedItem('mgrs');
const lockIcons = sidebar.querySelectorAll('.lock-icon');
const editOverlay = document.getElementById('editOverlay');
const editOverlayContent = document.getElementById('editOverlayContent');
const editForm = document.getElementById('editForm');
const updateBtn = document.getElementById('updateBtn');
const closeEditOverlay = document.getElementById('closeEditOverlay');
const historyOverlay = document.getElementById('historyOverlay');
const closeHistoryOverlay = document.getElementById('closeHistoryOverlay');
const createFollowBtn = document.getElementById('createFollowBtn');
const followSection = document.getElementById('followSection');
const onTargetBtn = document.getElementById('onTargetBtn');
const rtbBtn = document.getElementById('rtbBtn');

let followSteps = [];
let logs = []; // to store history for each log

// --- Lock individual inputs ---
lockIcons.forEach(icon => {
  const field = form.elements.namedItem(icon.dataset.input);
  icon.addEventListener('click', () => {
    if (field.hasAttribute('readonly') || field.hasAttribute('disabled')) {
      field.removeAttribute('readonly');
      field.removeAttribute('disabled');
      icon.classList.remove('locked');
    } else {
      if (field.tagName === "SELECT") field.setAttribute('disabled', true);
      else field.setAttribute('readonly', true);
      icon.classList.add('locked');
    }
  });
});

// --- MGRS Input Mask (3 2 5 5) -- Only allows numbers, spaces autofill ---
mgrsInput.removeAttribute('readonly');
mgrsInput.addEventListener('input', (e) => {
  let val = e.target.value.replace(/\D/g, '');
  let out = '';
  if (val.length > 0) out += val.slice(0,3);
  if (val.length > 3) out += ' ' + val.slice(3,5);
  if (val.length > 5) out += ' ' + val.slice(5,10);
  if (val.length > 10) out += ' ' + val.slice(10,15);
  e.target.value = out.trim().slice(0,18);
});
mgrsInput.setAttribute('readonly', true); // default readonly, unlock to edit

// --- Auto-expand textareas ---
sidebar.querySelectorAll('textarea').forEach(ta => {
  ta.addEventListener('input', function() {
    this.style.height = "auto";
    this.style.height = (this.scrollHeight+2) + "px";
  });
});

// --- Create Follow Dynamic Section ---
createFollowBtn.addEventListener('click', () => {
  const newStep = document.createElement('div');
  newStep.style.display = "flex";
  newStep.style.gap = "10px";
  newStep.style.marginBottom = "6px";
  newStep.innerHTML = `
    <input type="text" class="follow-name" placeholder="Follow Name" style="flex:1;min-width:0;">
    <select class="follow-stage" style="width:85px;">
      ${["START"].concat(Array.from({length:15},(_,i)=>`STOP ${i+1}`)).concat("END").map(v=>`<option>${v}</option>`).join('')}
    </select>
    <input type="text" class="follow-narrative" placeholder="Narrative..." style="flex:2;min-width:0;">
    <button type="button" class="quick-btn next-stop-btn" style="width:48px;">Next</button>
    <button type="button" class="quick-btn end-follow-btn" style="width:54px;">End</button>
  `;
  // Handlers for follow step
  newStep.querySelector('.next-stop-btn').onclick = () => {
    createFollowBtn.click(); // Add new follow step
  }
  newStep.querySelector('.end-follow-btn').onclick = () => {
    followSection.removeChild(newStep);
  }
  followSection.insertBefore(newStep, createFollowBtn.nextSibling);
});

// --- Quick On Target / RTB ---
onTargetBtn.addEventListener('click', () => {
  form.elements['activity'].value = "On Target";
});
rtbBtn.addEventListener('click', () => {
  form.elements['activity'].value = "RTB";
});

// --- LOG OUTPUT ---
form.addEventListener('submit', (e) => {
  e.preventDefault();

  const data = new FormData(form);

  // collect follow steps
  let follows = [];
  followSection.querySelectorAll('div').forEach(div => {
    const name = div.querySelector('.follow-name')?.value;
    const stage = div.querySelector('.follow-stage')?.value;
    const narrative = div.querySelector('.follow-narrative')?.value;
    if (name || stage || narrative) follows.push({ name, stage, narrative });
  });

  // payload for saving
  const payload = {
    classification: data.get('classification'),
    asset: data.get('asset'),
    sensor: data.get('sensor'),
    operation: data.get('operation'),
    team: data.get('team'),
    zulu: data.get('zulu'),
    mgrs: data.get('mgrs'),
    location: data.get('location'),
    target: data.get('target'),
    follows,
    activity: data.get('activity'),
    males: data.get('males'),
    females: data.get('females'),
    children: data.get('children'),
    vehicles: data.get('vehicles'),
    iaNotes: data.get('iaNotes'),
    history: []
  };

  // --- OUTPUT FORMATTING ---
  const bubble = document.createElement('div');
  bubble.className = 'bubble qc-orange';

  // bubble menu
  const bubbleMenu = document.createElement('div');
  bubbleMenu.className = 'bubble-menu';
  // Hamburger for edit
  const menuBtn = document.createElement('div');
  menuBtn.className = 'menu-btn';
  menuBtn.innerHTML = '<svg width="18" height="18"><rect y="2" width="18" height="3" fill="#fff"/><rect y="8" width="18" height="3" fill="#fff"/><rect y="14" width="18" height="3" fill="#fff"/></svg>';
  // Log history
  const historyBtn = document.createElement('div');
  historyBtn.className = 'history-btn';
  historyBtn.innerHTML = '<svg width="18" height="18"><rect x="2" y="2" width="14" height="3" fill="#ff8c1a"/><rect x="2" y="8" width="14" height="3" fill="#ff8c1a"/><rect x="2" y="14" width="14" height="3" fill="#ff8c1a"/></svg>';
  bubbleMenu.appendChild(menuBtn);
  bubbleMenu.appendChild(historyBtn);
  bubble.appendChild(bubbleMenu);

  // Condensed short fields
  let shortFields = `
    <b>${payload.asset}</b> | <b>${payload.sensor}</b> | <b>Op:</b> ${payload.operation} | <b>Team:</b> ${payload.team} | <b>Time:</b> ${payload.zulu} <br>
    <b>MGRS:</b> ${payload.mgrs} | <b>Loc:</b> ${payload.location} | <b>Target:</b> ${payload.target}
  `;
  // Follow section
  let followStr = '';
  if (payload.follows.length) {
    followStr += `<b>FOLLOWS:</b> `;
    followStr += payload.follows.map(f =>
      `<span style="display:inline-block;margin-right:8px;"><b>${f.name}</b> (${f.stage}) - ${f.narrative}</span>`
    ).join('');
    followStr += '<br>';
  }
  // SLANT/Vehicle
  let slantStr = `<b>SLANT:</b> ${payload.males||0}/${payload.females||0}/${payload.children||0}`;
  if (payload.vehicles) slantStr += ` <span style="margin-left:16px;"><b>V:</b> ${payload.vehicles}</span>`;
  // Main output
  bubble.innerHTML += `
    ${shortFields}<br>
    ${followStr}
    <b>Activity:</b> ${payload.activity}<br>
    ${slantStr}<br>
    <b>IA Notes:</b> ${payload.iaNotes}
  `;

  // QC state rotation
  const qcStates = ['qc-orange', 'qc-yellow', 'qc-green', 'qc-red'];
  let currentIndex = 0;
  bubble.addEventListener('click', (ev) => {
    if (ev.target.closest('.menu-btn,.history-btn')) return; // don't rotate QC if menu/hist clicked
    bubble.classList.remove(qcStates[currentIndex]);
    currentIndex = (currentIndex + 1) % qcStates.length;
    bubble.classList.add(qcStates[currentIndex]);
  });

  // Drag functionality (same as before)
  bubble.setAttribute('draggable','true');
  bubble.addEventListener('dragstart', (e) => {
    e.dataTransfer.setData('bubble', JSON.stringify(payload));
  });

  // Store log for editing/history
  payload.history.push(JSON.parse(JSON.stringify(payload))); // first version
  logs.push(payload);

  // --- EDIT MENU ---
  menuBtn.addEventListener('click', () => {
    showEditOverlay(payload, bubble);
  });

  // --- LOG HISTORY ---
  historyBtn.addEventListener('click', () => {
    showHistoryOverlay(payload);
  });

  logPanel.prepend(bubble);
  form.reset();
  followSection.querySelectorAll('div').forEach(d => d.remove());
});

// --- Sidebar drag/drop for autofill ---
sidebar.addEventListener('dragover', (e) => {
  e.preventDefault();
  sidebar.classList.add('drag-over');
});
sidebar.addEventListener('dragleave', () => {
  sidebar.classList.remove('drag-over');
});
sidebar.addEventListener('drop', (e) => {
  e.preventDefault();
  sidebar.classList.remove('drag-over');
  const payload = JSON.parse(e.dataTransfer.getData('bubble'));
  for (let key in payload) {
    const input = form.elements.namedItem(key);
    if (input) input.value = payload[key];
  }
});

// --- EDIT OVERLAY FUNCTIONS ---
function showEditOverlay(payload, bubbleEl) {
  editOverlay.style.display = 'flex';
  editForm.innerHTML = `
    <label>Asset: <input type="text" name="asset" value="${payload.asset||''}"/></label>
    <label>Sensor: <input type="text" name="sensor" value="${payload.sensor||''}"/></label>
    <label>Operation: <input type="text" name="operation" value="${payload.operation||''}"/></label>
    <label>Team: <input type="text" name="team" value="${payload.team||''}"/></label>
    <label>Zulu: <input type="time" name="zulu" value="${payload.zulu||''}"/></label>
    <label>MGRS: <input type="text" name="mgrs" value="${payload.mgrs||''}"/></label>
    <label>Location: <input type="text" name="location" value="${payload.location||''}"/></label>
    <label>Target: <input type="text" name="target" value="${payload.target||''}"/></label>
    <label>Activity: <input type="text" name="activity" value="${payload.activity||''}"/></label>
    <label>Males: <input type="number" name="males" value="${payload.males||0}"/></label>
    <label>Females: <input type="number" name="females" value="${payload.females||0}"/></label>
    <label>Children: <input type="number" name="children" value="${payload.children||0}"/></label>
    <label>Vehicles: <input type="number" name="vehicles" value="${payload.vehicles||0}"/></label>
    <label>IA Notes: <textarea name="iaNotes" rows="3">${payload.iaNotes||''}</textarea></label>
  `;
  closeEditOverlay.onclick = () => editOverlay.style.display = 'none';

  updateBtn.onclick = () => {
    const newData = new FormData(editForm);
    // push old to history
    payload.history.push(JSON.parse(JSON.stringify(payload)));
    for (let [k,v] of newData.entries()) payload[k] = v;
    // update output
    let updated = `
      <div class="bubble-menu">${editOverlayContent.querySelector('.bubble-menu')?.outerHTML||''}</div>
      <b>${payload.asset}</b> | <b>${payload.sensor}</b> | <b>Op:</b> ${payload.operation} | <b>Team:</b> ${payload.team} | <b>Time:</b> ${payload.zulu} <br>
      <b>MGRS:</b> ${payload.mgrs} | <b>Loc:</b> ${payload.location} | <b>Target:</b> ${payload.target}<br>
      <b>Activity:</b> ${payload.activity}<br>
      <b>SLANT:</b> ${payload.males||0}/${payload.females||0}/${payload.children||0} <span style="margin-left:16px;"><b>V:</b> ${payload.vehicles||0}</span><br>
      <b>IA Notes:</b> ${payload.iaNotes}
    `;
    bubbleEl.innerHTML = updated;
    editOverlay.style.display = 'none';
  };
}

// --- HISTORY OVERLAY ---
function showHistoryOverlay(payload) {
  historyOverlay.style.display = 'flex';
  const orig = payload.history[0];
  const last = payload.history[payload.history.length-1];
  document.getElementById('originalLog').innerText = JSON.stringify(orig,null,2);
  document.getElementById('changesLog').innerText = JSON.stringify(last,null,2);
  closeHistoryOverlay.onclick = () => historyOverlay.style.display = 'none';
}

</script>
</body>
</html>
